name: Publish Python ðŸ distributions ðŸ“¦ to PyPI

on:
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest
    environment: release
    permissions:
        contents: write
        id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install Task
        uses: arduino/setup-task@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print versions
        run: |
          python --version
          uv --version
          task --version

      # 1. Install dependencies
      - name: Install dependencies
        run: task install:release

      # 2. Build package
      - name: Build package
        run: task build

      # 3. Publish to PyPI
      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      # 4. Generate SBOM from runtime environment
      - name: Generate SBOM
        run: |
          CYCLONEDX_VERSION=$(uv tool run --from cyclonedx-bom cyclonedx-bom --version | head -n1)
          echo "Generating SBOM using $CYCLONEDX_VERSION"
          uv tool run --from cyclonedx-bom cyclonedx-bom environment \
            --output-format=json \
            --output-file=chemotools-${{ github.event.release.tag_name }}-sbom.json
          echo "cyclonedx-bom-version=$CYCLONEDX_VERSION" >> $GITHUB_OUTPUT
        id: sbom

      # 5. Upload SBOM as release asset
      - name: Upload SBOM to release
        uses: softprops/action-gh-release@v1
        with:
          files: chemotools-${{ github.event.release.tag_name }}-sbom.json
          append_body: true
          body: |
            
            ---
            **SBOM Information:**
            - File: `chemotools-${{ github.event.release.tag_name }}-sbom.json`
            - Generated with: `${{ steps.sbom.outputs.cyclonedx-bom-version }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}