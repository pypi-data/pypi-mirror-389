name: Publish prefect-mcp to PyPI
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  pypi-publish:
    name: Upload to PyPI
    runs-on: ubuntu-latest
    permissions:
      id-token: write # For PyPI's trusted publishing
      contents: read # To checkout the code
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Validate server.json version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF_NAME}"
          SERVER_VERSION=$(jq -r '.version' server.json)
          PACKAGE_VERSION=$(jq -r '.packages[0].version' server.json)

          echo "Git tag: $TAG_VERSION"
          echo "server.json version: $SERVER_VERSION"
          echo "server.json package version: $PACKAGE_VERSION"

          if [ "$TAG_VERSION" != "$SERVER_VERSION" ]; then
            echo "❌ Version mismatch: Git tag ($TAG_VERSION) != server.json version ($SERVER_VERSION)"
            echo "Update server.json version to match the tag before releasing."
            exit 1
          fi

          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "❌ Version mismatch: Git tag ($TAG_VERSION) != server.json package version ($PACKAGE_VERSION)"
            echo "Update server.json packages[0].version to match the tag before releasing."
            exit 1
          fi

          echo "✅ All versions match: $TAG_VERSION"

      - name: Build
        run: uv build

      - name: Publish to PyPI
        run: uv publish -v dist/*

      - name: install mcp publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_linux_amd64.tar.gz" | tar xz
          sudo mv mcp-publisher /usr/local/bin/

      - name: login to mcp registry (github oidc)
        run: mcp-publisher login github-oidc

      - name: publish to mcp registry
        run: mcp-publisher publish
