# Copyright 2024 Christian Prior-Mamulyan
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""Core functionality for introspecting Typer/Click applications and generating manifests.

This module provides backward compatibility with the original API.
New code should use the collector and renderers modules directly.
"""

from __future__ import annotations

import json
from pathlib import Path
from typing import Any

# Import from new modular structure
from .collector import collect_manifest as build_manifest  # noqa: F401
from .renderers import MarkdownRenderer, render_manifest  # noqa: F401
from .types import Manifest  # noqa: F401

# Note: We keep the original imports and docstrings to maintain API compatibility
# The actual implementations are now in collector.py and renderers.py

__all__ = (
    "build_manifest",
    "write_manifest",
    "render_manifest_list",
    "render_manifest",
)


def write_manifest(app: Any, path: str, root_command_name: str | None = None) -> None:
    """Generate a manifest and write it to a JSON file.

    This function maintains backward compatibility with the original API.
    It collects the manifest and renders it as JSON.

    Args:
        app: A Typer app or Click command object
        path: File path where the JSON manifest should be written
        root_command_name: Optional name for the root command

    Example:
        >>> from typer import Typer
        >>> app = Typer()
        >>> write_manifest(app, "docs/cli-manifest.json", "myapp")
    """
    data = build_manifest(app, root_command_name=root_command_name)
    rendered = json.dumps(data, indent=2)
    Path(path).write_text(rendered, encoding="utf-8")


def render_manifest_list(manifest: dict[str, Any]) -> str:
    """Render a manifest as a Markdown bullet list.

    This function maintains backward compatibility with the original API.
    It delegates to the MarkdownRenderer class.

    Args:
        manifest: A manifest dictionary generated by build_manifest()

    Returns:
        A Markdown-formatted string with a hierarchical bullet list of commands

    Example:
        >>> manifest = build_manifest(app, "myapp")
        >>> print(render_manifest_list(manifest))
        # myapp commands
        - myapp hello: Say hello to someone
    """
    return MarkdownRenderer()(manifest)
