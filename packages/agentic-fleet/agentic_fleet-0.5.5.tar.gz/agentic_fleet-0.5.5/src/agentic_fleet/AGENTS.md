# AGENTS.md

## Overview

`src/agentic_fleet/` houses the FastAPI backend, workflow runtime, CLI entry points, and integration
shims that power the Magentic Fleet orchestration layer. It instantiates specialists from declarative
YAML, streams OpenAI-compatible Responses events to the frontend, and wires optional integrations
such as Mem0 or MCP connectors. Treat this directory as the source of truth for runtime behaviour;
configuration changes should flow through the YAML and `get_config()` helpers rather than hardcoding
values in code.

## Directory Map

| Path                       | Purpose                                                                                                                                                                                      |
| -------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `agents/`                  | Agent registry (`coordinator.AgentFactory`) plus specialist configs (`planner.py`, `executor.py`, `coder.py`, `verifier.py`, `generator.py`). Each module exposes `get_config()`.            |
| `prompts/`                 | Prompt modules returning `get_instructions()` strings consumed by the agents and manager.                                                                                                    |
| `api/`                     | FastAPI routers and services: `responses/`, `conversations/`, `entities/`, `chat/`, `approvals/`, `system/`, `workflows/`, and shared wiring (`app.py`, `workflow_factory.py`, `eventing/`). |
| `workflow/`                | Builders and orchestration glue (`magentic_workflow.py`, `magentic_builder.py`, `events.py`, `executor.py`).                                                                                 |
| `models/`                  | Pydantic schemas for requests, responses, workflow metadata, SSE envelopes, and OpenAI compatibility.                                                                                        |
| `tools/`                   | Tool registry (`registry.ToolRegistry`) plus concrete adapters such as `hosted_interpreter.py` and MCP bridge stubs.                                                                         |
| `integrations/`            | Optional providers (Mem0 memory, MCP bridges). Only import when the corresponding extras and env vars are present.                                                                           |
| `utils/`                   | Settings loader (`config.py`), logging bootstrap (`logging.py`), workflow factory helpers, and misc utilities.                                                                               |
| `cli/` & `console.py`      | Typer CLI (`uv run fleet`) and rich terminal console (`uv run python -m agentic_fleet.console`).                                                                                             |
| `server.py` / `api/app.py` | FastAPI application factory (`create_app`) and ASGI entry point exported as `app`.                                                                                                           |
| `ui/`                      | Static assets generated by `make build-frontend` (built React bundle hosted by the backend).                                                                                                 |
| `workflows.yaml`           | Packaged default workflows definition (single authoritative source unless AF_WORKFLOW_CONFIG points elsewhere).                                                                              |

## Agent Roster

- **Planner (`agents.planner`)** — High-effort reasoning agent that decomposes a request into discrete
  steps. Uses `prompts.planner` and stores transcripts for audits.
- **Executor (`agents.executor`)** — Coordinates cross-agent execution, escalates blockers, and tracks
  plan progress. Runs at medium effort with `prompts.executor`.
- **Coder (`agents.coder`)** — Technical specialist with lower temperature and `HostedCodeInterpreterTool`
  access. Implements fixes and proof-of-concept code.
- **Verifier (`agents.verifier`)** — Quality gate validating intermediate outputs and signalling
  regressions. Shares high-effort reasoning for detailed critiques.
- **Generator (`agents.generator`)** — Synthesises verified work into the final answer with higher
  temperature for narrative polish.
- **Manager (configured in `workflows.yaml`)** — Orchestrator that owns the Magentic session, delegates
  to specialists, and applies conversation-level reasoning settings.

Additions or changes to this roster require updates to `workflows.yaml`, the relevant `agents/*.py`
module, and coverage in `tests/test_workflow_factory.py` plus `tests/test_event_bridge.py`.

## Configuration & Environment

- Workflow resolution priority: `AF_WORKFLOW_CONFIG` (absolute path) → packaged `workflows.yaml`.
  New workflow IDs must serialise through `models.workflow.WorkflowConfig` and appear in `/v1/entities`.
- Core environment variables: `OPENAI_API_KEY`, `OPENAI_BASE_URL`. Optional extras include OTEL
  (`ENABLE_OTEL`, `OTLP_ENDPOINT`), Mem0 credentials, Cosmos DB strings, and Redis URLs.
- Load `.env` for local development; production deployments should rely on injected environment vars
  or managed secret stores.
- Keep configuration declarative. For prompts, reference modules (e.g. `prompts.executor`) instead of
  embedding large instruction strings inline.

## Workflow & Streaming Pipeline

- `workflow/magentic_workflow.MagenticFleetWorkflowBuilder` loads workflow config, instantiates the
  manager plus specialists, and returns a `MagenticFleetWorkflow` wrapper around
  `agent_framework.MagenticBuilder`.
- `workflow/events.WorkflowEventBridge` converts Magentic events into dictionaries consumed by the
  Responses API and SSE handlers. Update this bridge alongside frontend event parsers.
- `api/responses/service.ResponseAggregator` adapts workflow events into OpenAI Responses-compatible
  payloads, powering both streaming (`text/event-stream`) and non-streaming responses.
- `api/workflows/routes.py` exposes workflow discovery and instantiation endpoints using
  `api/workflow_factory.WorkflowFactory`.
- When extending events or payloads, add coverage in `tests/test_event_bridge.py`,
  `tests/test_api_responses_streaming.py`, and the frontend SSE store.

## API Surface

- `/v1/system/health`, `/v1/system/info` — Health and metadata probes used by monitoring and CI.
- `/v1/conversations/*` — Backward-compatible REST interface for conversation history.
- `/v1/chat/completions` — Compatibility shim, routed through the same workflow factory.
- `/v1/responses` — OpenAI Responses API with optional streaming via SSE.
- `/v1/entities` — Advertises available workflow IDs and metadata sourced from the YAML.
- `/v1/workflows/*` — Introspect and instantiate workflows.
- `/v1/approvals/*` — Human-in-the-loop review hooks leveraged by the frontend approval UI.
- `/v1/event-stream` (if enabled) — Server-sent events for workflow telemetry.

Update `src/agentic_fleet/api/app.py` when registering new routers to ensure FastAPI mounts the
module.

## CLI & Automation

- Launch the API via `uv run uvicorn agentic_fleet.server:app --reload --port 8000` (wrapped by
  `make backend`). Use `make dev` to run backend and frontend together.
- Typer CLI (`uv run fleet`) lives under `src/agentic_fleet/cli/`. Extend commands there and keep docs
  in `docs/cli/`.
- Rich console: `uv run python -m agentic_fleet.console` streams Responses events locally for quick
  validation.
- Static asset sync: `make build-frontend` rebuilds the React bundle into `src/agentic_fleet/ui`.

## Testing & Validation

- Backend suite: `make test` (`uv run pytest -v`). Key files include
  `tests/test_api_responses_streaming.py`, `tests/test_magentic_backend_integration.py`,
  `tests/test_workflow_factory.py`, and `tests/test_event_bridge.py`.
- Configuration smoke test: `make test-config` instantiates `WorkflowFactory` and validates imports.
- Documentation invariants: `make validate-agents`.
- When adding tools or agents, add fixture coverage in `tests/test_tools` (if applicable) and update
  the workflow factory tests.

## Coding Standards

- Keep runtime behaviour configuration-driven—no hardcoded model IDs, prompts, or tool lists.
- Use Python 3.12 typing features (`|`, `Literal`, `TypedDict`, `TypeAlias`) and annotate every new
  function. Maintain explicit `__all__` for modules that form the public surface.
- Pydantic models in `models/` define API contracts. Update schemas first, then adjust routers or
  services.
- The `core/` package exists solely for legacy import compatibility. Do not add new functionality
  there; import from `agents`, `workflow`, `models`, `tools`, or `utils` instead.
- Leverage `utils.logging.setup_logging()` for consistent structured logging.

## Troubleshooting

- `ValueError: OPENAI_API_KEY is not set` — ensure the variable is exported (e.g. load `.env`) before
  starting the backend.
- `Workflow '{id}' not found` — confirm the ID exists in the resolved YAML and matches `/v1/entities`.
  Run `make test-config` to surface import errors.
- Hanging SSE responses — inspect `ResponseAggregator` and corresponding frontend SSE handlers. Run
  `tests/test_api_responses_streaming.py` and check browser console logs.
- `Tool 'HostedCodeInterpreterTool' not found` — ensure `ToolRegistry` registers the tool and the
  optional dependency is installed (`make install`).
- Missing static assets — rerun `make build-frontend` to refresh `src/agentic_fleet/ui`.
