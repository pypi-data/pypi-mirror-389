import{d as X,i as A,r as h,f as d,aW as w,x as Y,y as Z,n as D,z as ee,R as te,A as q,o as g,G as C,B as i,J as O,u as W,H as se,S as ae,j as le,K as oe,I as x,aA as ie}from"./primevue-BhybIXDC.js";import{T as ne}from"./BrainIcon-Cg6sqKva.js";import{u as re}from"./BaseQueryCell-5qJKeHAI.js";const ue={class:"query-cell-grid"},ce={class:"query-content"},ve={class:"query-prompt"},de={class:"query-text"},pe={key:0,class:"last-thought"},ye={class:"thought-content"},fe={key:1,class:"thinking-indicator"},he={class:"thought-icon"},ge={class:"state-info"},we=X({__name:"NextBeakerQueryCell",props:["index","cell"],setup(z,{expose:N}){const j=z,{cell:s,events:S,execute:I,exit:L,clear:F}=re(j),m=A("beakerSession"),M=A("notebook"),V=Z(),T=h(!1),l=h(null),o=h(!1),k=h(!1);d(()=>s.value.id===M?.selectedCellId);const R=d(()=>{const e=S.value.filter(a=>a.type==="thought");if(e.length===0)return null;const t=e[e.length-1];if(typeof t.content=="string")return t.content;if(typeof t.content=="object"&&t.content?.thought)return t.content.thought;if(typeof t.content=="object"){const a=t.content;return a.thought||a.text||a.message||JSON.stringify(a)}return null}),$=d(()=>o.value&&_.value),_=d(()=>k.value?!0:s.value.metadata?.query_status==="in-progress"&&["busy","awaiting_input"].includes(s.value.status));w(()=>{s.value.metadata&&(s.value.metadata.auto_collapse_code_cells=T.value)}),w(()=>{const e=s.value.status,t=s?.value?.metadata?.query_status,a=S.value,c=s.value.last_execution;if(e==="busy"&&t==="pending")s.value.metadata.query_status="in-progress";else if(e==="failed")s.value.metadata.query_status="failed";else if(e==="idle"&&a.length>=0&&t==="in-progress"){if(c?.status==="abort"){s.value.metadata.query_status="aborted";return}if(a.some(u=>u.type==="abort")){s.value.metadata.query_status="aborted";return}a.some(u=>u.type==="response")&&a.length>0&&(s.value.metadata.query_status="success")}});const p=d(()=>{if(k.value)return{severity:"info",icon:"pi pi-spinner pi-spin busy-icon",tooltip:"Mock sticky mode active"};const e=s.value.metadata?.query_status,t=s.value.status,a=["busy","awaiting_input"].includes(t);return{success:{severity:"success",icon:"pi pi-check bolded",tooltip:"Query completed successfully"},failed:{severity:"danger",icon:"pi pi-times",tooltip:"Query failed with error"},aborted:{severity:"warn",icon:"pi pi-minus",tooltip:"Query was aborted"},"in-progress":{severity:a?"info":"danger",icon:a?"pi pi-spin pi-spinner busy-icon":"pi pi-times",tooltip:a?"Query is active":"Query failed with error"},pending:{severity:"secondary",icon:"pi pi-clock",tooltip:"Query is waiting to start"}}[e]||{severity:"secondary",icon:null,tooltip:"Query status unknown"}}),J=()=>{const e=l.value?.closest(".cell-container");if(!e)return;let t=!1,a=null,c=0,r=!1;const y=()=>{if(!l.value||!o.value)return;const n=e.getBoundingClientRect();l.value.style.setProperty("--sticky-top",`${n.top}px`),l.value.style.setProperty("--sticky-left",`${n.left}px`),l.value.style.setProperty("--sticky-right",`${window.innerWidth-n.right}px`)},u=()=>{t||(requestAnimationFrame(()=>{if(!l.value||!_.value){t=!1;return}const n=l.value.closest(".beaker-cell");if(!n){t=!1;return}if(r){t=!1;return}const v=e.scrollTop,B=v>c?"down":"up";c=v;const P=n.getBoundingClientRect(),E=e.getBoundingClientRect(),K=n===e.querySelector(".beaker-cell"),Q=o.value?10:40;P.top<E.top-Q&&!o.value&&B==="down"?(a&&window.clearTimeout(a),r=!0,o.value=!0,y(),setTimeout(()=>{r=!1},25)):P.top>=E.top+Q&&o.value&&B==="up"||K&&e.scrollTop<=5&&o.value?(a&&window.clearTimeout(a),a=window.setTimeout(()=>{l.value&&(r=!0,o.value=!1,l.value.style.removeProperty("--sticky-top"),l.value.style.removeProperty("--sticky-left"),l.value.style.removeProperty("--sticky-right"),setTimeout(()=>{r=!1},50),a=null)},40)):o.value&&!r&&y(),t=!1}),t=!0)};let f=null;if(window.ResizeObserver){let n=e.getBoundingClientRect().width;f=new ResizeObserver(()=>{const v=e.getBoundingClientRect().width;Math.abs(v-n)>1&&o.value&&(y(),n=v)}),f.observe(e)}return e.addEventListener("scroll",u,{passive:!0}),()=>{e.removeEventListener("scroll",u),f&&f.disconnect(),a&&window.clearTimeout(a)}},U=async()=>{o.value&&(await D(),l.value&&(l.value.style.removeProperty("--sticky-top"),l.value.style.removeProperty("--sticky-left"),l.value.style.removeProperty("--sticky-right")),o.value=!1)};w(()=>{if(k.value)return;const e=s.value.metadata?.query_status;(e==="success"||e==="failed"||e==="aborted")&&o.value&&U()});const G=e=>{o.value&&(e.preventDefault(),e.stopPropagation())},H=e=>{if(o.value){e.preventDefault(),e.stopPropagation();const t=l.value?.closest(".cell-container");t&&(t.scrollTop+=e.deltaY,t.scrollLeft+=e.deltaX)}};let b;return N({execute:(...e)=>{["success","failed","in-progress"].includes(s.value.metadata?.query_status)||I.call(this,e)},enter:()=>{},exit:L,clear:F,cell:s}),Y(()=>{m?.cellRegistry&&(m.cellRegistry[s.value.id]=V.vnode),s.value.metadata?.query_status||s.value.metadata&&(s.value.metadata.query_status="pending"),s.value.metadata?.auto_collapse_code_cells!==void 0&&(T.value=s.value.metadata.auto_collapse_code_cells),D(()=>{b=J()})}),ee(()=>{delete m.cellRegistry[s.value.id],b&&b(),l.value&&(l.value.style.removeProperty("--sticky-top"),l.value.style.removeProperty("--sticky-left"),l.value.style.removeProperty("--sticky-right"))}),(e,t)=>{const a=te("tooltip");return g(),q("div",{class:x(["next-query-cell",{"sticky-query":o.value}]),ref_key:"queryCellRef",ref:l,onClick:G,onWheel:H},[C("",!0),i("div",ue,[i("div",ce,[i("div",ve,[t[3]||(t[3]=i("div",{class:"query-label"},[i("span",{class:"pi pi-user query-icon"}),i("span",{class:"query-label-user"},"User")],-1)),i("div",de,O(W(s).source),1),$.value&&R.value?(g(),q("div",pe,[t[0]||(t[0]=i("div",{class:"thought-label"},[i("span",{class:"thought-label-text"},"Beaker Agent")],-1)),i("div",ye,O(R.value),1)])):C("",!0),!o.value&&_.value?(g(),q("div",fe,[i("span",he,[se(ne)]),t[1]||(t[1]=i("span",{class:"thinking-text"},"Agent Running",-1)),t[2]||(t[2]=i("span",{class:"thinking-animation"},null,-1))])):C("",!0)])]),i("div",ge,[i("div",null,[ae((g(),le(W(ie),{class:x(["execution-badge",{secondary:p.value.severity==="secondary"}]),severity:p.value.severity,value:" "},{default:oe(()=>[i("i",{class:x(p.value.icon)},null,2)]),_:1},8,["class","severity"])),[[a,p.value.tooltip,void 0,{top:!0}]])])])])],34)}}});export{we as _};
