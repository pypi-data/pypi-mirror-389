Metadata-Version: 2.4
Name: never-jscore
Version: 1.0.0
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Rust
Classifier: Topic :: Software Development :: Libraries :: Python Modules
Classifier: Typing :: Typed
Summary: Fast JavaScript execution in Python using Deno Core (PyExecJS replacement)
Keywords: javascript,execjs,deno,v8,js,python,rust
License: MIT
Requires-Python: >=3.8
Description-Content-Type: text/markdown; charset=UTF-8; variant=GFM
Project-URL: Homepage, https://github.com/neverl805/never-jscore
Project-URL: Repository, https://github.com/neverl805/never-jscore

# never_jscore ä¸­æ–‡æ–‡æ¡£

åŸºäº Deno Core (V8) çš„é«˜æ€§èƒ½ Python JavaScript æ‰§è¡Œå¼•æ“ã€‚

## é¡¹ç›®ç‰¹ç‚¹

- âš¡ **æè‡´æ€§èƒ½**:
  - ä½¿ç”¨ Rust + Deno Core (V8 å¼•æ“)
  - thread_local Context ç¼“å­˜ä¼˜åŒ–
  - **æ¯” PyExecJS å¿« 100-300å€**
  - **ä¸ PyMiniRacer æ€§èƒ½ç›¸å½“ï¼Œéƒ¨åˆ†åœºæ™¯æ›´å¿«**
- ğŸ”„ **Promise/async æ”¯æŒ**:
  - å®Œæ•´æ”¯æŒ Promise å’Œ async/await
  - è‡ªåŠ¨ç­‰å¾…å¼‚æ­¥ç»“æœ
  - **å”¯ä¸€é«˜æ€§èƒ½ Promise æ–¹æ¡ˆ**ï¼ˆPyMiniRacer ä¸æ”¯æŒï¼‰
- ğŸ“¦ **ä¸Šä¸‹æ–‡éš”ç¦»**: æ¯ä¸ª Context ç‹¬ç«‹çš„ V8 æ‰§è¡Œç¯å¢ƒï¼Œäº’ä¸å¹²æ‰°
- ğŸ¯ **PyExecJS å…¼å®¹**: API è®¾è®¡å…¼å®¹ PyExecJSï¼Œå¯ç›´æ¥æ›¿æ¢ä½¿ç”¨
- ğŸ§¹ **è‡ªåŠ¨å†…å­˜ç®¡ç†**: åŸºäº Rust çš„è‡ªåŠ¨åƒåœ¾å›æ”¶ï¼Œæ— å†…å­˜æ³„æ¼
- ğŸ›¡ï¸ **ç±»å‹å®‰å…¨**: æä¾›å®Œæ•´çš„ç±»å‹æç¤ºï¼ˆ.pyi æ–‡ä»¶ï¼‰
- ğŸ® **JSé€†å‘é¦–é€‰**: ä¸“ä¸º JS é€†å‘å·¥ç¨‹ä¼˜åŒ–ï¼Œæ”¯æŒæ‰¹é‡å‡½æ•°è°ƒç”¨

## æ€§èƒ½å¯¹æ¯”

| æµ‹è¯•é¡¹ç›® | never_jscore | PyMiniRacer | PyExecJS |
|---------|-------------|-------------|----------|
| ç®€å•è®¡ç®— | 0.012ms | 0.005ms | 2.3ms |
| å­—ç¬¦ä¸²æ“ä½œ | **0.004ms** ğŸ† | 0.008ms | 2.3ms |
| æ•°ç»„æ“ä½œ | **0.004ms** ğŸ† | 0.006ms | 2.3ms |
| Promise | **âœ… 0.003ms** | âŒ ä¸æ”¯æŒ | âŒ ä¸æ”¯æŒ |


## å®‰è£…

### ä»æºç å®‰è£…

```bash
pip install maturin
maturin develop --release
```

## å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ç”¨æ³•

```python
import never_jscore as execjs

# ä¸€æ¬¡æ€§æ‰§è¡Œ
result = execjs.eval("1 + 2 + 3")
print(result)  # 6

# å­—ç¬¦ä¸²æ“ä½œ
result = execjs.eval("'Hello'.toUpperCase()")
print(result)  # HELLO

# æ•°ç»„æ“ä½œ
result = execjs.eval("[1, 2, 3].map(x => x * 2)")
print(result)  # [2, 4, 6]
```

### 2. ç¼–è¯‘å’Œè°ƒç”¨

```python
# ç¼–è¯‘ JavaScript ä»£ç 
ctx = execjs.compile("""
    function add(a, b) {
        return a + b;
    }

    function greet(name) {
        return "Hello, " + name + "!";
    }
""")

# è°ƒç”¨å‡½æ•°
print(ctx.call("add", [5, 3]))        # 8
print(ctx.call("greet", ["World"]))   # Hello, World!
```

### 3. å¼‚æ­¥æ”¯æŒï¼ˆPromise/async/awaitï¼‰

```python
# Promise è‡ªåŠ¨ç­‰å¾…
result = execjs.eval("Promise.resolve(42)")
print(result)  # 42

# async å‡½æ•°
ctx = execjs.compile("""
    async function fetchData(id) {
        // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
        return await Promise.resolve({id: id, name: "User" + id});
    }
""")

result = ctx.call("fetchData", [123])
print(result)  # {'id': 123, 'name': 'User123'}

# Promise é“¾
result = execjs.eval("""
    Promise.resolve(10)
        .then(x => x * 2)
        .then(x => x + 5)
""")
print(result)  # 25

# Promise.all å¹¶å‘
result = execjs.eval("""
    Promise.all([
        Promise.resolve(1),
        Promise.resolve(2),
        Promise.resolve(3)
    ])
""")
print(result)  # [1, 2, 3]
```

### 4. ä¸Šä¸‹æ–‡çŠ¶æ€ç®¡ç†

```python
ctx = execjs.compile("""
    var counter = 0;

    function increment() {
        return ++counter;
    }

    function getCounter() {
        return counter;
    }
""")

print(ctx.call("increment", []))  # 1
print(ctx.call("increment", []))  # 2
print(ctx.call("getCounter", []))  # 2
```

### 5. å¤æ‚å¯¹è±¡å¤„ç†

```python
ctx = execjs.compile("""
    function processUser(name, age, tags) {
        return {
            name: name,
            age: age,
            isAdult: age >= 18,
            tags: tags,
            summary: name + ' (' + age + 'å²)'
        };
    }
""")

result = ctx.call("processUser", ["å¼ ä¸‰", 25, ["Python", "JavaScript"]])
print(result)
# {
#     'name': 'å¼ ä¸‰',
#     'age': 25,
#     'isAdult': True,
#     'tags': ['Python', 'JavaScript'],
#     'summary': 'å¼ ä¸‰ (25å²)'
# }
```

### 6. ä»æ–‡ä»¶åŠ è½½

```python
# ä»æ–‡ä»¶ç¼–è¯‘
ctx = execjs.compile_file("script.js")
result = ctx.call("myFunction", [arg1, arg2])

# ä»æ–‡ä»¶æ‰§è¡Œ
result = execjs.eval_file("script.js")
```

### 7. æ€§èƒ½ç›‘æ§

```python
ctx = execjs.compile("function compute(n) { return n * n; }")

# æ‰§è¡Œå¤šæ¬¡
for i in range(100):
    ctx.call("compute", [i])

# æŸ¥çœ‹ç»Ÿè®¡
stats = ctx.get_stats()
print(f"æ‰§è¡Œæ¬¡æ•°: {stats[0]}")  # 100

# è¯·æ±‚åƒåœ¾å›æ”¶ï¼ˆå¯é€‰ï¼‰
ctx.gc()

# é‡ç½®ç»Ÿè®¡
ctx.reset_stats()
```

## API å‚è€ƒ

### æ¨¡å—å‡½æ•°

#### `compile(code: str) -> Context`

ç¼–è¯‘ JavaScript ä»£ç å¹¶è¿”å›æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚

**å‚æ•°**:
- `code`: JavaScript ä»£ç å­—ç¬¦ä¸²

**è¿”å›**: Context å¯¹è±¡

**ç¤ºä¾‹**:
```python
ctx = execjs.compile('''
    function add(a, b) { return a + b; }
''')
```

#### `eval(code: str, auto_await: bool = True) -> Any`

ä¸€æ¬¡æ€§æ‰§è¡Œ JavaScript ä»£ç ã€‚

**å‚æ•°**:
- `code`: JavaScript ä»£ç å­—ç¬¦ä¸²
- `auto_await`: æ˜¯å¦è‡ªåŠ¨ç­‰å¾… Promiseï¼ˆé»˜è®¤ Trueï¼‰

**è¿”å›**: æ‰§è¡Œç»“æœ

**ç¤ºä¾‹**:
```python
result = execjs.eval("1 + 2 + 3")  # 6
result = execjs.eval("Promise.resolve(42)")  # 42
```

#### `compile_file(path: str) -> Context`

ä»æ–‡ä»¶è¯»å–å¹¶ç¼–è¯‘ JavaScript ä»£ç ã€‚

#### `eval_file(path: str, auto_await: bool = True) -> Any`

ä»æ–‡ä»¶è¯»å–å¹¶æ‰§è¡Œ JavaScript ä»£ç ã€‚

### Context ç±»

#### `call(name: str, args: list, auto_await: bool = True) -> Any`

è°ƒç”¨ JavaScript å‡½æ•°ã€‚

**å‚æ•°**:
- `name`: å‡½æ•°åç§°
- `args`: å‚æ•°åˆ—è¡¨
- `auto_await`: æ˜¯å¦è‡ªåŠ¨ç­‰å¾… Promiseï¼ˆé»˜è®¤ Trueï¼‰

**è¿”å›**: å‡½æ•°è¿”å›å€¼

**ç¤ºä¾‹**:
```python
result = ctx.call("add", [1, 2])
result = ctx.call("asyncFunc", [arg], auto_await=True)
```

#### `eval(code: str, auto_await: bool = True) -> Any`

åœ¨å½“å‰ä¸Šä¸‹æ–‡æ‰§è¡Œä»£ç ã€‚

**å‚æ•°**:
- `code`: JavaScript ä»£ç å­—ç¬¦ä¸²
- `auto_await`: æ˜¯å¦è‡ªåŠ¨ç­‰å¾… Promiseï¼ˆé»˜è®¤ Trueï¼‰

**è¿”å›**: æ‰§è¡Œç»“æœ

#### `gc() -> None`

è¯·æ±‚ V8 åƒåœ¾å›æ”¶ã€‚

**æ³¨æ„**: è¿™åªæ˜¯æç¤ºï¼ŒV8 ä¼šæ ¹æ®è‡ªå·±çš„ç­–ç•¥å†³å®šæ˜¯å¦æ‰§è¡Œã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ— éœ€æ‰‹åŠ¨è°ƒç”¨ã€‚

#### `get_stats() -> tuple[int]`

è·å–æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯ã€‚

**è¿”å›**: `(exec_count,)` æ‰§è¡Œæ¬¡æ•°å…ƒç»„

#### `reset_stats() -> None`

é‡ç½®ç»Ÿè®¡ä¿¡æ¯ã€‚

## ç±»å‹è½¬æ¢

Python å’Œ JavaScript ä¹‹é—´çš„ç±»å‹è‡ªåŠ¨è½¬æ¢ï¼š

| Python ç±»å‹ | JavaScript ç±»å‹ | è¯´æ˜ |
|------------|----------------|------|
| None       | null           | ç©ºå€¼ |
| bool       | boolean        | å¸ƒå°”å€¼ |
| int        | number         | æ•´æ•° |
| float      | number         | æµ®ç‚¹æ•° |
| str        | string         | å­—ç¬¦ä¸² |
| list       | Array          | æ•°ç»„ |
| dict       | Object         | å¯¹è±¡ |

**ç¤ºä¾‹**:
```python
# Python -> JavaScript
ctx.call("func", [None, True, 42, 3.14, "hello", [1, 2], {"key": "value"}])

# JavaScript -> Python
result = execjs.eval("{name: 'John', age: 30}")  # dict
result = execjs.eval("[1, 2, 3]")  # list
result = execjs.eval("null")  # None
```

## ä½¿ç”¨é™åˆ¶

### å¤š Context é™åˆ¶

âš ï¸ **é‡è¦**: ç”±äº V8 å¼•æ“é™åˆ¶ï¼Œ**ä¸èƒ½äº¤å‰ä½¿ç”¨å¤šä¸ª Context å®ä¾‹**ã€‚

```python
# âŒ é”™è¯¯ç”¨æ³•ï¼šäº¤å‰ä½¿ç”¨ä¼šå´©æºƒ
ctx1 = execjs.compile("function f1() { return 1; }")
ctx2 = execjs.compile("function f2() { return 2; }")
ctx1.call("f1", [])  # OK
ctx2.call("f2", [])  # OK
ctx1.call("f1", [])  # âŒ å´©æºƒï¼

# âœ… æ­£ç¡®ç”¨æ³•ï¼šå•ä¸ª Context åŒ…å«æ‰€æœ‰å‡½æ•°
ctx = execjs.compile("""
    function f1() { return 1; }
    function f2() { return 2; }
""")
ctx.call("f1", [])  # OK
ctx.call("f2", [])  # OK
ctx.call("f1", [])  # OK
```

**æ¨èåšæ³•**:
1. **å• Context æ¨¡å¼**ï¼ˆæœ€æ¨èï¼‰: å°†æ‰€æœ‰å‡½æ•°å®šä¹‰åœ¨ä¸€ä¸ª Context ä¸­
2. **é¡ºåºä½¿ç”¨**: ç”¨å®Œä¸€ä¸ª Context å†åˆ›å»ºä¸‹ä¸€ä¸ª
3. **eval() æ¨¡å¼**: ä½¿ç”¨ `execjs.eval()` è¿›è¡Œä¸€æ¬¡æ€§æ‰§è¡Œ

è¯¦è§é¡¹ç›®æ–‡æ¡£ `MULTI_CONTEXT_LIMITATION.md`ã€‚

## é€‚ç”¨åœºæ™¯

### JavaScript é€†å‘åˆ†æ

```python
# åŠ è½½ç›®æ ‡ç½‘ç«™çš„åŠ å¯† JS
with open("target_crypto.js") as f:
    js_code = f.read()

ctx = execjs.compile(js_code)

# è°ƒç”¨åŠ å¯†å‡½æ•°
encrypted = ctx.call("encrypt", [plain_text, key])

# è°ƒç”¨è§£å¯†å‡½æ•°
decrypted = ctx.call("decrypt", [cipher_text, key])

# è§£æå“åº”
parsed = ctx.call("parseResponse", [response_data])
```

### å‰ç«¯å·¥å…·é›†æˆ

```python
# ä½¿ç”¨ JavaScript å·¥å…·åº“
ctx = execjs.compile_file("lodash.min.js")
result = ctx.call("_.uniq", [[1, 2, 2, 3, 3, 3]])
print(result)  # [1, 2, 3]
```

### å¼‚æ­¥æ•°æ®å¤„ç†

```python
ctx = execjs.compile("""
    async function processBatch(items) {
        const results = await Promise.all(
            items.map(async item => {
                // æ¨¡æ‹Ÿå¼‚æ­¥å¤„ç†
                return await Promise.resolve(item * 2);
            })
        );
        return results;
    }
""")

result = ctx.call("processBatch", [[1, 2, 3, 4, 5]])
print(result)  # [2, 4, 6, 8, 10]
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **é‡å¤æ‰§è¡Œä½¿ç”¨ compile()**: å¯¹äºéœ€è¦å¤šæ¬¡è°ƒç”¨çš„ä»£ç ï¼Œä½¿ç”¨ `compile()` è€Œä¸æ˜¯ `eval()`
2. **æ‰¹é‡å¤„ç†**: åœ¨ JavaScript ç«¯æ‰¹é‡å¤„ç†æ•°æ®ï¼Œå‡å°‘ Python-JS è°ƒç”¨æ¬¡æ•°
3. **é¿å…é¢‘ç¹åˆ›å»º Context**: å°½å¯èƒ½å¤ç”¨åŒä¸€ä¸ª Context
4. **åˆç†ä½¿ç”¨ auto_await**: å¯¹äºä¸éœ€è¦ç­‰å¾…çš„åŒæ­¥ä»£ç ï¼Œè®¾ç½® `auto_await=False` å¯ç•¥å¾®æå‡æ€§èƒ½

## æ¨¡å—åŒ–æ¶æ„

é¡¹ç›®é‡‡ç”¨æ¸…æ™°çš„æ¨¡å—åŒ–è®¾è®¡ï¼š

```
src/
â”œâ”€â”€ lib.rs        # æ¨¡å—å…¥å£ï¼Œå¯¼å‡º Python API
â”œâ”€â”€ context.rs    # Context å®ç°
â”œâ”€â”€ runtime.rs    # V8/Tokio runtime ç®¡ç†
â”œâ”€â”€ ops.rs        # Deno Core ops å®šä¹‰
â”œâ”€â”€ convert.rs    # Python â†” JavaScript ç±»å‹è½¬æ¢
â””â”€â”€ storage.rs    # ç»“æœå­˜å‚¨
```

## æµ‹è¯•

```bash
# åŸºæœ¬åŠŸèƒ½æµ‹è¯•
python test_single_ctx.py

# æ¨¡å—åŒ–æµ‹è¯•
python test_modular.py
```

## æŠ€æœ¯ç»†èŠ‚

- **V8 å¼•æ“**: ä½¿ç”¨ Deno Core æä¾›çš„ V8 bindings
- **Tokio Runtime**: å…¨å±€å•çº¿ç¨‹ runtimeï¼Œæ”¯æŒå¼‚æ­¥æ“ä½œ
- **ç±»å‹è½¬æ¢**: Python â†” JSON â†” JavaScript ä¸‰å±‚è½¬æ¢
- **å†…å­˜ç®¡ç†**: Rust è‡ªåŠ¨ç®¡ç†ï¼Œæ¯ 100 æ¬¡æ‰§è¡Œæç¤º GC

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ç›¸å…³é¡¹ç›®

- [PyExecJS](https://github.com/doloopwhile/PyExecJS) - åŸ Python ExecJS å®ç°
- [Deno](https://github.com/denoland/deno) - ç°ä»£ JavaScript/TypeScript è¿è¡Œæ—¶
- [PyO3](https://github.com/PyO3/pyo3) - Rust Python bindings

## æ›´æ–°æ—¥å¿—

### v0.1.0

- âœ… åŸºäº Deno Core çš„ JavaScript æ‰§è¡Œ
- âœ… Promise/async/await å®Œæ•´æ”¯æŒ
- âœ… Python â†” JavaScript ç±»å‹è‡ªåŠ¨è½¬æ¢
- âœ… æ¨¡å—åŒ–ä»£ç æ¶æ„
- âœ… å®Œæ•´çš„ç±»å‹æç¤ºæ”¯æŒ
- âœ… æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

