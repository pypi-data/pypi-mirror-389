import"../chunks/DsnmJJEf.js";import{o as it,s as me}from"../chunks/C6tn_jEF.js";import{p as It,u as je,g as e,s as $,e as mt,b as pe,d as h,l as xe,k as bt,h as re,b8 as wt,f as ve,m as S,i as F,r as N,c as Xe,a as D,b9 as xt,q as Ne,j as Dt,t as Ft,n as Pt}from"../chunks/BPIoXquA.js";import{p as Yt,i as fe,b as jt}from"../chunks/lzapwbvy.js";import{E as _e}from"../chunks/Dmw0JB4Z.js";import{F as Ht,n as Ge,j as Et,r as kt,b as ft,S as Ut,c as Xt,t as zt,f as Wt}from"../chunks/BG-hj6TZ.js";import{e as et,i as tt,u as Gt,g as Vt,b as Ct}from"../chunks/BUFwSDdR.js";import{u as Nt}from"../chunks/F3PdWuc7.js";import{A as $t}from"../chunks/CAngS_wK.js";import{D as qt}from"../chunks/BEdcgSQn.js";import{s as W,a as Kt,c as Zt}from"../chunks/BeKPjfAQ.js";import{d as Jt,e as dt}from"../chunks/B6F7olol.js";import{s as gt}from"../chunks/CT5IDZYs.js";import{d as Qt,n as er,s as Ye,a as Tt,b as tr,c as vt,e as ht,y as rr,p as _t,i as yt,f as ar,T as or}from"../chunks/DbXQBrJp.js";import{d as nr}from"../chunks/CgsLtv0Y.js";const Pe=140,rt=16,sr=50,lr=200,Lt=140,ir=32,Fe=5,nt=20,Ot=10,Rt=2,Ue=16,ur=40;let G=[],He=[],ze=!1;function Ve(a,l){return a.reduce((r,d)=>r+l(d),0)}function cr(){G.forEach(a=>{a.linksOut=He.filter(l=>l.source===a),a.linksIn=He.filter(l=>l.target===a)})}function fr(){G.forEach(a=>{a.value=ze?1:Math.max(Ve(a.linksIn,l=>l.value),Ve(a.linksOut,l=>l.value))})}function dr(){G=G.filter(a=>a.linksIn.length>0||a.linksOut.length>0)}function gr(){let a=0,l=[];He.forEach(r=>{Mt(r.source,r.target,l)?(r.causesCycle=!0,r.cycleIndex=++a):(r.causesCycle=!1,l.push(r))})}function Mt(a,l,r){let d=r.filter(i=>i.source===l);return r.length==0||d.length==0?!1:d.some(i=>i.target===a||Mt(a,i.target,r))}function vr(){let a=G,l=[],r=0;for(;a.length;)l=[],a.forEach(d=>{d.x=r,d.linksOut.forEach(i=>{i.causesCycle||l.push(i.target)})}),a=l,r++;for(a=G;a.length;)l=[],a.forEach(d=>{if(d.linksOut.length>0&&d.stickTo===null){const i=d.linksOut.filter(f=>!f.causesCycle).map(f=>f.target.x);i.length>0&&(d.x=Math.max(d.x,Math.min(...i)-1))}d.linksIn.forEach(i=>{i.causesCycle||l.push(i.source)})}),a=l;G.forEach(d=>{d.stickTo==="right"&&(d.x=r-1)}),hr(Lt+Pe)}function hr(a){G.forEach(l=>{l.x*=a})}function yr(){let a={};return G.forEach(l=>{const r=l.x;a[r]||(a[r]=[]),a[r].push(l)}),Object.values(a).sort((l,r)=>l[0].x-r[0].x)}function st(a){return a.y+a.dy/2}function mr(){let a=yr();l(),f();for(let y=1,m=0;m<ir;++m,y*=.95)i(y),f(),d(y),f();function l(){const y=ze?ur:lr,m=Math.min(...G.map(u=>u.value>1e-6?y/u.value:1/0));let p=0;G.filter(u=>u.distinctRow).sort((u,x)=>u.x-x.x).forEach(u=>{u.y=p,u.dy=u.value*m,p+=u.dy+sr}),a.forEach(u=>{let x=0;u.filter(T=>!T.distinctRow).forEach(T=>{T.y=x,T.dy=T.value*m,x+=T.dy+rt})}),He.forEach(u=>{u.dy=ze?6:u.value*m})}function r(y){return ze?1:Math.max(y.value,1e-6)}function d(y){a.forEach(m=>{m.forEach(p=>{if(p.linksIn.length===0||p.distinctRow)return;const u=p.linksIn,x=Ve(u,T=>st(T.source)*r(T))/Ve(u,T=>r(T));p.y+=(x-st(p))*y})})}function i(y){a.slice().reverse().forEach(m=>{m.forEach(p=>{if(p.linksOut.length===0||p.distinctRow)return;const u=p.linksOut,x=Ve(u,T=>st(T.target)*r(T))/Ve(u,T=>r(T));p.y+=(x-st(p))*y})})}function f(){a.forEach(y=>{let m=y[0],p,u=0,x=y.length,T;for(y.sort((j,$e)=>j.y-$e.y),T=0;T<x;++T)m=y[T],p=u-m.y,m.distinctRow?p>0?(y[T-1].y=m.y+m.dy+rt,u=y[T-1].y+y[T-1].dy+rt):u=m.y+m.dy+rt:(p>0&&(m.y+=p),u=m.y+m.dy+rt)})}}function At(){let a=(r,d)=>(i,f)=>{const y=d?1:-1;return i.causesCycle&&f.causesCycle?y*(i.cycleIndex-f.cycleIndex):i.causesCycle?-y:f.causesCycle?y:i[r].y-f[r].y},l=Math.max(...G.map(r=>r.y+r.dy));G.forEach(r=>{r.linksIn.sort(a("source",r.y<l/2)),r.linksOut.sort(a("target",r.y<l/2))}),G.forEach(r=>{let d=0,i=0;r.linksOut.forEach(f=>{ze?f.sy=(r.dy-f.dy)/2:(f.sy=d,d+=f.dy)}),r.linksIn.forEach(f=>{ze?f.ty=(r.dy-f.dy)/2:(f.ty=i,i+=f.dy)})})}function _r(a,l,r){G=a,He=l,ze=r,cr(),fr(),dr(),gr(),vr(),mr(),At()}function pr(a,l){a<0||a>=G.length||(G[a].y=l,At())}function St(){const a=G.map(r=>({label:r.label,color:r.color,value:r.value,unit:r.unit,unitSuffix:r.unitSuffix,showTotal:r.showTotal,x:r.x,y:r.y,dy:r.dy,linksIn:He.map((d,i)=>d.target===r?i:-1).filter(d=>d>=0),linksOut:He.map((d,i)=>d.source===r?i:-1).filter(d=>d>=0)})),l=He.map(r=>({source:a[G.indexOf(r.source)],target:a[G.indexOf(r.target)],value:r.value,color:r.color,unit:r.unit,causesCycle:r.causesCycle,cycleIndex:r.cycleIndex,dy:r.dy,sy:r.sy,ty:r.ty}));return[a,l]}const lt=a=>()=>a;function pt(a,{sourceEvent:l,subject:r,target:d,identifier:i,active:f,x:y,y:m,dx:p,dy:u,dispatch:x}){Object.defineProperties(this,{type:{value:a,enumerable:!0,configurable:!0},sourceEvent:{value:l,enumerable:!0,configurable:!0},subject:{value:r,enumerable:!0,configurable:!0},target:{value:d,enumerable:!0,configurable:!0},identifier:{value:i,enumerable:!0,configurable:!0},active:{value:f,enumerable:!0,configurable:!0},x:{value:y,enumerable:!0,configurable:!0},y:{value:m,enumerable:!0,configurable:!0},dx:{value:p,enumerable:!0,configurable:!0},dy:{value:u,enumerable:!0,configurable:!0},_:{value:x}})}pt.prototype.on=function(){var a=this._.on.apply(this._,arguments);return a===this._?this:a};function xr(a){return!a.ctrlKey&&!a.button}function br(){return this.parentNode}function wr(a,l){return l??{x:a.x,y:a.y}}function Er(){return navigator.maxTouchPoints||"ontouchstart"in this}function Cr(){var a=xr,l=br,r=wr,d=Er,i={},f=Qt("start","drag","end"),y=0,m,p,u,x,T=0;function j(s){s.on("mousedown.drag",$e).filter(d).on("touchstart.drag",Oe).on("touchmove.drag",Re,er).on("touchend.drag touchcancel.drag",be).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function $e(s,B){if(!(x||!a.call(this,s,B))){var L=De(this,l.call(this,s,B),s,B,"mouse");L&&(Ye(s.view).on("mousemove.drag",Ie,Tt).on("mouseup.drag",Te,Tt),tr(s.view),vt(s),u=!1,m=s.clientX,p=s.clientY,L("start",s))}}function Ie(s){if(ht(s),!u){var B=s.clientX-m,L=s.clientY-p;u=B*B+L*L>T}i.mouse("drag",s)}function Te(s){Ye(s.view).on("mousemove.drag mouseup.drag",null),rr(s.view,u),ht(s),i.mouse("end",s)}function Oe(s,B){if(a.call(this,s,B)){var L=s.changedTouches,H=l.call(this,s,B),V=L.length,ue,we;for(ue=0;ue<V;++ue)(we=De(this,H,s,B,L[ue].identifier,L[ue]))&&(vt(s),we("start",s,L[ue]))}}function Re(s){var B=s.changedTouches,L=B.length,H,V;for(H=0;H<L;++H)(V=i[B[H].identifier])&&(ht(s),V("drag",s,B[H]))}function be(s){var B=s.changedTouches,L=B.length,H,V;for(x&&clearTimeout(x),x=setTimeout(function(){x=null},500),H=0;H<L;++H)(V=i[B[H].identifier])&&(vt(s),V("end",s,B[H]))}function De(s,B,L,H,V,ue){var we=f.copy(),q=_t(ue||L,B),Le,he,K;if((K=r.call(s,new pt("beforestart",{sourceEvent:L,target:j,identifier:V,active:y,x:q[0],y:q[1],dx:0,dy:0,dispatch:we}),H))!=null)return Le=K.x-q[0]||0,he=K.y-q[1]||0,function M(Z,Me,se){var de=q,ke;switch(Z){case"start":i[V]=M,ke=y++;break;case"end":delete i[V],--y;case"drag":q=_t(se||Me,B),ke=y;break}we.call(Z,s,new pt(Z,{sourceEvent:Me,subject:K,target:j,identifier:V,active:ke,x:q[0]+Le,y:q[1]+he,dx:q[0]-de[0],dy:q[1]-de[1],dispatch:we}),H)}}return j.filter=function(s){return arguments.length?(a=typeof s=="function"?s:lt(!!s),j):a},j.container=function(s){return arguments.length?(l=typeof s=="function"?s:lt(s),j):l},j.subject=function(s){return arguments.length?(r=typeof s=="function"?s:lt(s),j):r},j.touchable=function(s){return arguments.length?(d=typeof s=="function"?s:lt(!!s),j):d},j.on=function(){var s=f.on.apply(f,arguments);return s===f?j:s},j.clickDistance=function(s){return arguments.length?(T=(s=+s)*s,j):Math.sqrt(T)},j}function Bt(a,l){let r=0;for(let d of a)(d=+d)&&(r+=d);return r}var Nr=(a,l)=>h(l,!e(l)),$r=(a,l,r)=>l(e(r).carrier),Tr=re('<button class="btn btn-text rounded-0 d-flex align-items-center p-0 me-2 text-secondary"><svg width="40" height="12" class="me-1 svelte-l7ef6a"><rect width="40" height="12"></rect></svg> <span class="fs-7 svelte-l7ef6a"> </span></button>'),Or=re('<div class="mb-2 d-flex flex-wrap justify-content-center"></div>'),Rr=xt('<path class="cycle-link svelte-l7ef6a"><title> </title></path>'),Sr=xt('<path class="link svelte-l7ef6a"><title> </title></path>'),Br=xt('<g class="node svelte-l7ef6a"><rect class="svelte-l7ef6a"></rect><text text-anchor="middle"> </text></g>'),Ir=re('<div class="d-flex justify-content-between fs-8 px-2 text-no-break svelte-l7ef6a"><div class="me-1"><svg width="12" height="12" class="svelte-l7ef6a"><rect width="12" height="12"></rect></svg> </div> <div> </div></div>'),Dr=re('<div class="d-flex justify-content-between fs-8 px-2 text-no-break svelte-l7ef6a"><strong>Total:</strong> <div> </div></div>'),Lr=re('<div><div class="fw-bold mt-1 fs-7 px-2 svelte-l7ef6a">Inflows:</div> <!> <!></div>'),Mr=re('<div class="d-flex justify-content-between fs-8 px-2 text-no-break svelte-l7ef6a"><div class="me-1"><svg width="12" height="12" class="svelte-l7ef6a"><rect width="12" height="12"></rect></svg> </div> <div> </div></div>'),Ar=re('<div class="d-flex justify-content-between fs-8 px-2 text-no-break svelte-l7ef6a"><strong>Total:</strong> <div> </div></div>'),Fr=re('<div class="fw-bold mt-1 fs-7 px-2 svelte-l7ef6a">Outflows:</div> <!> <!>',1),Pr=re('<div class="fw-bold fs-7 px-2 svelte-l7ef6a"> </div> <!> <!>',1),Yr=re('<div class="d-flex justify-content-end mb-2"><button class="btn btn-outline-secondary d-flex"><i class="bi bi-house me-2"></i> <div>Reset zoom</div></button> <button class="btn btn-outline-secondary d-flex ms-2"><i class="bi bi-diagram-3 me-2"></i> <div> </div></button></div> <div><!></div> <div class="position-relative border rounded"><svg class="svelte-l7ef6a"><g><g class="links"></g><g class="nodes"></g></g></svg> <!></div>',1);function jr(a,l){It(l,!0);let r=$(936),d=800,i=$(void 0),f=Yt(l,"id",3,"diagram"),y=nr(j,100);je(()=>{e(Ae),l.nodes.length&&mt(()=>{T(l.nodes,l.links),y()})});let m=[],p=[],u=$(pe([])),x=$(pe([]));function T(t,o){m=t.map(g=>({label:g.label??"Unnamed",color:g.color??"#ccc",id:g.id??"",value:0,unit:g.unit??"",unitSuffix:g.unitSuffix??!1,stickTo:g.stickTo??null,showTotal:g.showTotal??!0,distinctRow:g.distinctRow??!1,linksIn:[],linksOut:[],x:0,y:0,dy:0})),p=o.flatMap(g=>{if(!e(Ae)&&g.value<1e-6)return[];let _=m.find(b=>b.id===g.source.id&&b.label===g.source.label),v=m.find(b=>b.id===g.target.id&&b.label===g.target.label);return!_||!v?(console.warn("Link refers to unknown node",g),[]):[{source:_,target:v,value:g.value,color:g.color,unit:g.unit,causesCycle:!1,cycleIndex:0,dy:0,sy:0,ty:0}]})}function j(){_r(m,p,e(Ae)),(t=>{var o=bt(t,2);h(u,o[0],!0),h(x,o[1],!0)})(St())}function $e(t,o){return g=>t*(1-g)+o*g}function Ie(t){if(t.causesCycle){let C=Fe,I=t.source.x+Pe,P=t.source.y+t.sy+t.dy,z=t.target.x,ie=t.target.y,ee=I+nt,ae=P,n=ee,E=-Ot-t.cycleIndex*(C+Rt),R=z-nt,A=R,oe=ie+t.ty+t.dy,Y=ae-t.dy,ne=oe-t.dy,te=Ue/2-Fe;return t.target.y>e(be)/2&&(E=e(be)-E,ae=t.source.y+t.sy,oe=t.target.y+t.ty,Y=ae+t.dy,ne=oe+t.dy,C=-Fe),`M${I},${ae}L${ee},${ae}C${ee+Ue},${ae} ${n+Ue},${E} ${n},${E}H${R-Fe}C${R-Ue},${E} ${A-Ue},${oe} ${A},${oe}H${z}V${ne}H${A}C${A-te},${ne} ${R-te},${E+C} ${R},${E+C}H${n-Fe}C${n+te},${E+C} ${ee+te},${ae-t.dy} ${ee},${Y}L${I},${Y}`}const o=t.source.x+Pe,g=t.target.x,v=$e(o,g)(.5),b=t.source.y+t.sy+t.dy/2,w=t.target.y+t.ty+t.dy/2;return`M${o},${b} C${v},${b} ${v},${w} ${g},${w}`}let Te=xe(()=>{if(!e(x).length)return 0;const t=Math.max(...e(x).map(o=>o.cycleIndex));return t==0?0:Ot+t*(Fe+Rt)}),Oe=xe(()=>e(u).length&&e(u).some(t=>t.x===0&&t.linksIn.length>0)?-nt-Fe-Ue:0),Re=xe(()=>{if(!e(u).length)return e(r);const t=Math.max(...e(u).map(o=>o.x+Pe));return e(u).some(o=>o.x===t&&o.linksOut.length>0)?t+nt+Fe+Ue-e(Oe):t-e(Oe)}),be=xe(()=>e(u).length?Math.max(...e(u).map(t=>t.y+t.dy)):d);function De(t){let o,g,_,v=/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/;const b=t.match(v);if(b)o=parseInt(b[1],10),g=parseInt(b[2],10),_=parseInt(b[3],10);else return!1;return .299*o+.587*g+.114*_<85}function s(){if(!e(i))return;const{width:t}=e(i).parentElement.getBoundingClientRect();h(r,t,!0),y()}it(s);let B=$(pe(yt.toString())),L=ar().scaleExtent([1,1/0]).on("zoom",t=>{h(B,t.transform.toString(),!0),Me()}).on("end",()=>{Me()});je(()=>{L=L.translateExtent([[e(Oe)-5,-e(Te)-5],[e(Re)+5,e(be)+e(Te)+5]])}),it(()=>{e(i)&&Ye(e(i)).call(L)});function H(){e(i)&&Ye(e(i)).call(L.transform,yt)}function V(t){const o=e(u).find(C=>C.label===t);if(!o||!e(i))return;const g=3*Pe+2*Lt+8,_=e(Re)/g,v=-(o.x+Pe/2)*_+e(Re)/2,b=-(o.y+o.dy/2)*_+e(be)/2,w=Ye(e(i));L.transform(w,yt.translate(v,b).scale(_))}let ue=Cr().on("start",function(){this.parentNode&&this.parentNode.appendChild(this)}).on("drag",function(t){const o=Number(this.dataset.idx);isNaN(o)||(we(t,o),Le(t))});je(()=>{e(u),e(i)&&Ye(e(i)).selectAll(".node").call(ue)});function we(t,o){if(t.clientY===0||o<0||o>=e(u).length)return;const g=e(u)[o].y+t.dy,_=Math.max(0,g);pr(o,_),(v=>{var b=bt(v,2);h(u,b[0],!0),h(x,b[1],!0)})(St())}let q=$(null);function Le(t){e(i)&&h(q,_t(t,e(i).parentElement),!0)}let he=$(null);function K(){e(i)&&h(he,e(i).getBoundingClientRect(),!0)}it(K);let M=xe(()=>{if(!e(q)||!e(i))return null;let[t,o]=e(q),g=e(i).getBoundingClientRect(),_=Ye(e(i)).selectAll(".node").nodes().findLast(b=>{let w=b.getBoundingClientRect(),C=w.left-g.left,I=w.top-g.top;return t>=C&&t<=C+w.width&&o>=I&&o<=I+w.height});if(!_)return null;let v=Number(_.dataset.idx);return isNaN(v)||v<0||v>=e(u).length?null:e(u)[v]}),Z=$(null);function Me(){if(e(M)===null||!e(i))return;const t=e(u).findIndex(g=>g===e(M));if(t===-1)return;const o=Ye(e(i)).selectAll(`.node[data-idx="${t}"]`).nodes()[0];o&&h(Z,o.getBoundingClientRect(),!0)}je(Me);let se=xe(()=>e(Z)===null||e(he)===null?0:e(Z).left-e(he).left+e(Z).width/2),de=xe(()=>e(Z)===null||e(he)===null?0:e(Z).top-e(he).top+e(Z).height/2),ke=xe(()=>e(Z)===null?0:e(Z).height/2),at=xe(()=>e(Z)===null||e(he)===null?!1:e(Z).top-e(he).top>d/2);function qe(t){return`${t.source.label} â†’ ${t.target.label}:
${t.value.toFixed(3)} ${t.unit}`}let Ae=$(!1);var Ke=Yr();dt("resize",wt,s),dt("scroll",wt,K);var Ze=ve(Ke),ot=S(Ze);ot.__click=H;var Je=F(ot,2);Je.__click=[Nr,Ae];var c=F(S(Je),2),J=S(c);N(c),N(Je),N(Ze);var ce=F(Ze,2),Ee=S(ce);{var k=t=>{var o=Or();et(o,21,()=>l.legendItems,tt,(g,_)=>{var v=Tr();v.__click=[$r,V,_],gt(v,"",{},{"font-size":"12px"});var b=S(v),w=S(b);N(b);var C=F(b,2),I=S(C,!0);N(C),N(v),Ne(()=>{W(w,"fill",e(_).color),me(I,e(_).carrier)}),D(g,v)}),N(o),D(t,o)};fe(Ee,t=>{l.legendItems&&l.legendItems.length>0&&t(k)})}N(ce);var le=F(ce,2),O=S(le);W(O,"height",d),O.__mousemove=Le;var ye=S(O),Q=S(ye);et(Q,21,()=>e(x).toSorted((t,o)=>o.value-t.value),tt,(t,o)=>{var g=Xe(),_=ve(g);{var v=w=>{var C=Rr();let I;var P=S(C),z=S(P,!0);N(P),N(C),Ne((ie,ee,ae)=>{W(C,"d",ie),I=gt(C,"",I,ee),me(z,ae)},[()=>Ie(e(o)),()=>({fill:e(o).color}),()=>qe(e(o))]),D(w,C)},b=w=>{var C=Sr();let I;var P=S(C),z=S(P,!0);N(P),N(C),Ne((ie,ee,ae)=>{W(C,"d",ie),I=gt(C,"",I,ee),me(z,ae)},[()=>Ie(e(o)),()=>({stroke:e(o).color,"stroke-width":Math.max(1,e(o).dy)}),()=>qe(e(o))]),D(w,C)};fe(_,w=>{e(o).causesCycle?w(v):w(b,!1)})}D(t,g)}),N(Q);var U=F(Q);et(U,21,()=>e(u),tt,(t,o,g)=>{var _=Br();W(_,"data-idx",g);var v=S(_),b=F(v),w=S(b);N(b),N(_),Ne((C,I)=>{W(v,"x",e(o).x),W(v,"y",e(o).y+.5),W(v,"width",Pe),W(v,"height",C),W(v,"fill",e(o).color),W(b,"x",e(o).x+Pe/2),W(b,"y",e(o).dy>16?e(o).y+e(o).dy/2:e(o).y-2),W(b,"dominant-baseline",e(o).dy>16?"middle":"auto"),W(b,"fill",I),me(w,`${e(o).label??""}
							${e(o).unitSuffix?` [${e(o).unit}]`:""}`)},[()=>Math.max(.1,e(o).dy-1),()=>e(o).dy>16&&De(e(o).color)?"#fff":"#000"]),D(t,_)}),N(U),N(ye),N(O),jt(O,t=>h(i,t),()=>e(i));var ge=F(O,2);{var X=t=>{or(t,{get x(){return e(se)},get y(){return e(de)},get yOffset(){return e(ke)},get isOnTop(){return e(at)},content:g=>{var _=Pr(),v=ve(_),b=S(v,!0);N(v);var w=F(v,2);{var C=z=>{var ie=Lr(),ee=F(S(ie),2);et(ee,17,()=>e(M).linksIn,tt,(E,R)=>{var A=Xe(),oe=ve(A);{var Y=ne=>{var te=Ir(),Ce=S(te),Se=S(Ce),We=S(Se);N(Se);var Be=F(Se);N(Ce);var Qe=F(Ce,2),ut=S(Qe);N(Qe),N(te),Ne(ct=>{W(We,"fill",e(x)[e(R)].source.color),me(Be,` ${e(x)[e(R)].source.label??""}:`),me(ut,`${ct??""}
										${e(x)[e(R)].unit??""}`)},[()=>e(x)[e(R)].value.toFixed(3)]),D(ne,te)};fe(oe,ne=>{e(x)[e(R)].value&&ne(Y)})}D(E,A)});var ae=F(ee,2);{var n=E=>{var R=Dr(),A=F(S(R),2),oe=S(A);N(A),N(R),Ne(Y=>me(oe,`${Y??""}
									${e(M).unit??""}`),[()=>Bt(e(M).linksIn.map(Y=>e(x)[Y]?.value||0)).toFixed(3)]),D(E,R)};fe(ae,E=>{e(M).showTotal&&e(M).linksIn.length>1&&E(n)})}N(ie),Ne(()=>Kt(ie,1,Zt([e(M).linksOut.length>0&&"border-bottom border-secondary pb-1"]))),D(z,ie)};fe(w,z=>{e(M).linksIn.length>0&&z(C)})}var I=F(w,2);{var P=z=>{var ie=Fr(),ee=F(ve(ie),2);et(ee,17,()=>e(M).linksOut,tt,(E,R)=>{var A=Xe(),oe=ve(A);{var Y=ne=>{var te=Mr(),Ce=S(te),Se=S(Ce),We=S(Se);N(Se);var Be=F(Se);N(Ce);var Qe=F(Ce,2),ut=S(Qe);N(Qe),N(te),Ne(ct=>{W(We,"fill",e(x)[e(R)].target.color),me(Be,` ${e(x)[e(R)].target.label??""}:`),me(ut,`${ct??""}
									${e(x)[e(R)].unit??""}`)},[()=>e(x)[e(R)].value.toFixed(3)]),D(ne,te)};fe(oe,ne=>{e(x)[e(R)].value&&ne(Y)})}D(E,A)});var ae=F(ee,2);{var n=E=>{var R=Ar(),A=F(S(R),2),oe=S(A);N(A),N(R),Ne(Y=>me(oe,`${Y??""}
								${e(M).unit??""}`),[()=>Bt(e(M).linksOut.map(Y=>e(x)[Y]?.value||0)).toFixed(3)]),D(E,R)};fe(ae,E=>{e(M).showTotal&&e(M).linksOut.length>1&&E(n)})}D(z,ie)};fe(I,z=>{e(M).linksOut.length>0&&z(P)})}Ne(()=>me(b,e(M).label)),D(g,_)},$$slots:{content:!0}})};fe(ge,t=>{e(M)!==null&&t(X)})}N(le),Ne(()=>{me(J,`Show only structure: ${e(Ae)?"On":"Off"}`),W(O,"id",f()),W(O,"width",e(r)),W(O,"viewBox",`${e(Oe)-1} ${-e(Te)} ${e(Re)+4} ${e(be)+2*e(Te)+20}`),W(ye,"transform",e(B))}),dt("mouseleave",O,()=>h(q,null)),D(a,Ke),Dt()}Jt(["click","mousemove"]);var Hr=re("<!> <!>",1),kr=re("<!> <!> <!>",1),Ur=re('<div class="text-center"><div class="spinner-border center" role="status"><span class="visually-hidden">Loading...</span></div></div>'),Xr=re('<div class="text-center">No solution selected</div>'),zr=re('<div class="text-center">No carriers selected</div>'),Wr=re('<div class="text-center">No nodes selected</div>'),Gr=re('<div class="text-center">No data available for the selected filters</div>'),Vr=re('<h1 class="mt-2 mb-4">The Energy System</h1> <!> <h2 class="visually-hidden">Sankey Diagram</h2> <div class="plot my-4"><!></div>',1);function ca(a,l){It(l,!0);let r=$(pe([])),d=$(!1),i=$(!1),f=$(null),y=$(pe([])),m=$(pe([])),p=$(null),u=null,x=null,T="",j="",$e="",Ie=$(null),Te=$(null),Oe=$(null),Re=$(null),be=$(null),De=$(null),s=$(null),B=$(null),L=$(null),H=$(null),V=$(null),ue=$(null),we=$(pe([])),q=$(pe([])),Le=$(pe([]));function he(){Me()}let K=$(pe([])),M=$(pe([])),Z=$(pe([]));je(()=>{if(!e(r).length){h(p,null);return}$e&&e(r).includes(Number($e))?h(p,$e,!0):h(p,e(r)[0].toString(),!0)}),je(()=>{e(p)&&($e=e(p))}),Nt(()=>e(K),()=>!!e(f),()=>T,()=>u,c=>h(y,c,!0),c=>T=c,c=>u=c),Nt(()=>e(M),()=>!!e(f),()=>j,()=>x,c=>h(m,c,!0),c=>j=c,c=>x=c),je(()=>{e(y),e(m),e(p),mt(()=>{at()})}),je(()=>{e(p),e(y),e(m),Ft().then(()=>{mt(()=>{Gt({year:e(p),car:e(y).map(c=>e(K).indexOf(c)).join("~")||null,nodes:e(m).map(c=>e(M).indexOf(c)).join("~")||null})})})}),it(()=>{h(p,Vt("year"),!0),u=Ct("car"),x=Ct("nodes")});async function Me(){if(!e(f))return;h(i,!0);let c=await Wt(e(f).solution_name,["flow_conversion_input","flow_conversion_output","flow_storage_charge","flow_storage_discharge","flow_import","flow_export","demand","shed_demand","flow_storage_inflow","flow_storage_spillage","flow_transport","flow_transport_loss"],e(f).scenario_name,"demand");h(Ie,_e.fromRows(c.flow_conversion_input?.data??[])),h(Te,_e.fromRows(c.flow_conversion_output?.data??[]),!0),h(Oe,_e.fromRows(c.flow_storage_charge?.data??[]),!0),h(Re,_e.fromRows(c.flow_storage_discharge?.data??[]),!0),h(be,_e.fromRows(c.flow_import?.data??[]),!0),h(De,_e.fromRows(c.flow_export?.data??[]),!0),h(s,_e.fromRows(c.demand?.data??[]),!0),h(B,_e.fromRows(c.shed_demand?.data??[]),!0),h(L,_e.fromRows(c.flow_storage_inflow?.data??[]),!0),h(H,_e.fromRows(c.flow_storage_spillage?.data??[]),!0),h(V,_e.fromRows(c.flow_transport?.data??[]),!0),h(ue,_e.fromRows(c.flow_transport_loss?.data??[]),!0),h(we,c.unit?.data||[],!0),h(i,!1),at()}function se(c){let J=e(we).find(ce=>ce.carrier===c)||{};return J[0]||J.units||""}function de(c){return e(f)&&e(f).detail.reference_carrier[c]||""}function ke(c){return e(f)?e(f).detail.system.set_technologies.filter(J=>{const ce=e(f)?.detail.carriers_input[J]||[],Ee=e(f)?.detail.carriers_output[J]||[],k=e(f)?.detail.reference_carrier[J];return[...ce,...Ee].some(le=>c.includes(le))||k&&c.includes(k)}):[]}function at(){if(!e(f)||!e(Ie)||!e(Te)||!e(Oe)||!e(Re)||!e(be)||!e(De)||!e(s)||!e(B)||!e(L)||!e(H)||!e(V)||!e(ue))return[];const c="rgb(180,180,180)",J=e(f)?.detail.system.set_storage_technologies||[],ce=e(f)?.detail.system.set_conversion_technologies||[],Ee=e(f)?.detail.system.set_transport_technologies||[];function k(n,E,R,A,oe=!1,Y=null,ne=!0,te=!1){return{id:n,label:E,color:R,unit:A,unitSuffix:oe,stickTo:Y,showTotal:ne,distinctRow:te}}kt();const le=[],O=e(K).map(n=>{const E=Ge(n);return le.push({color:E,carrier:n}),k(n,n,E,se(n),!0,null,!0,!0)}),ye=ce.map(n=>k(n,n,c,se(de(n)),!1,null,!1)),Q=J.map(n=>k(n,n,c,se(de(n)),!1,null,!1)),U=J.map(n=>k(n,n+"_inflow",c,se(de(n)))),ge=J.map(n=>k(n,n+"_spillage",c,se(de(n)),!1,null,!1));let X=Ge();const t=e(K).map(n=>k(n,n+" import",X,se(n),!0,"left"));X=Ge();const o=e(K).map(n=>k(n,n+" export",X,se(n),!0,"right"));X=Ge();const g=e(K).map(n=>k(n,n+" shed demand",X,se(n)));X=Ge();const _=e(K).map(n=>k(n,n+" demand",X,se(n),!0,"right"));X=Ge();const v=Ee.map(n=>k(n,n+" transport in",X,se(de(n)),!1,null,!1)),b=Ee.map(n=>k(n,n+" transport out",X,se(de(n)),!1,null,!1)),w={carrier:e(y),node:e(m),technology:ke(e(y))},C=e(r).indexOf(Number(e(p)));if(C===-1)return;const I=[];function P(n,E,R,A,oe=0){return Y=>{let ne=Y.data[C]-oe;Math.abs(ne)<5e-4&&(ne=0);const te=n.find(Be=>Be.id===Y.index[E]),Ce=R.find(Be=>Be.id===Y.index[A]);if(!te||!Ce){console.warn("Missing source or target node",{sourceNode:te,targetNode:Ce},{sourceId:E,targetId:A});return}let Se=c;const We=O.find(Be=>Be.id===Y.index.carrier);We&&(Se=We.color||c),I.push({source:te,target:Ce,value:ne,color:Se,unit:se(Y.index.carrier)})}}function z(n){const E=de(n.index.technology);E&&(n.index.carrier=E)}e(Ie).filterByCriteria(w).groupBy(["technology","carrier"]).forEach(P(O,"carrier",ye,"technology")),e(Te).filterByCriteria(w).groupBy(["technology","carrier"]).forEach(P(ye,"technology",O,"carrier")),e(Oe).filterByCriteria(w).groupBy(["technology"]).forEach(n=>{const E=de(n.index.technology);E&&(n.index.carrier=E)}).forEach(P(O,"carrier",Q,"technology")),e(Re).filterByCriteria(w).groupBy(["technology"]).forEach(z).forEach(P(Q,"technology",O,"carrier")),e(L).filterByCriteria(w).groupBy(["technology"]).forEach(z).forEach(P(U,"technology",Q,"technology")),e(H).filterByCriteria(w).groupBy(["technology"]).forEach(z).forEach(P(Q,"technology",ge,"technology")),e(be).filterByCriteria(w).groupBy(["carrier"]).forEach(P(t,"carrier",O,"carrier")),e(De).filterByCriteria(w).groupBy(["carrier"]).forEach(P(O,"carrier",o,"carrier"));const ie=e(B).filterByCriteria(w).groupBy(["carrier"]);ie.forEach(P(g,"carrier",_,"carrier")),e(s).filterByCriteria(w).groupBy(["carrier"]).forEach(n=>{const E=ie.find(A=>A.index.carrier===n.index.carrier),R=E?E.data[C]:0;P(O,"carrier",_,"carrier",R)(n)});const ee=Et(e(f).detail.edges,e(m),!0),ae=e(ue).filterByCriteria({...w,edge:ee}).groupBy(["technology"]);e(V).filterByCriteria({...w,edge:ee}).groupBy(["technology"]).forEach(z).forEach(n=>{const E=ae.find(A=>A.index.technology===n.index.technology),R=E?E.data[C]:0;P(v,"technology",O,"carrier",R)(n)}),e(V).filterByCriteria({...w,edge:Et(e(f).detail.edges,e(m),!1)}).groupBy(["technology"]).forEach(z).forEach(P(O,"carrier",b,"technology")),h(q,[...O,...ye,...Q,...U,...ge,...t,...o,...g,..._,...v,...b],!0),h(Le,I,!0),h(Z,le,!0)}var qe=Vr(),Ae=F(ve(qe),2);Ht(Ae,{children:(c,J)=>{var ce=kr(),Ee=ve(ce);ft(Ee,{title:"Solution Selection",children:(O,ye)=>{{let Q=xe(()=>e(i)||e(d));Ut(O,{solutionSelected:he,get disabled(){return e(Q)},get years(){return e(r)},set years(U){h(r,U,!0)},get selected_solution(){return e(f)},set selected_solution(U){h(f,U,!0)},get carriers(){return e(K)},set carriers(U){h(K,U,!0)},get nodes(){return e(M)},set nodes(U){h(M,U,!0)},get loading(){return e(d)},set loading(U){h(d,U,!0)}})}}});var k=F(Ee,2);ft(k,{title:"Carrier Selection",children:(O,ye)=>{$t(O,{label:"Carriers",get elements(){return e(K)},get value(){return e(y)},set value(Q){h(y,Q,!0)}})}});var le=F(k,2);ft(le,{title:"Data Selection",children:(O,ye)=>{var Q=Hr(),U=ve(Q);Xt(U,{label:"Year",content:(t,o=Pt)=>{{let g=xe(()=>zt(e(r).map(v=>v.toString()))),_=xe(()=>e(i)||e(d));qt(t,{get formId(){return o()},get options(){return e(g)},get disabled(){return e(_)},get value(){return e(p)},set value(v){h(p,v,!0)}})}}});var ge=F(U,2);$t(ge,{label:"Nodes",get elements(){return e(M)},get value(){return e(m)},set value(X){h(m,X,!0)}}),D(O,Q)}}),D(c,ce)}});var Ke=F(Ae,4),Ze=S(Ke);{var ot=c=>{var J=Ur();D(c,J)},Je=c=>{var J=Xe(),ce=ve(J);{var Ee=le=>{var O=Xr();D(le,O)},k=le=>{var O=Xe(),ye=ve(O);{var Q=ge=>{var X=zr();D(ge,X)},U=ge=>{var X=Xe(),t=ve(X);{var o=_=>{var v=Wr();D(_,v)},g=_=>{var v=Xe(),b=ve(v);{var w=I=>{var P=Gr();D(I,P)},C=I=>{jr(I,{get nodes(){return e(q)},get links(){return e(Le)},get legendItems(){return e(Z)}})};fe(b,I=>{e(q).length===0?I(w):I(C,!1)},!0)}D(_,v)};fe(t,_=>{e(m).length===0?_(o):_(g,!1)},!0)}D(ge,X)};fe(ye,ge=>{e(y).length===0?ge(Q):ge(U,!1)},!0)}D(le,O)};fe(ce,le=>{e(f)?le(k,!1):le(Ee)},!0)}D(c,J)};fe(Ze,c=>{e(d)||e(i)?c(ot):c(Je,!1)})}N(Ke),D(a,qe),Dt()}export{ca as component};
