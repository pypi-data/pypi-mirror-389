<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }} - Graph View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Exo+2:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      {% set colors = theme_colors %}
      /* Command Palette Styles */
      .backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      }
      .backdrop.show {
      opacity: 1;
      visibility: visible;
      }
      .command-palette {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%) scale(0.9);
      background: {{ colors.bg_secondary }};
      border: 1px solid {{ colors.border }};
      border-radius: 12px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.25);
      width: 90%;
      max-width: 600px;
      z-index: 10001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      }
      .command-palette.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) scale(1);
      }
      .command-header {
      padding: 20px;
      border-bottom: 1px solid {{ colors.border }};
      display: flex;
      align-items: center;
      gap: 12px;
      }
      .command-input {
      background: none;
      border: none;
      color: {{ colors.text_primary }};
      font-size: 1.1em;
      flex: 1;
      outline: none;
      font-family: 'Exo 2', sans-serif;
      }
      .command-input::placeholder {
      color: {{ colors.text_secondary }};
      }
      .command-shortcut {
      background: {{ colors.bg_primary }};
      color: {{ colors.text_secondary }};
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.8em;
      font-family: monospace;
      }
      .command-list {
      max-height: 400px;
      overflow-y: auto;
      }
      .command-item {
      padding: 16px 20px;
      border-bottom: 1px solid {{ colors.border }};
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background 0.2s ease;
      }
      .command-item:hover,
      .command-item.selected {
      background: {{ colors.bg_tertiary }};
      }
      .command-item:last-child {
      border-bottom: none;
      }
      .command-icon {
      width: 20px;
      text-align: center;
      color: {{ colors.accent }};
      }
      .command-content {
      flex: 1;
      }
      .command-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: {{ colors.text_primary }};
      }
      .command-description {
      font-size: 0.85em;
      color: {{ colors.text_secondary }};
      }
      .command-shortcut-item {
      background: {{ colors.bg_primary }};
      color: {{ colors.text_secondary }};
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.8em;
      font-family: monospace;
      }
      /* Toast Notifications */
      .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
      pointer-events: none;
      }
      .toast {
      background: {{ colors.bg_secondary }};
      border: 1px solid {{ colors.border }};
      border-left: 4px solid {{ colors.accent }};
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      transform: translateX(400px);
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      pointer-events: auto;
      }
      .toast.show {
      transform: translateX(0);
      }
      .toast.success { border-left-color: {{ colors.success }}; }
      .toast.error { border-left-color: {{ colors.danger }}; }
      .toast.warning { border-left-color: {{ colors.warning }}; }
      .toast.info { border-left-color: {{ colors.info }}; }
      .toast-icon {
      font-size: 1.2em;
      color: {{ colors.accent }};
      }
      .toast.success .toast-icon { color: {{ colors.success }}; }
      .toast.error .toast-icon { color: {{ colors.danger }}; }
      .toast.warning .toast-icon { color: {{ colors.warning }}; }
      .toast.info .toast-icon { color: {{ colors.info }}; }
      .toast-content {
      flex: 1;
      }
      .toast-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: {{ colors.text_primary }};
      }
      .toast-message {
      font-size: 0.9em;
      color: {{ colors.text_secondary }};
      }
      .toast-close {
      background: none;
      border: none;
      color: {{ colors.text_secondary }};
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
      }
      .toast-close:hover {
      background: {{ colors.bg_tertiary }};
      color: {{ colors.text_primary }};
      }
      /* Quick Action Bar */
      .quick-actions {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: {{ colors.bg_secondary }}d0;
      border: 1px solid {{ colors.border }};
      border-radius: 50px;
      padding: 12px 20px;
      display: flex;
      gap: 8px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      z-index: 9999;
      backdrop-filter: blur(10px);
      }
      .quick-action {
      background: {{ colors.bg_primary }};
      border: 1px solid {{ colors.border }};
      color: {{ colors.text_primary }};
      padding: 12px 16px;
      border-radius: 25px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      font-size: 0.9em;
      font-weight: 500;
      }
      .quick-action:hover {
      background: {{ colors.accent }};
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px {{ colors.accent }};
      }
      .quick-action:active {
      transform: translateY(0);
      }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
      font-family: 'Exo 2', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: {{ colors.bg_primary }};
      color: {{ colors.text_primary }};
      overflow: hidden;
      }
      #graph-container {
      width: 100vw;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: {{ colors.bg_primary }};
      overflow: hidden;
      }
      /* --- ENHANCED GRID BACKGROUND --- */
      #grid-pattern {
      fill: url(#grid);
      }
      /* --- WATERMARK --- */
        #watermark {
        position: absolute;
        bottom: 16px;
        left: 20px;
        font-size: 0.75em;
        color: {{ colors.text_secondary }}80;
        user-select: none;
        z-index: 1000;
        font-family: 'Exo 2', sans-serif;
        }

        .watermark-content {
        display: flex;
        align-items: center;
        gap: 20px;
        background: {{ colors.bg_secondary }}60;
        backdrop-filter: blur(8px);
        border: 1px solid {{ colors.border }}20;
        border-radius: 12px;
        padding: 12px 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .watermark-content:hover {
        background: {{ colors.bg_secondary }}80;
        border-color: {{ colors.accent }}30;
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }

        .watermark-brand {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: {{ colors.text_primary }};
        }

        .watermark-brand i {
        color: {{ colors.accent }};
        font-size: 1.1em;
        filter: drop-shadow(0 2px 4px {{ colors.accent }}30);
        }

        .brand-text {
        font-family: 'Orbitron', sans-serif;
        letter-spacing: 0.5px;
        background: linear-gradient(135deg, {{ colors.text_primary }} 0%, {{ colors.accent }} 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        }

        .version {
        font-size: 0.85em;
        color: {{ colors.text_secondary }};
        background: {{ colors.bg_primary }}30;
        padding: 2px 8px;
        border-radius: 8px;
        border: 1px solid {{ colors.border }}20;
        font-family: 'Exo 2', monospace;
        }

        .watermark-links {
        display: flex;
        align-items: center;
        gap: 12px;
        }

        .watermark-link {
        display: flex;
        align-items: center;
        gap: 6px;
        color: {{ colors.text_secondary }} !important;
        text-decoration: none;
        padding: 6px 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
        border: 1px solid transparent;
        }

        .watermark-link:hover {
        color: {{ colors.accent }} !important;
        background: {{ colors.accent }}15;
        border-color: {{ colors.accent }}20;
        transform: translateY(-1px);
        text-decoration: none !important;
        }

        .watermark-link i {
        font-size: 0.9em;
        transition: all 0.3s ease;
        }

        .watermark-link:hover i {
        transform: scale(1.1);
        filter: drop-shadow(0 2px 4px {{ colors.accent }}30);
        }

        /* Pulse animation for brand icon */
        @keyframes pulse-glow {
        0%, 100% { 
            opacity: 1;
            filter: drop-shadow(0 2px 4px {{ colors.accent }}30);
        }
        50% { 
            opacity: 0.8;
            filter: drop-shadow(0 2px 8px {{ colors.accent }}50);
        }
        }

        .watermark-brand i {
        animation: pulse-glow 3s ease-in-out infinite;
        }

        .watermark-content:hover .watermark-brand i {
        animation: pulse-glow 1s ease-in-out infinite;
        }

        /* Responsive design */
        @media (max-width: 768px) {
        .watermark-content {
            flex-direction: column;
            gap: 12px;
            padding: 16px;
        }
        
        .watermark-links {
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }
        
        .watermark-link {
            justify-content: center;
            padding: 8px 12px;
        }
        
        #watermark {
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 300px;
        }
        }

        /* Optional: Add a subtle background pattern */
        .watermark-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 12px;
        background: linear-gradient(135deg, transparent 0%, {{ colors.accent }}02 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: -1;
        }

        .watermark-content:hover::before {
        opacity: 1;
        }
      /* --- MODERN DASHBOARD HUD --- */
      .dashboard-hud {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      font-family: 'Exo 2', sans-serif;
      width: 320px;
      opacity: 0.95;
      transition: opacity 0.3s ease;
      }
      .dashboard-hud:hover {
      opacity: 1;
      }
      .info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
      }
      .info-card {
      background: {{ colors.bg_secondary }}90;
      backdrop-filter: blur(8px);
      border: 1px solid {{ colors.border }}20;
      padding: 16px;
      border-radius: 8px;
      transition: all 0.2s ease;
      text-align: center;
      }
      .info-card:hover {
      background: {{ colors.bg_secondary }};
      border-color: {{ colors.accent }}30;
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      }
      .info-value {
      font-size: 1.8em;
      font-weight: 600;
      color: {{ colors.text_primary }};
      font-family: 'Orbitron', sans-serif;
      line-height: 1;
      margin-bottom: 6px;
      }
      .info-label {
      font-size: 0.75em;
      color: {{ colors.text_secondary }};
      letter-spacing: 0.5px;
      text-transform: uppercase;
      }
      .state-section {
      background: {{ colors.bg_secondary }}80;
      backdrop-filter: blur(8px);
      border: 1px solid {{ colors.border }}20;
      border-radius: 12px;
      padding: 20px;
      margin-top: 12px;
      }
      .state-title {
      font-size: 0.75em;
      color: {{ colors.text_secondary }};
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      }
      .state-flow {
      display: flex;
      flex-direction: column;
      gap: 12px;
      }
      .state-item {
      background: {{ colors.bg_primary }}08;
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      }
      .state-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      transition: all 0.2s ease;
      }
      .state-item:hover {
      transform: translateX(4px);
      background: {{ colors.bg_primary }}12;
      }
      .state-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      }
      .state-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 0.85em;
      color: {{ colors.text_primary }};
      }
      .state-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9em;
      }
      .state-count {
      font-family: 'Orbitron', sans-serif;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      background: {{ colors.bg_primary }}15;
      color: {{ colors.text_primary }};
      }
      .state-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-left: 32px;
      }
      .state-metric {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75em;
      color: {{ colors.text_secondary }};
      }
      .state-metric i {
      font-size: 0.9em;
      opacity: 0.7;
      }
      /* State-specific styles */
      /* State indicator hover effects */
      .state-item {
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      }
      .state-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      opacity: 0;
      transition: opacity 0.2s ease;
      }
      .state-item:hover {
      transform: translateX(4px);
      background: {{ colors.bg_primary }}12;
      }
      .state-item:hover::before {
      opacity: 1;
      }
      .state-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.2s ease;
      }
      .state-count {
      padding: 4px 12px;
      border-radius: 12px;
      font-family: 'Orbitron', sans-serif;
      font-weight: 600;
      transition: all 0.2s ease;
      }
      .state-item:hover .state-icon {
      transform: scale(1.1);
      }
      .state-item:hover .state-count {
      transform: scale(1.05);
      }
      /* Enhanced state styles for all states */
      .state-external_data {
      background: linear-gradient(135deg, #a855f720, #a855f710);
      color: #a855f7;
      border-color: #a855f740;
      }
      .state-integrated {
      background: linear-gradient(135deg, #84cc1620, #84cc1610);
      color: #84cc16;
      border-color: #84cc1640;
      }
      .state-active {
      background: linear-gradient(135deg, #22c55e20, #22c55e10);
      color: #22c55e;
      border-color: #22c55e40;
      }
      .state-input {
      background: linear-gradient(135deg, #3b82f620, #3b82f610);
      color: #3b82f6;
      border-color: #3b82f640;
      }
      .state-orphaned {
      background: linear-gradient(135deg, #fb923c20, #fb923c10);
      color: #fb923c;
      border-color: #fb923c40;
      }
      .state-configuration {
      background: linear-gradient(135deg, #8b5cf620, #8b5cf610);
      color: #8b5cf6;
      border-color: #8b5cf640;
      }
      .state-unused {
      background: linear-gradient(135deg, #f59e0b20, #f59e0b10);
      color: #f59e0b;
      border-color: #f59e0b40;
      }
      .state-incomplete {
      background: linear-gradient(135deg, #ef444420, #ef444410);
      color: #ef4444;
      border-color: #ef444440;
      }
      .controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: {{ colors.bg_secondary }}d0;
      border: 1px solid {{ colors.border }};
      border-radius: 12px;
      padding: 12px 20px;
      display: flex;
      gap: 8px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 1000;
      }
      .control-btn {
      background: {{ colors.bg_primary }};
      border: 1px solid {{ colors.border }};
      color: {{ colors.text_primary }};
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      }
      .control-btn:hover {
      background: {{ colors.accent }};
      border-color: {{ colors.accent }};
      color: {{ colors.bg_primary }};
      transform: translateY(-1px);
      }
      .control-btn:active {
      transform: translateY(0);
      }
        /* Configuration Viewer - Updated to match Dashboard HUD */
        .config-viewer {
        position: absolute;
        top: 20px;
        left: 360px;
        background: {{ colors.bg_secondary }}d0;
        backdrop-filter: blur(8px);
        border: 1px solid {{ colors.border }}20;
        border-radius: 12px;
        z-index: 1000;
        width: 300px;
        max-height: calc(100vh - 40px);
        overflow: hidden;
        transition: all 0.2s ease;
        font-family: 'Exo 2', sans-serif;
        opacity: 0.95;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .config-viewer:hover {
        opacity: 1;
        background: {{ colors.bg_secondary }};
        border-color: {{ colors.accent }}30;
        transform: translateY(-1px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }

        .config-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 15px;
        cursor: pointer;
        user-select: none;
        border-bottom: 1px solid {{ colors.border }}20;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        }

        .config-header:hover {
        background: {{ colors.bg_primary }}08;
        }

        .config-icon-wrapper {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        background: linear-gradient(135deg, {{ colors.accent }}20 0%, {{ colors.accent }}10 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        flex-shrink: 0;
        transition: all 0.2s ease;
        }

        .config-header:hover .config-icon-wrapper {
        transform: scale(1.05);
        box-shadow: 0 4px 16px {{ colors.accent }}20;
        }

        .config-icon-wrapper i {
        color: {{ colors.accent }};
        font-size: 1.4em;
        }

        .config-header-content {
        flex: 1;
        min-width: 0;
        }

        .config-title {
        color: {{ colors.text_primary }};
        font-size: 1.1em;
        font-weight: 700;
        font-family: 'Orbitron', sans-serif;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
        }

        .config-subtitle {
        font-size: 0.8em;
        color: {{ colors.text_secondary }};
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
        }

        .config-subtitle span {
        color: {{ colors.accent }};
        font-weight: 700;
        font-family: 'Orbitron', sans-serif;
        }

        .config-toggle {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: {{ colors.bg_primary }}20;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s ease;
        }

        .config-header:hover .config-toggle {
        background: {{ colors.accent }}15;
        transform: scale(1.1);
        }

        .config-chevron {
        color: {{ colors.text_secondary }};
        transition: all 0.2s ease;
        font-size: 0.9em;
        }

        .config-toggle:hover .config-chevron {
        color: {{ colors.accent }};
        }

        .config-chevron.rotated {
        transform: rotate(180deg);
        color: {{ colors.accent }};
        }

        .config-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        }

        .config-content.expanded {
        max-height: calc(100vh - 140px);
        overflow-y: auto;
        }

        /* Config File Item */
        .config-file {
        border-bottom: 1px solid {{ colors.border }}10;
        transition: all 0.2s ease;
        }

        .config-file:last-child {
        border-bottom: none;
        }

        .config-file-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
        position: relative;
        }

        .config-file-header:hover {
        background: {{ colors.bg_primary }}08;
        transform: translateX(4px);
        }

        .config-file-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: linear-gradient(135deg, {{ colors.info }}20 0%, {{ colors.info }}10 100%);
        color: {{ colors.info }};
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
        flex-shrink: 0;
        transition: all 0.2s ease;
        }

        .config-file-header:hover .config-file-icon {
        transform: scale(1.1);
        box-shadow: 0 4px 12px {{ colors.info }}20;
        }

        .config-file-info {
        flex: 1;
        min-width: 0;
        }

        .config-file-name {
        font-weight: 700;
        color: {{ colors.text_primary }};
        font-size: 0.9em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 4px;
        font-family: 'Exo 2', monospace;
        }

        .config-file-path {
        font-size: 0.75em;
        color: {{ colors.text_secondary }};
        display: flex;
        align-items: center;
        gap: 6px;
        }

        .config-file-path i {
        font-size: 0.9em;
        color: {{ colors.accent }};
        }

        .config-file-chevron {
        color: {{ colors.text_secondary }};
        transition: all 0.2s ease;
        font-size: 0.85em;
        flex-shrink: 0;
        }

        .config-file-header:hover .config-file-chevron {
        color: {{ colors.accent }};
        }

        .config-file-chevron.rotated {
        transform: rotate(90deg);
        color: {{ colors.accent }};
        }

        .config-file-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: {{ colors.bg_primary }}05;
        }

        .config-file-body.expanded {
        max-height: 500px;
        overflow-y: auto;
        }

        .config-variables {
        padding: 16px 20px;
        display: grid;
        gap: 12px;
        }

        /* Variable Card */
        .config-var {
        background: {{ colors.bg_secondary }}60;
        border: 1px solid {{ colors.border }}20;
        border-left: 3px solid {{ colors.accent }}50;
        border-radius: 8px;
        padding: 12px 16px;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        }

        .config-var:hover {
        background: {{ colors.bg_secondary }}80;
        border-left-color: {{ colors.accent }};
        border-color: {{ colors.accent }}30;
        transform: translateX(4px);
        box-shadow: 0 4px 12px {{ colors.accent }}10;
        }

        .config-var-key {
        font-family: 'Exo 2', monospace;
        font-size: 0.85em;
        font-weight: 700;
        color: {{ colors.text_primary }};
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        }

        .config-var-key i {
        font-size: 0.85em;
        color: {{ colors.accent }};
        }

        .config-var-value {
        font-family: 'Exo 2', monospace;
        font-size: 0.8em;
        color: {{ colors.text_secondary }};
        padding: 8px 12px;
        background: {{ colors.bg_primary }}30;
        border-radius: 6px;
        word-break: break-word;
        white-space: pre-wrap;
        border: 1px solid {{ colors.border }}10;
        line-height: 1.6;
        }

        .config-var-type {
        display: inline-flex;
        align-items: center;
        font-size: 0.7em;
        padding: 3px 8px;
        border-radius: 6px;
        background: {{ colors.accent }}15;
        color: {{ colors.accent }};
        margin-left: auto;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid {{ colors.accent }}20;
        }

        /* Type-specific colors */
        .config-var-type.type-string {
        background: {{ colors.success }}15;
        color: {{ colors.success }};
        border-color: {{ colors.success }}20;
        }

        .config-var-type.type-number {
        background: {{ colors.info }}15;
        color: {{ colors.info }};
        border-color: {{ colors.info }}20;
        }

        .config-var-type.type-boolean {
        background: {{ colors.warning }}15;
        color: {{ colors.warning }};
        border-color: {{ colors.warning }}20;
        }

        .config-var-type.type-object {
        background: {{ colors.accent }}15;
        color: {{ colors.accent }};
        border-color: {{ colors.accent }}20;
        }

        .config-var-type.type-array {
        background: #8b5cf615;
        color: #8b5cf6;
        border-color: #8b5cf620;
        }

        /* Empty State */
        .config-empty {
        padding: 60px 30px;
        text-align: center;
        color: {{ colors.text_secondary }};
        }

        .config-empty i {
        font-size: 3em;
        color: {{ colors.text_secondary }}30;
        margin-bottom: 16px;
        display: block;
        opacity: 0.5;
        }

        .config-empty div {
        font-size: 0.9em;
        font-weight: 500;
        }

        /* Custom scrollbar */
        .config-content::-webkit-scrollbar,
        .config-file-body::-webkit-scrollbar {
        width: 6px;
        }

        .config-content::-webkit-scrollbar-track,
        .config-file-body::-webkit-scrollbar-track {
        background: {{ colors.bg_primary }}15;
        border-radius: 3px;
        }

        .config-content::-webkit-scrollbar-thumb,
        .config-file-body::-webkit-scrollbar-thumb {
        background: {{ colors.accent }}30;
        border-radius: 3px;
        transition: background 0.2s ease;
        }

        .config-content::-webkit-scrollbar-thumb:hover,
        .config-file-body::-webkit-scrollbar-thumb:hover {
        background: {{ colors.accent }}50;
        }

        /* Responsive */
        @media (max-width: 768px) {
        .config-viewer {
            left: 20px;
            top: auto;
            bottom: 100px;
            width: calc(100% - 40px);
            max-width: 420px;
        }
        }
      .scale-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: {{ colors.bg_secondary }}d0;
      border: 1px solid {{ colors.border }};
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 1000;
      }
      .scale-btn {
      background: {{ colors.bg_primary }};
      border: 1px solid {{ colors.border }};
      color: {{ colors.text_primary }};
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      transition: all 0.2s ease;
      }
      .scale-btn:hover {
      background: {{ colors.accent }};
      border-color: {{ colors.accent }};
      color: {{ colors.bg_primary }};
      transform: translateY(-1px);
      }
      .scale-btn:active {
      transform: translateY(0);
      }
      /* --- ENHANCED ANALYTICAL LEGEND --- */
      .legend {
      position: absolute;
      top: 20px;
      right: 20px;
      background: {{ colors.bg_secondary }}d0;
      border: 1px solid {{ colors.border }};
      border-radius: 12px;
      padding: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 1000;
      width: 320px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      transition: all 0.3s ease;
      font-family: 'Exo 2', sans-serif;
      }
      .legend-header {
      display: flex;
      align-items: center;
      gap: 10px;
      color: {{ colors.text_primary }};
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 16px;
      font-family: 'Orbitron', sans-serif;
      letter-spacing: 0.5px;
      }
      .legend-header i {
      color: {{ colors.accent }};
      font-size: 1.2em;
      }
      .legend-section {
      background: {{ colors.bg_primary }}08;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      }
      .legend-section-title {
      font-size: 0.85em;
      color: {{ colors.text_secondary }};
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      margin-bottom: 12px;
      }
      .legend-section-title i {
      color: {{ colors.accent }};
      }
      .legend-section-title:hover {
      color: {{ colors.text_primary }};
      }
      /* Metric Cards */
      .metric-card {
      background: {{ colors.bg_primary }}10;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      transition: all 0.2s ease;
      }
      .metric-card:hover {
      background: {{ colors.bg_primary }}15;
      transform: translateY(-2px);
      }
      .metric-value {
      font-size: 1.8em;
      font-weight: 700;
      color: {{ colors.text_primary }};
      font-family: 'Orbitron', sans-serif;
      line-height: 1;
      margin-bottom: 4px;
      }
      .metric-label {
      font-size: 0.7em;
      color: {{ colors.text_secondary }};
      text-transform: uppercase;
      letter-spacing: 0.5px;
      }
      #metrics-section {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      }
      /* Analysis Rows */
      .analysis-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: {{ colors.bg_primary }}08;
      margin-bottom: 8px;
      }
      .analysis-row:hover {
      background: {{ colors.bg_primary }}15;
      transform: translateX(4px);
      }
      .analysis-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: {{ colors.accent }}15;
      color: {{ colors.accent }};
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1em;
      }
      .analysis-content {
      flex: 1;
      }
      .analysis-title {
      font-weight: 600;
      color: {{ colors.text_primary }};
      font-size: 0.9em;
      margin-bottom: 2px;
      }
      .analysis-desc {
      font-size: 0.75em;
      color: {{ colors.text_secondary }};
      }
      .analysis-action {
      color: {{ colors.text_secondary }};
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
      }
      .analysis-row:hover .analysis-action {
      color: {{ colors.accent }};
      background: {{ colors.accent }}15;
      }
      /* Filter Chips */
      .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      }
      .filter-chip {
      background: {{ colors.bg_primary }}10;
      border: 1px solid {{ colors.border }}40;
      color: {{ colors.text_secondary }};
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      }
      .filter-chip:hover {
      background: {{ colors.accent }}15;
      border-color: {{ colors.accent }}40;
      color: {{ colors.accent }};
      transform: translateY(-1px);
      }
      .filter-chip i {
      font-size: 0.9em;
      }
      .node {
      cursor: pointer;
      }
      .node-shape {
      transition: all 0.3s ease;
      stroke-width: 2px;
      stroke-dasharray: none;
      fill-opacity: 0.9;
      }
      .node-shape.module {
      stroke-dasharray: 3,2;
      }
      .node-shape.resource {
      filter: url(#resource-glow);
      }
      .node text {
      font-size: 10px;
      fill: {{ colors.text_primary }};
      text-shadow: 0 1px 3px {{ colors.bg_primary }},
      0 2px 6px rgba(0,0,0,0.3);
      pointer-events: none;
      font-weight: 500;
      transition: all 0.3s ease;
      letter-spacing: 0.02em;
      }
      .node-icon {
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      font-size: 10px;
      fill: {{ colors.bg_primary }};
      pointer-events: none;
      text-anchor: middle;
      dominant-baseline: central;
      text-rendering: optimizeLegibility;
      }
      .node text.node-icon {
      font-family: "Font Awesome 6 Free", sans-serif;
      font-weight: 900;
      fill: {{ colors.bg_primary }};
      }
      .node:hover circle {
      stroke-width: 3px;
      filter: drop-shadow(0 0 8px currentColor);
      }
      .node:hover text {
      font-weight: 600;
      }
      @keyframes flowAnimation {
      to {
      stroke-dashoffset: -20;
      }
      }
      .link {
      stroke: {{ colors.text_secondary }}40;
      stroke-opacity: 0.4;
      stroke-width: 1.5;
      transition: all 0.3s ease;
      stroke-linecap: round;
      }
      .link.highlight {
      stroke: {{ colors.accent }};
      stroke-opacity: 0.8;
      stroke-width: 2;
      stroke-dasharray: 5, 8;
      animation: flowAnimation 1.5s linear infinite;
      }
      .link-arrow {
      fill: none;
      stroke: {{ colors.text_secondary }};
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      }
      /* --- ENHANCED TOOLTIP - MULTI-THEME SUPPORT --- */
      .node-tooltip {
      position: absolute;
      background: linear-gradient(135deg, {{ colors.bg_secondary }}ee 0%, {{ colors.bg_tertiary }}dd 100%);
      border: 1px solid {{ colors.accent }}60;
      backdrop-filter: blur(12px) saturate(180%);
      box-shadow:
      0 0 25px {{ colors.accent }}20,
      0 8px 40px rgba(0,0,0,0.3),
      inset 0 1px 0 {{ colors.accent }}15;
      font-family: 'Exo 2', monospace;
      border-radius: 12px;
      padding: 16px;
      font-size: 0.85em;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 1001;
      max-width: 320px;
      transform: translateY(10px);
      }
      .node-tooltip.show {
      opacity: 1;
      transform: translateY(0);
      }
      .node-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
      }
      .node-info-title {
      font-weight: 700;
      color: {{ colors.accent }};
      margin-bottom: 8px;
      font-size: 1.1em;
      border-bottom: 1px solid {{ colors.accent }}30;
      padding-bottom: 6px;
      font-family: 'Orbitron', sans-serif;
      letter-spacing: 0.5px;
      }
      .node-info-dep {
      font-size: 0.8em;
      color: {{ colors.text_secondary }};
      display: flex;
      align-items: center;
      gap: 4px;
      }
      .node-state {
      font-size: 0.75em;
      padding: 4px 8px;
      border-radius: 6px;
      margin-top: 8px;
      display: inline-block;
      width: fit-content;
      font-weight: 600;
      border: 1px solid;
      background: {{ colors.bg_primary }}20;
      }
      /* Theme-specific state colors in tooltip */
      .node-state.external_data { color: #a855f7; border-color: #a855f740; background: #a855f715; }
      .node-state.integrated { color: #84cc16; border-color: #84cc1640; background: #84cc1615; }
      .node-state.active { color: #22c55e; border-color: #22c55e40; background: #22c55e15; }
      .node-state.input { color: #3b82f6; border-color: #3b82f640; background: #3b82f615; }
      .node-state.orphaned { color: #fb923c; border-color: #fb923c40; background: #fb923c15; }
      .node-state.configuration { color: #8b5cf6; border-color: #8b5cf640; background: #8b5cf615; }
      .node-state.unused { color: #f59e0b; border-color: #f59e0b40; background: #f59e0b15; }
      .node-state.incomplete { color: #ef4444; border-color: #ef444440; background: #ef444415; }
      .tooltip-stat {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid {{ colors.border }}40;
      font-size: 0.9em;
      }
      .tooltip-stat span:first-child {
      color: {{ colors.text_secondary }};
      font-weight: 500;
      }
      .tooltip-stat span:last-child {
      color: {{ colors.text_primary }};
      font-weight: 600;
      }
      .tooltip-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid {{ colors.border }}30;
      }
      .tooltip-label {
      font-size: 0.75em;
      color: {{ colors.text_secondary }};
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      }
      .tooltip-value {
      font-size: 0.85em;
      color: {{ colors.text_primary }};
      font-family: 'Exo 2', monospace;
      }
      .badge-incoming, .badge-outgoing, .badge-references {
      font-size: 0.85em;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
      font-family: 'Exo 2', sans-serif;
      }
      .badge-incoming {
      background: {{ colors.success }}20;
      color: {{ colors.success }};
      }
      .badge-outgoing {
      background: {{ colors.warning }}20;
      color: {{ colors.warning }};
      }
      .badge-references {
      background: {{ colors.info }}20;
      color: {{ colors.info }};
      }
      .source-file {
      font-family: 'Exo 2', monospace;
      font-size: 0.85em;
      color: {{ colors.accent }};
      }
      .source-line {
      font-family: monospace;
      background: {{ colors.bg_primary }}40;
      padding: 1px 4px;
      border-radius: 4px;
      color: {{ colors.text_primary }};
      }
      .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
      }
      .node-tag {
      font-size: 0.75em;
      padding: 2px 8px;
      border-radius: 12px;
      background: {{ colors.bg_primary }}30;
      color: {{ colors.text_secondary }};
      border: 1px solid {{ colors.border }}40;
      }
      .tooltip-icon {
      margin-right: 4px;
      color: {{ colors.accent }};
      }
      /* Performance optimizations */
      .performance-optimized {
      transform: translate3d(0, 0, 0);
      backface-visibility: hidden;
      perspective: 1000px;
      }
      /* Responsive design */
      @media (max-width: 768px) {
      .nexus-hud, .legend {
      min-width: 200px;
      padding: 16px;
      }
      .controls {
      flex-wrap: wrap;
      justify-content: center;
      }
      .node-tooltip {
      max-width: 280px;
      font-size: 0.8em;
      padding: 12px;
      }
      }
    </style>
  </head>
  <body>
    <!-- Backdrop -->
    <div class="backdrop" id="backdrop"></div>
    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>
    <!-- Command Palette -->
    <div class="command-palette" id="commandPalette">
      <div class="command-header">
        <i class="fas fa-search"></i>
        <input
          type="text"
          class="command-input"
          id="commandInput"
          placeholder="Search commands..."
        />
        <div class="command-shortcut">ESC</div>
      </div>
      <div class="command-list" id="commandList">
        <!-- Commands will be populated dynamically -->
      </div>
    </div>
    <div id="graph-container"></div>
    <!-- Quick Actions Bar -->
    <div class="quick-actions" id="quickActions">
      <div class="quick-action" data-action="command">
        <i class="fas fa-terminal"></i>
        <span>Command</span>
      </div>
      <div class="quick-action" data-action="center">
        <i class="fas fa-bullseye"></i>
        <span>Center</span>
      </div>
      <div class="quick-action" data-action="physics">
        <i class="fas fa-bolt"></i>
        <span>Physics</span>
      </div>
      <div class="quick-action" data-action="fullscreen">
        <i class="fas fa-expand"></i>
        <span>Fullscreen</span>
      </div>
      <div class="quick-action" data-action="help">
        <i class="fas fa-question-circle"></i>
        <span>Help</span>
      </div>
    </div>
    <div id="watermark">
    <div class="watermark-content">
        <div class="watermark-brand">
        <i class="fas fa-cube"></i>
        <span class="brand-text">tfkit</span>
        <span class="version">v{{ tfkit_version | default('0.0.0') }}</span>
        </div>
        <div class="watermark-links">
        <a href="https://tfkit.netlify.app" target="_blank" class="watermark-link">
            <i class="fas fa-globe"></i>
            <span>tfkit</span>
        </a>
        <a href="https://github.com/ivasik-k7/tfkit" target="_blank" class="watermark-link">
            <i class="fab fa-github"></i>
            <span>ivasik-k7/tfkit</span>
        </a>
        </div>
    </div>
    </div>
    <!-- Modern Dashboard HUD -->
    <div class="dashboard-hud">
      <div class="info-grid">
        <div class="info-card">
          <div class="info-value" id="node-count">0</div>
          <div class="info-label">Nodes</div>
        </div>
        <div class="info-card">
          <div class="info-value" id="edge-count">0</div>
          <div class="info-label">Links</div>
        </div>
        <div class="info-card">
          <div class="info-value" id="component-count">0</div>
          <div class="info-label">Groups</div>
        </div>
      </div>
      <div class="state-section">
        <div class="state-title">
          <i class="fas fa-diagram-project"></i>
          Infrastructure States
        </div>
        <div class="state-flow" id="state-indicators">
          <!-- State indicators will be populated dynamically -->
        </div>
      </div>
    </div>
    <div class="config-viewer" id="configViewer">
        <div class="config-header" onclick="toggleConfigViewer()">
            <div class="config-icon-wrapper">
            <i class="fas fa-cog fa-spin-slow"></i>
            </div>
            <div class="config-header-content">
            <div class="config-title">Configuration</div>
            <div class="config-subtitle">
                <span id="configCount">0</span> files
            </div>
            </div>
            <div class="config-toggle">
            <i class="fas fa-chevron-down config-chevron" id="configChevron"></i>
            </div>
        </div>
        <div class="config-content" id="configContent">
            <!-- Config files will be populated here -->
        </div>
    </div>
    <!-- Enhanced Legend with Analytical Insights -->
    <div class="legend">
      <!-- Dependency Metrics -->
      <div class="legend-section">
        <div
          class="legend-section-title"
          onclick="toggleLegendSection('metrics')"
        >
          <i class="fas fa-chart-line"></i> Dependency Metrics
          <i class="fas fa-chevron-down" id="metrics-chevron"></i>
        </div>
        <div class="legend-section-content" id="metrics-section">
          <div class="metric-card">
            <div class="metric-value" id="avg-dependencies">0</div>
            <div class="metric-label">Avg. Dependencies</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="max-depth">0</div>
            <div class="metric-label">Max Depth</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="complexity-score">0</div>
            <div class="metric-label">Complexity Score</div>
          </div>
        </div>
      </div>
      <!-- Resource Analysis -->
      <div class="legend-section">
        <div
          class="legend-section-title"
          onclick="toggleLegendSection('analysis')"
        >
          <i class="fas fa-microscope"></i> Resource Analysis
          <i class="fas fa-chevron-down" id="analysis-chevron"></i>
        </div>
        <div class="legend-section-content" id="analysis-section">
          <div class="analysis-row" onclick="highlightCriticalPath()">
            <div class="analysis-icon">
              <i class="fas fa-route"></i>
            </div>
            <div class="analysis-content">
              <div class="analysis-title">Critical Path</div>
              <div class="analysis-desc">Longest dependency chain</div>
            </div>
            <div class="analysis-action">
              <i class="fas fa-eye"></i>
            </div>
          </div>
          <div class="analysis-row" onclick="highlightCentralNodes()">
            <div class="analysis-icon">
              <i class="fas fa-star"></i>
            </div>
            <div class="analysis-content">
              <div class="analysis-title">Central Nodes</div>
              <div class="analysis-desc">Most connected resources</div>
            </div>
            <div class="analysis-action">
              <i class="fas fa-eye"></i>
            </div>
          </div>
          <div class="analysis-row" onclick="highlightIsolatedNodes()">
            <div class="analysis-icon">
              <i class="fas fa-unlink"></i>
            </div>
            <div class="analysis-content">
              <div class="analysis-title">Isolated Nodes</div>
              <div class="analysis-desc">Resources without dependencies</div>
            </div>
            <div class="analysis-action">
              <i class="fas fa-eye"></i>
            </div>
          </div>
        </div>
      </div>
      <!-- Quick Filters -->
      <div class="legend-section">
        <div class="legend-section-title">
          <i class="fas fa-filter"></i> Quick Filters
        </div>
        <div class="filter-chips">
          <div class="filter-chip" onclick="filterByComplexity('high')">
            <i class="fas fa-exclamation-triangle"></i> High Complexity
          </div>
          <div class="filter-chip" onclick="filterByDependencies('many')">
            <i class="fas fa-project-diagram"></i> Many Dependencies
          </div>
          <div class="filter-chip" onclick="filterByState('critical')">
            <i class="fas fa-exclamation-circle"></i> Critical States
          </div>
        </div>
      </div>
    </div>
    <div class="controls">
      <button class="control-btn" onclick="resetView()">
        <i class="fas fa-crosshairs"></i> Reset
      </button>
      <button class="control-btn" onclick="togglePhysics()" id="physics-btn">
        <i class="fas fa-bolt"></i> Physics
      </button>
      <button class="control-btn" onclick="centerGraph()">
        <i class="fas fa-bullseye"></i> Center
      </button>
      <button
        class="control-btn"
        onclick="toggleAnimations()"
        id="animations-btn"
      >
        <i class="fas fa-sparkles"></i> Animations
      </button>
      <button class="control-btn" onclick="clearFilters()">
        <i class="fas fa-filter"></i> Clear Filters
      </button>
    </div>
    <div class="scale-controls">
      <button class="scale-btn" onclick="zoomIn()">
        <i class="fas fa-search-plus"></i>
      </button>
      <button class="scale-btn" onclick="zoomOut()">
        <i class="fas fa-search-minus"></i>
      </button>
    </div>
    <div class="node-tooltip" id="node-tooltip"></div>
    <script>
      // Process the graph data to match expected format
      const rawGraphData = {{ graph_data|safe }};

      // Transform nodes to expected format with enhanced data processing
      const graphData = {
          nodes: rawGraphData.nodes.map(node => ({
              id: node.id,
              label: node.label,
              type: node.type,
              subtype: node.subtype,
              state: node.state,
              state_reason: node.state_reason,
              dependencies_out: node.dependencies_out,
              dependencies_in: node.dependencies_in,
              details: node.details || {}
          })),
          edges: rawGraphData.edges.map(edge => ({
              source: edge.source,
              target: edge.target,
              type: edge.type,
              strength: edge.strength || 0.5
          }))
      };

      // Initialize global state
      let simulation, graphG, animationTimer;
      let physicsEnabled = true;
      let animationsEnabled = true;
      let currentTransform = d3.zoomIdentity;
      let hoveredNode = null;
      let highlightedNodes = new Set();
      let highlightedEdges = new Set();
      let currentFilters = {
          types: new Set(),
          states: new Set()
      };

      // Build node graph first so it's available globally
      const { nodeMap, adjacencyList } = (function buildNodeGraph() {
          const nodeMap = new Map();
          const adjacencyList = new Map();

          graphData.nodes.forEach(node => {
              nodeMap.set(node.id, node);
              adjacencyList.set(node.id, { in: [], out: [] });
          });

          graphData.edges.forEach(edge => {
              const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
              const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;

              if (adjacencyList.has(sourceId)) {
                  adjacencyList.get(sourceId).out.push(targetId);
              }
              if (adjacencyList.has(targetId)) {
                  adjacencyList.get(targetId).in.push(targetId);
              }
          });

          return { nodeMap, adjacencyList };
      })();

      // Enhanced configuration for states from your data
      const config = {
          zoomSpeed: 0.2,
          physics: {
              charge: {
                  external_data: -250, integrated: -360, active: -380,
                  input: -200, orphaned: -100, configuration: -180,
                  unused: -150, incomplete: -180
              },
              link: {
                  external_data: 140, integrated: 110, active: 115,
                  input: 80, orphaned: 80, configuration: 70,
                  unused: 60, incomplete: 70
              },
              collision: {
                  base: 8, module: 12, resource: 10, multiplier: 0.8
              },
              force: {
                  center: 0.1, unusedAttraction: 0.05, stateGrouping: 0.02
              }
          },
          animation: {
              particleInterval: 50,
              transitionDuration: 300,
              hoverGlow: true
          },
          performance: {
              debounceDelay: 50,
              maxParticles: 100,
              throttleRender: true
          }
      };

      // Calculate advanced graph metrics and summary statistics
      const summary = {
          total_nodes: graphData.nodes.length,
          total_edges: graphData.edges.length,
          type_counts: {},
          state_counts: {},
          metrics: {
              avgDependencies: 0,
              maxDepth: 0,
              complexityScore: 0
          }
      };

      // Count types and states
      graphData.nodes.forEach(node => {
          summary.type_counts[node.type] = (summary.type_counts[node.type] || 0) + 1;
          summary.state_counts[node.state] = (summary.state_counts[node.state] || 0) + 1;
      });

      // Calculate average dependencies
      const totalDependencies = graphData.nodes.reduce((sum, node) =>
          sum + (node.dependencies_in || 0) + (node.dependencies_out || 0), 0);
      summary.metrics.avgDependencies = (totalDependencies / (graphData.nodes.length * 2)).toFixed(1);

      // Calculate max dependency depth (longest path)
      function calculateMaxDepth() {
          const visited = new Set();
          let maxDepth = 0;

          function dfs(nodeId, depth = 0) {
              if (visited.has(nodeId)) return depth;
              visited.add(nodeId);
              maxDepth = Math.max(maxDepth, depth);

              const outgoing = adjacencyList.get(nodeId)?.out || [];
              outgoing.forEach(targetId => {
                  dfs(targetId, depth + 1);
              });
              return depth;
          }

          graphData.nodes.forEach(node => {
              if (!visited.has(node.id)) {
                  dfs(node.id);
              }
          });

          return maxDepth;
      }
      summary.metrics.maxDepth = calculateMaxDepth();

      // Calculate complexity score based on dependencies and depth
      summary.metrics.complexityScore = Math.min(
          Math.round((summary.metrics.avgDependencies * summary.metrics.maxDepth) / 2),
          10
      );

      // Find central (most connected) nodes
      function findCentralNodes(limit = 5) {
          return graphData.nodes
              .map(node => ({
                  id: node.id,
                  connections: (node.dependencies_in || 0) + (node.dependencies_out || 0)
              }))
              .sort((a, b) => b.connections - a.connections)
              .slice(0, limit)
              .map(n => n.id);
      }

      // Find isolated nodes (no dependencies)
      function findIsolatedNodes() {
          return graphData.nodes
              .filter(node =>
                  (node.dependencies_in || 0) === 0 &&
                  (node.dependencies_out || 0) === 0
              )
              .map(n => n.id);
      }

      // Find critical path (longest dependency chain)
      function findCriticalPath() {
          const visited = new Set();
          let criticalPath = [];
          let maxLength = 0;

          function dfs(nodeId, path = []) {
              if (visited.has(nodeId)) return;
              visited.add(nodeId);
              path.push(nodeId);

              if (path.length > maxLength) {
                  maxLength = path.length;
                  criticalPath = [...path];
              }

              const outgoing = adjacencyList.get(nodeId)?.out || [];
              outgoing.forEach(targetId => {
                  dfs(targetId, [...path]);
              });
          }

          graphData.nodes.forEach(node => {
              if (!visited.has(node.id)) {
                  dfs(node.id);
              }
          });

          return criticalPath;
      }

      // Highlight functions for analytical features
      function highlightCriticalPath() {
          if (!graphG || !adjacencyList) {
              commandPalette.showToast('Error', 'Graph not yet initialized', 'error');
              return;
          }
          const path = findCriticalPath();
          clearHighlight();

          path.forEach(nodeId => {
              highlightedNodes.add(nodeId);
              const idx = path.indexOf(nodeId);
              if (idx < path.length - 1) {
                  highlightedEdges.add(`${nodeId}->${path[idx + 1]}`);
              }
          });

          applyHighlight();
          commandPalette.showToast('Critical Path', `Showing longest dependency chain (${path.length} nodes)`, 'info');
      }

      function highlightCentralNodes() {
          if (!graphG || !adjacencyList) {
              commandPalette.showToast('Error', 'Graph not yet initialized', 'error');
              return;
          }
          const centralNodes = findCentralNodes();
          clearHighlight();

          centralNodes.forEach(nodeId => {
              highlightedNodes.add(nodeId);
              const node = nodeMap.get(nodeId);
              if (node) {
                  (adjacencyList.get(nodeId)?.in || []).forEach(sourceId => {
                      highlightedNodes.add(sourceId);
                      highlightedEdges.add(`${sourceId}->${nodeId}`);
                  });
                  (adjacencyList.get(nodeId)?.out || []).forEach(targetId => {
                      highlightedNodes.add(targetId);
                      highlightedEdges.add(`${nodeId}->${targetId}`);
                  });
              }
          });

          applyHighlight();
          commandPalette.showToast('Central Nodes', `Showing ${centralNodes.length} most connected nodes`, 'info');
      }

      function highlightIsolatedNodes() {
          if (!graphG || !adjacencyList) {
              commandPalette.showToast('Error', 'Graph not yet initialized', 'error');
              return;
          }
          const isolatedNodes = findIsolatedNodes();
          clearHighlight();

          isolatedNodes.forEach(nodeId => {
              highlightedNodes.add(nodeId);
          });

          applyHighlight();
          commandPalette.showToast('Isolated Nodes', `Showing ${isolatedNodes.length} nodes without dependencies`, 'warning');
      }

      // Enhanced filtering system
      function filterByComplexity(level) {
          if (!graphG) {
              commandPalette.showToast('Error', 'Graph not yet initialized', 'error');
              return;
          }
          clearFilters();
          const threshold = level === 'high' ? 3 : 1;

          graphData.nodes.forEach(node => {
              const complexity = ((node.dependencies_in || 0) + (node.dependencies_out || 0)) / 2;
              if (complexity >= threshold) {
                  highlightedNodes.add(node.id);
              }
          });

          applyHighlight();
          commandPalette.showToast('Complexity Filter', `Showing nodes with ${level} complexity`, 'info');
      }

      function filterByDependencies(amount) {
          clearFilters();
          const threshold = amount === 'many' ? 4 : 2;

          graphData.nodes.forEach(node => {
              if ((node.dependencies_in || 0) + (node.dependencies_out || 0) >= threshold) {
                  highlightedNodes.add(node.id);
              }
          });

          applyHighlight();
          commandPalette.showToast('Dependency Filter', `Showing nodes with ${amount} dependencies`, 'info');
      }

      function filterByState(importance) {
          clearFilters();
          const criticalStates = ['external_data', 'orphaned', 'incomplete'];

          graphData.nodes.forEach(node => {
              if (criticalStates.includes(node.state)) {
                  highlightedNodes.add(node.id);
              }
          });

          applyHighlight();
          commandPalette.showToast('State Filter', 'Showing nodes in critical states', 'warning');
      }

      function applyHighlight() {
          if (!graphG) return; // Wait for graph to be initialized

          graphG.selectAll('.node').transition().duration(300)
              .style('opacity', n => highlightedNodes.has(n.id) ? 1 : 0.2);

          d3.selectAll('.link').transition().duration(300)
              .style('stroke-opacity', edge => {
                  const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                  const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                  const edgeKey = sourceId + '->' + targetId;
                  return highlightedEdges.has(edgeKey) ? 1 : 0.1;
              })
              .style('stroke', edge => {
                  const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                  const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                  const edgeKey = sourceId + '->' + targetId;
                  const target = nodeMap.get(targetId);
                  return highlightedEdges.has(edgeKey) ? (nodeConfig[target?.type]?.color || '{{ colors.accent }}') : '{{ colors.text_secondary }}';
              });

          if (animationsEnabled && highlightedEdges.size > 0) {
              stopLinkAnimation();
              startLinkAnimation();
          }
      }

      // Node graph already built at initialization

      function calculateConnectedComponents() {
          const visited = new Set();
          let components = 0;

          function dfs(nodeId) {
              const stack = [nodeId];
              while (stack.length) {
                  const current = stack.pop();
                  if (!visited.has(current)) {
                      visited.add(current);
                      const neighbors = [...(adjacencyList.get(current)?.in || []), ...(adjacencyList.get(current)?.out || [])];
                      neighbors.forEach(neighbor => {
                          if (!visited.has(neighbor)) stack.push(neighbor);
                      });
                  }
              }
          }

          graphData.nodes.forEach(node => {
              if (!visited.has(node.id)) {
                  dfs(node.id);
                  components++;
              }
          });

          return components;
      }

      summary.connected_components = calculateConnectedComponents();

      // Function to safely update DOM elements
      function updateDOMElements() {
          // Update HUD statistics if elements exist
          const nodeCount = document.getElementById('node-count');
          const edgeCount = document.getElementById('edge-count');
          const componentCount = document.getElementById('component-count');
          const avgDeps = document.getElementById('avg-dependencies');
          const maxDepth = document.getElementById('max-depth');
          const complexityScore = document.getElementById('complexity-score');

          if (nodeCount) nodeCount.textContent = summary.total_nodes.toLocaleString();
          if (edgeCount) edgeCount.textContent = summary.total_edges.toLocaleString();
          if (componentCount) componentCount.textContent = summary.connected_components.toLocaleString();
          if (avgDeps) avgDeps.textContent = summary.metrics.avgDependencies;
          if (maxDepth) maxDepth.textContent = summary.metrics.maxDepth;
          if (complexityScore) complexityScore.textContent = summary.metrics.complexityScore;
      }

      // Call update function when DOM is ready
      document.addEventListener('DOMContentLoaded', updateDOMElements);
      // Also call it now in case DOM is already loaded
      if (document.readyState === 'complete') {
          updateDOMElements();
      }

      // Function to safely update state indicators
      function updateStateIndicators() {
          const stateIndicators = document.getElementById('state-indicators');

          if (!stateIndicators) {
              console.warn('State indicator elements not found, deferring update');
              return;
          }

          stateIndicators.innerHTML = '';

          Object.entries(summary.state_counts).forEach(([state, count]) => {
              if (count > 0) {
              const stateInfo = {
                  active: { icon: 'fa-check-circle', desc: 'Active and properly configured resources', color: '#22c55e' },
                  integrated: { icon: 'fa-link', desc: 'Resources integrated with other components', color: '#84cc16' },
                  external_data: { icon: 'fa-database', desc: 'Resources using external data sources', color: '#a855f7' },
                  configuration: { icon: 'fa-cog', desc: 'Resources pending configuration', color: '#8b5cf6' },
                  orphaned: { icon: 'fa-unlink', desc: 'Isolated resources without connections', color: '#fb923c' },
                  unused: { icon: 'fa-ban', desc: 'Unused or deprecated resources', color: '#f59e0b' },
                  leaf: { icon: 'fa-leaf', desc: 'End nodes without outgoing connections', color: '#10b981' },
                  isolated: { icon: 'fa-circle-dot', desc: 'Completely isolated nodes', color: '#ef4444' },
                  root: { icon: 'fa-diagram-project', desc: 'Root nodes without incoming connections', color: '#3b82f6' }
              }[state] || { icon: 'fa-circle', desc: 'Other resource state', color: '#666666' };

              const indicator = document.createElement('div');
              indicator.className = `state-item state-${state}`;

              const totalNodes = summary.total_nodes;
              const percentage = ((count / totalNodes) * 100).toFixed(1);

              indicator.innerHTML = `
                  <div class="state-header">
                      <div class="state-name">
                          <div class="state-icon" style="background: ${stateInfo.color}20; color: ${stateInfo.color}">
                              <i class="fas ${stateInfo.icon}"></i>
                          </div>
                          ${state.replace('_', ' ').replace(/(^\\w{1})|(\\.\\s+\\w{1})/g, letter => letter.toUpperCase())}
                      </div>
                      <div class="state-count" style="background: ${stateInfo.color}15; color: ${stateInfo.color}">${count}</div>
                  </div>
                  <div class="state-info">
                      <div class="state-metric">
                          <i class="fas fa-chart-pie"></i>
                          ${percentage}%
                      </div>
                      <div class="state-metric">
                          <i class="fas fa-info-circle"></i>
                          ${stateInfo.desc}
                      </div>
                  </div>
              `;

              let highlightTimeout;
              indicator.addEventListener('mouseenter', () => {
                  highlightTimeout = setTimeout(() => {
                      const nodes = graphG.selectAll('.node').filter(d => d.state === state);
                      nodes.each(d => {
                          highlightedNodes.add(d.id);
                          // Add connected edges
                          graphData.edges.forEach(edge => {
                              const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                              const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                              if (sourceId === d.id || targetId === d.id) {
                                  highlightedEdges.add(`${sourceId}->${targetId}`);
                              }
                          });
                      });
                      applyHighlight();
                  }, 200); // Small delay to prevent flickering
              });

              indicator.addEventListener('mouseleave', () => {
                  clearTimeout(highlightTimeout);
                  clearHighlight();
              });

              indicator.addEventListener('click', () => {
                  clearHighlight();
                  filterByState(state);
                  // Show toast with filter info
                  commandPalette.showToast(
                      'Filter Applied',
                      `Showing ${state.replace('_', ' ')} resources`,
                      'info'
                  );
              });
              stateIndicators.appendChild(indicator);
              }
          });
      }

      // Call update function when DOM is ready
      document.addEventListener('DOMContentLoaded', updateStateIndicators);
      // Also call it now in case DOM is already loaded
      if (document.readyState === 'complete') {
          updateStateIndicators();
      }

        const nodeConfig = {
            // Core Terraform types
            resource: {
                icon: 'fas fa-cube',
                color: '#000000',
                size: 'medium'
            },
            module: {
                icon: 'fas fa-cubes',
                color: '#000000',
                size: 'large'
            },
            variable: {
                icon: 'fas fa-code',
                color: '#000000',
                size: 'small'
            },
            output: {
                icon: 'fas fa-arrow-right',
                color: '#000000',
                size: 'small'
            },
            data: {
                icon: 'fas fa-database',
                color: '#000000',
                size: 'medium'
            },
            provider: {
                icon: 'fas fa-cog',
                color: '#000000',
                size: 'medium'
            },
            local: {
                icon: 'fas fa-terminal',
                color: '#000000',
                size: 'small'
            },
            terraform: {
                icon: 'fas fa-sitemap',
                color: '#000000',
                size: 'medium'
            },

            // ========== MAJOR PROVIDERS ==========
            aws: {
                icon: 'fab fa-aws',
                color: '#000000',
                size: 'medium'
            },
            google: {
                icon: 'fab fa-google',
                color: '#000000',
                size: 'medium'
            },
            azure: {
                icon: 'fas fa-cloud',
                color: '#000000',
                size: 'medium'
            },
            azurerm: {
                icon: 'fas fa-cloud',
                color: '#000000',
                size: 'medium'
            },
            tfe: {
                icon: 'fas fa-cloud',
                color: '#000000',
                size: 'medium'
            },
            kubernetes: {
                icon: 'fas fa-dharmachakra',
                color: '#000000',
                size: 'medium'
            },
            docker: {
                icon: 'fab fa-docker',
                color: '#000000',
                size: 'medium'
            },
            github: {
                icon: 'fab fa-github',
                color: '#000000',
                size: 'medium'
            },
            random: {
                icon: 'fas fa-dice',
                color: '#000000',
                size: 'medium'
            },
            null: {
                icon: 'fas fa-ban',
                color: '#000000',
                size: 'medium'
            },
            vault: {
                icon: 'fas fa-lock',
                color: '#000000',
                size: 'medium'
            },
            consul: {
                icon: 'fas fa-network-wired',
                color: '#000000',
                size: 'medium'
            },
            nomad: {
                icon: 'fas fa-server',
                color: '#000000',
                size: 'medium'
            },

            // ========== AWS RESOURCES ==========
            // Compute
            aws_instance: { icon: 'fas fa-server', color: '#000000', size: 'medium' },
            aws_lambda_function: { icon: 'fas fa-bolt', color: '#000000', size: 'medium' },
            aws_ecs_cluster: { icon: 'fas fa-cubes', color: '#000000', size: 'medium' },
            aws_ecs_service: { icon: 'fas fa-cogs', color: '#000000', size: 'medium' },
            aws_ami: { icon: 'fas fa-image', color: '#000000', size: 'medium' },
            aws_launch_configuration: { icon: 'fas fa-rocket', color: '#000000', size: 'medium' },
            aws_autoscaling_group: { icon: 'fas fa-expand-arrows-alt', color: '#000000', size: 'medium' },

            // Networking
            aws_vpc: { icon: 'fas fa-network-wired', color: '#000000', size: 'large' },
            aws_subnet: { icon: 'fas fa-sitemap', color: '#000000', size: 'medium' },
            aws_internet_gateway: { icon: 'fas fa-globe', color: '#000000', size: 'medium' },
            aws_nat_gateway: { icon: 'fas fa-exchange-alt', color: '#000000', size: 'medium' },
            aws_route_table: { icon: 'fas fa-route', color: '#000000', size: 'medium' },
            aws_route_table_association: { icon: 'fas fa-link', color: '#000000', size: 'small' },
            aws_security_group: { icon: 'fas fa-shield-alt', color: '#000000', size: 'medium' },
            aws_acl: { icon: 'fas fa-filter', color: '#000000', size: 'medium' },
            aws_elb: { icon: 'fas fa-balance-scale', color: '#000000', size: 'medium' },
            aws_lb: { icon: 'fas fa-balance-scale', color: '#000000', size: 'medium' },
            aws_lb_target_group: { icon: 'fas fa-bullseye', color: '#000000', size: 'medium' },
            aws_lb_listener: { icon: 'fas fa-ear-listen', color: '#000000', size: 'medium' },
            aws_cloudfront_distribution: { icon: 'fas fa-bolt', color: '#000000', size: 'medium' },
            aws_route53_zone: { icon: 'fas fa-globe-americas', color: '#000000', size: 'medium' },

            // Database
            aws_db_instance: { icon: 'fas fa-database', color: '#000000', size: 'medium' },
            aws_db_subnet_group: { icon: 'fas fa-th', color: '#000000', size: 'medium' },
            aws_dynamodb_table: { icon: 'fas fa-table', color: '#000000', size: 'medium' },
            aws_elasticache_cluster: { icon: 'fas fa-memory', color: '#000000', size: 'medium' },

            // Storage
            aws_s3_bucket: { icon: 'fas fa-archive', color: '#000000', size: 'medium' },
            aws_s3_bucket_versioning: { icon: 'fas fa-history', color: '#000000', size: 'small' },
            aws_s3_bucket_policy: { icon: 'fas fa-file-contract', color: '#000000', size: 'small' },
            aws_ebs_volume: { icon: 'fas fa-hdd', color: '#000000', size: 'medium' },
            aws_efs_file_system: { icon: 'fas fa-folder', color: '#000000', size: 'medium' },

            // IAM & Security
            aws_iam_role: { icon: 'fas fa-user-lock', color: '#000000', size: 'medium' },
            aws_iam_policy: { icon: 'fas fa-file-alt', color: '#000000', size: 'medium' },
            aws_iam_role_policy_attachment: { icon: 'fas fa-link', color: '#000000', size: 'small' },
            aws_iam_instance_profile: { icon: 'fas fa-id-card', color: '#000000', size: 'medium' },
            aws_iam_user: { icon: 'fas fa-user', color: '#000000', size: 'medium' },
            aws_iam_group: { icon: 'fas fa-users', color: '#000000', size: 'medium' },
            aws_key_pair: { icon: 'fas fa-key', color: '#000000', size: 'medium' },
            aws_kms_key: { icon: 'fas fa-key', color: '#000000', size: 'medium' },
            aws_secretsmanager_secret: { icon: 'fas fa-user-secret', color: '#000000', size: 'medium' },

            // Monitoring & Notifications
            aws_cloudwatch_metric_alarm: { icon: 'fas fa-chart-line', color: '#000000', size: 'medium' },
            aws_cloudwatch_log_group: { icon: 'fas fa-scroll', color: '#000000', size: 'medium' },
            aws_sns_topic: { icon: 'fas fa-bell', color: '#000000', size: 'medium' },
            aws_sqs_queue: { icon: 'fas fa-inbox', color: '#000000', size: 'medium' },

            // Data Sources
            aws_availability_zones: { icon: 'fas fa-map-marker-alt', color: '#000000', size: 'medium' },
            aws_region: { icon: 'fas fa-map', color: '#000000', size: 'medium' },
            aws_caller_identity: { icon: 'fas fa-user', color: '#000000', size: 'medium' },
            aws_ami: { icon: 'fas fa-image', color: '#000000', size: 'medium' },

            // ========== GOOGLE CLOUD RESOURCES ==========
            google_compute_instance: { icon: 'fas fa-server', color: '#000000', size: 'medium' },
            google_compute_disk: { icon: 'fas fa-hdd', color: '#000000', size: 'medium' },
            google_storage_bucket: { icon: 'fas fa-archive', color: '#000000', size: 'medium' },
            google_bigquery_dataset: { icon: 'fas fa-chart-bar', color: '#000000', size: 'medium' },
            google_cloudfunctions_function: { icon: 'fas fa-bolt', color: '#000000', size: 'medium' },
            google_sql_database_instance: { icon: 'fas fa-database', color: '#000000', size: 'medium' },
            google_pubsub_topic: { icon: 'fas fa-broadcast-tower', color: '#000000', size: 'medium' },

            // ========== AZURE RESOURCES ==========
            azurerm_virtual_machine: { icon: 'fas fa-server', color: '#000000', size: 'medium' },
            azurerm_storage_account: { icon: 'fas fa-archive', color: '#000000', size: 'medium' },
            azurerm_sql_database: { icon: 'fas fa-database', color: '#000000', size: 'medium' },
            azurerm_app_service: { icon: 'fas fa-window-maximize', color: '#000000', size: 'medium' },
            azurerm_function_app: { icon: 'fas fa-bolt', color: '#000000', size: 'medium' },

            // ========== KUBERNETES RESOURCES ==========
            kubernetes_pod: { icon: 'fas fa-box', color: '#000000', size: 'medium' },
            kubernetes_deployment: { icon: 'fas fa-layer-group', color: '#000000', size: 'medium' },
            kubernetes_service: { icon: 'fas fa-plug', color: '#000000', size: 'medium' },
            kubernetes_config_map: { icon: 'fas fa-cog', color: '#000000', size: 'medium' },
            kubernetes_secret: { icon: 'fas fa-user-secret', color: '#000000', size: 'medium' },
            kubernetes_namespace: { icon: 'fas fa-folder', color: '#000000', size: 'medium' },

            // ========== DOCKER RESOURCES ==========
            docker_container: { icon: 'fab fa-docker', color: '#000000', size: 'medium' },
            docker_image: { icon: 'fas fa-box', color: '#000000', size: 'medium' },
            docker_volume: { icon: 'fas fa-hdd', color: '#000000', size: 'medium' },

            // ========== GITHUB RESOURCES ==========
            github_repository: { icon: 'fab fa-github', color: '#000000', size: 'medium' },
            github_branch: { icon: 'fas fa-code-branch', color: '#000000', size: 'medium' },

            // ========== RANDOM PROVIDER ==========
            random_password: { icon: 'fas fa-key', color: '#000000', size: 'medium' },
            random_id: { icon: 'fas fa-fingerprint', color: '#000000', size: 'medium' },
            random_pet: { icon: 'fas fa-paw', color: '#000000', size: 'medium' },
            random_integer: { icon: 'fas fa-hashtag', color: '#000000', size: 'medium' },
            random_string: { icon: 'fas fa-font', color: '#000000', size: 'medium' },
            random_shuffle: { icon: 'fas fa-random', color: '#000000', size: 'medium' },

            // ========== NULL PROVIDER ==========
            null_resource: { icon: 'fas fa-cogs', color: '#000000', size: 'medium' },

            // ========== VAULT PROVIDER ==========
            vault_auth_backend: { icon: 'fas fa-lock', color: '#000000', size: 'medium' },
            vault_secret: { icon: 'fas fa-user-secret', color: '#000000', size: 'medium' },

            // ========== CONSUL PROVIDER ==========
            consul_key: { icon: 'fas fa-key', color: '#000000', size: 'medium' },
            consul_service: { icon: 'fas fa-cogs', color: '#000000', size: 'medium' },

            // ========== MODULE TYPES ==========
            cloudfront: { icon: 'fas fa-bolt', color: '#000000', size: 'large' },
            'metric-alarm': { icon: 'fas fa-exclamation-triangle', color: '#000000', size: 'large' },
            'cloudwatch-alarm': { icon: 'fas fa-chart-bar', color: '#000000', size: 'large' },
            networking: { icon: 'fas fa-network-wired', color: '#000000', size: 'large' },
            database: { icon: 'fas fa-database', color: '#000000', size: 'large' },
            security: { icon: 'fas fa-shield-alt', color: '#000000', size: 'large' },
            storage: { icon: 'fas fa-archive', color: '#000000', size: 'large' },
            compute: { icon: 'fas fa-server', color: '#000000', size: 'large' },
            monitoring: { icon: 'fas fa-chart-line', color: '#000000', size: 'large' }
        };

      const stateConfig = {
        // Healthy states
        active: {
            icon: 'fas fa-check-circle',
            color: '#10b981',
            stroke: '#10b981',
            opacity: 1.0,
            badge: 'success'
        },
        integrated: {
            icon: 'fas fa-link',
            color: '#3b82f6',
            stroke: '#3b82f6',
            opacity: 1.0,
            badge: 'info'
        },
        external_data: {
            icon: 'fas fa-download',
            color: '#06b6d4',
            stroke: '#06b6d4',
            opacity: 0.9,
            badge: 'info'
        },
        input: {
            icon: 'fas fa-sign-in-alt',
            color: '#10b981',
            stroke: '#10b981',
            opacity: 0.9,
            badge: 'info'
        },
        configuration: {
            icon: 'fas fa-cog',
            color: '#6b7280',
            stroke: '#6b7280',
            opacity: 1.0,
            badge: 'neutral'
        },

        // Warning states
        orphaned: {
            icon: 'fas fa-unlink',
            color: '#f59e0b',
            stroke: '#f59e0b',
            opacity: 0.7,
            badge: 'warning'
        },
        unused: {
            icon: 'fas fa-eye-slash',
            color: '#6b7280',
            stroke: '#6b7280',
            opacity: 0.5,
            badge: 'neutral'
        },

        // Error states
        incomplete: {
            icon: 'fas fa-exclamation-triangle',
            color: '#ef4444',
            stroke: '#ef4444',
            opacity: 0.8,
            badge: 'error'
        }
      };

        function getNodeConfig(node) {
            // 1. First priority: Exact resource subtype match (most specific)
            if (node.subtype && nodeConfig[node.subtype]) {
                return nodeConfig[node.subtype];
            }
            
            // 2. For provider nodes, use provider-specific icons
            if (node.type === 'provider' && node.subtype) {
                // Try exact provider match first
                if (nodeConfig[node.subtype]) {
                    return nodeConfig[node.subtype];
                }
                // Fallback to generic provider icon
                return nodeConfig.provider;
            }
            
            // 3. Check for provider-specific resources based on provider in details
            if (node.details?.provider) {
                // Try provider_resource format (e.g., aws_instance)
                const providerResource = `${node.details.provider}_${node.subtype}`;
                if (nodeConfig[providerResource]) {
                    return nodeConfig[providerResource];
                }
                
                // Try provider-specific icon
                if (nodeConfig[node.details.provider]) {
                    return nodeConfig[node.details.provider];
                }
            }
            
            // 4. Check for resource category based on common patterns
            if (node.subtype) {
                const resourceType = node.subtype.toLowerCase();
                
                // Compute resources
                if (resourceType.includes('instance') || resourceType.includes('vm') || resourceType.includes('server')) {
                    return { ...nodeConfig.resource, icon: 'fas fa-server' };
                }
                
                // Database resources
                if (resourceType.includes('db') || resourceType.includes('database') || resourceType.includes('sql')) {
                    return { ...nodeConfig.resource, icon: 'fas fa-database' };
                }
                
                // Storage resources
                if (resourceType.includes('bucket') || resourceType.includes('storage') || resourceType.includes('volume')) {
                    return { ...nodeConfig.resource, icon: 'fas fa-archive' };
                }
                
                // Network resources
                if (resourceType.includes('vpc') || resourceType.includes('subnet') || resourceType.includes('network')) {
                    return { ...nodeConfig.resource, icon: 'fas fa-network-wired' };
                }
                
                // Security resources
                if (resourceType.includes('security') || resourceType.includes('firewall') || resourceType.includes('acl')) {
                    return { ...nodeConfig.resource, icon: 'fas fa-shield-alt' };
                }
                
                // IAM/Identity resources
                if (resourceType.includes('iam') || resourceType.includes('role') || resourceType.includes('policy')) {
                    return { ...nodeConfig.resource, icon: 'fas fa-user-lock' };
                }
            }
            
            // 5. Fall back to type-based config
            return nodeConfig[node.type] || nodeConfig.resource;
        }

      function getStateConfig(state) {
        return stateConfig[state] || stateConfig.active;
      }
      let renderThrottled = false;

      function init() {
          const container = document.getElementById('graph-container');
          const width = container.clientWidth, height = container.clientHeight;

          // Clear previous SVG
          d3.select('#graph-container svg').remove();

          const svg = d3.select('#graph-container').append('svg')
              .attr('width', width)
              .attr('height', height)
              .classed('performance-optimized', true);

          const defs = svg.append('defs');

          // Enhanced grid pattern
          const grid_size = 50;
          defs.append('pattern')
              .attr('id', 'grid')
              .attr('width', grid_size)
              .attr('height', grid_size)
              .attr('patternUnits', 'userSpaceOnUse')
              .append('path')
              .attr('d', `M ${grid_size} 0 L 0 0 0 ${grid_size}`)
              .attr('fill', 'none')
              .attr('stroke', '{{ colors.text_secondary }}')
              .attr('stroke-opacity', 0.1)
              .attr('stroke-width', 1);

          // Add SVG filters and gradients
          const filters = defs.append('g').attr('class', 'filters');

          // Glow filter for resources
          const resourceGlow = filters.append('filter')
              .attr('id', 'resource-glow')
              .attr('height', '300%')
              .attr('width', '300%')
              .attr('x', '-100%')
              .attr('y', '-100%');

          resourceGlow.append('feGaussianBlur')
              .attr('stdDeviation', '2')
              .attr('result', 'coloredBlur');

          const resourceGlowMerge = resourceGlow.append('feMerge');
          resourceGlowMerge.append('feMergeNode')
              .attr('in', 'coloredBlur');
          resourceGlowMerge.append('feMergeNode')
              .attr('in', 'SourceGraphic');

          // Glow filter for links
          const linkGlow = filters.append('filter')
              .attr('id', 'link-glow')
              .attr('height', '300%')
              .attr('width', '300%')
              .attr('x', '-100%')
              .attr('y', '-100%');

          linkGlow.append('feGaussianBlur')
              .attr('stdDeviation', '1')
              .attr('result', 'coloredBlur');

          const linkGlowMerge = linkGlow.append('feMerge');
          linkGlowMerge.append('feMergeNode')
              .attr('in', 'coloredBlur');
          linkGlowMerge.append('feMergeNode')
              .attr('in', 'SourceGraphic');

          // Glow filter for particles
          const particleGlow = filters.append('filter')
              .attr('id', 'particle-glow')
              .attr('height', '300%')
              .attr('width', '300%')
              .attr('x', '-100%')
              .attr('y', '-100%');

          particleGlow.append('feGaussianBlur')
              .attr('stdDeviation', '1')
              .attr('result', 'coloredBlur');

          const particleGlowMerge = particleGlow.append('feMerge');
          particleGlowMerge.append('feMergeNode')
              .attr('in', 'coloredBlur');
          particleGlowMerge.append('feMergeNode')
              .attr('in', 'SourceGraphic');

          // Enhanced gradient for links with multiple color stops
          const linkGradient = defs.append('linearGradient')
              .attr('id', 'link-gradient')
              .attr('gradientUnits', 'userSpaceOnUse');

          linkGradient.append('stop')
              .attr('offset', '0%')
              .attr('stop-color', '{{ colors.accent }}')
              .attr('stop-opacity', '1');

          linkGradient.append('stop')
              .attr('offset', '50%')
              .attr('stop-color', '{{ colors.info }}')
              .attr('stop-opacity', '0.8');

          linkGradient.append('stop')
              .attr('offset', '100%')
              .attr('stop-color', '{{ colors.success }}')
              .attr('stop-opacity', '1');

          // Pulse animation for particles
          const pulseAnimation = defs.append('radialGradient')
              .attr('id', 'particle-pulse')
              .attr('gradientUnits', 'objectBoundingBox')
              .attr('cx', '50%')
              .attr('cy', '50%')
              .attr('r', '50%');

          pulseAnimation.append('stop')
              .attr('offset', '0%')
              .attr('stop-color', '{{ colors.accent }}')
              .attr('stop-opacity', '1');

          pulseAnimation.append('stop')
              .attr('offset', '100%')
              .attr('stop-color', '{{ colors.accent }}')
              .attr('stop-opacity', '0');

          svg.append('rect')
              .attr('width', '100%')
              .attr('height', '100%')
              .attr('fill', 'url(#grid)');


          const g = svg.append('g');
          graphG = g.append('g').classed('performance-optimized', true);

          // Enhanced zoom behavior with performance optimizations
          const zoom = d3.zoom()
              .scaleExtent([0.05, 8])
              .wheelDelta(function(event) {
                  const delta = -event.deltaY * (event.deltaMode ? 120 : 1) / 500;
                  return delta * config.zoomSpeed;
              })
              .on('zoom', (event) => {
                  currentTransform = event.transform;
                  g.attr('transform', event.transform);
              });

          svg.call(zoom)
          .call(zoom.transform, d3.zoomIdentity);

          // Initialize enhanced force simulation
          simulation = d3.forceSimulation(graphData.nodes)
              .force('link', d3.forceLink(graphData.edges)
                  .id(d => d.id)
                  .distance(d => {
                      const source = typeof d.source === 'object' ? d.source : nodeMap.get(d.source);
                      const target = typeof d.target === 'object' ? d.target : nodeMap.get(d.target);
                      const sourceState = source?.state || 'active';
                      const targetState = target?.state || 'active';
                      return Math.min(
                          config.physics.link[sourceState] || config.physics.link.active,
                          config.physics.link[targetState] || config.physics.link.active
                      );
                  })
                  .strength(0.2)
              )
              .force('charge', d3.forceManyBody()
                  .strength(d => {
                      const stateStrength = config.physics.charge[d.state] || config.physics.charge.active;
                      const dependencyFactor = 1 + ((d.dependencies_out || 0) + (d.dependencies_in || 0)) * 0.1;
                      return stateStrength * dependencyFactor;
                  })
                  .distanceMax(400)
              )
              .force('center', d3.forceCenter(width / 2, height / 2).strength(config.physics.force.center))
              .force('collision', d3.forceCollide()
                  .radius(d => {
                      const baseRadius = d.type === 'module' ? config.physics.collision.module :
                                          d.type === 'resource' ? config.physics.collision.resource :
                                          config.physics.collision.base;
                      const dependencyCount = (d.dependencies_out || 0) + (d.dependencies_in || 0);
                      return baseRadius + Math.min(dependencyCount * config.physics.collision.multiplier, 6);
                  })
                  .strength(0.8)
              )
              .alphaDecay(0.0228)
              .velocityDecay(0.4);

          // Create links
          const link = graphG.append('g')
              .selectAll('line')
              .data(graphData.edges)
              .join('line')
              .attr('class', 'link')
              .attr('data-source', d => typeof d.source === 'object' ? d.source.id : d.source)
              .attr('data-target', d => typeof d.target === 'object' ? d.target.id : d.target)
              .attr('marker-end', d => {
                  const target = typeof d.target === 'object' ? d.target : nodeMap.get(d.target);
                  return target ? `url(#arrow-${target.type})` : '';
              })
              .style('stroke-width', 1.5)
              .style('opacity', 0.75);

          // Create nodes with hexagonal shapes
          const node = graphG.append('g')
              .selectAll('g')
              .data(graphData.nodes)
              .join('g')
              .attr('class', d => `node ${d.type} ${d.state}`)
              .attr('data-id', d => d.id)
              .call(d3.drag()
                  .on('start', dragstarted)
                  .on('drag', dragged)
                  .on('end', dragended))
              .on('mouseover', (event, d) => showTooltip(event, d))
              .on('mouseout', (event, d) => hideTooltip(event, d))
              .on('click', (event, d) => highlightConnected(event, d));

          // Function to create hexagon path
          function hexagonPath(size) {
              const points = [];
              for (let i = 0; i < 6; i++) {
                  const angle = (i * Math.PI) / 3;
                  points.push([size * Math.sin(angle), size * Math.cos(angle)]);
              }
              return `M${points.map(p => p.join(',')).join('L')}Z`;
          }

        node.append('path')
            .attr('class', d => `node-shape ${d.type} ${d.state || ''}`)
            .attr('d', d => {
                const config = getNodeConfig(d);
                const baseSize = config.size === 'large' ? 16 : config.size === 'small' ? 10 : 13;
                const dependencyCount = (d.dependencies_out || 0) + (d.dependencies_in || 0);
                const size = baseSize + Math.min(dependencyCount * 0.6, 6);
                return hexagonPath(size);
            })
            .style('fill', d => {
                const config = getNodeConfig(d);
                const state = getStateConfig(d.state);
                return state.color;
            })
            .style('stroke', d => {
                const state = getStateConfig(d.state);
                return state.stroke;
            })
            .style('stroke-width', d => {
                const state = getStateConfig(d.state);
                return ['orphaned', 'incomplete'].includes(d.state) ? '2px' : '1px';
            })
            .style('opacity', d => {
                const state = getStateConfig(d.state);
                return state.opacity;
            })
            .style('cursor', 'pointer')
            .style('stroke-dasharray', d => {
                return d.state === 'unused' ? '3,3' : 'none';
            });

        node.append('foreignObject')
            .attr('width', 24)
            .attr('height', 24)
            .attr('x', -12) // Center the icon (24/2 = 12)
            .attr('y', -15) // Center the icon (24/2 = 12)
            .append('xhtml:div')
            .attr('class', 'node-icon-container')
            .style('width', '100%')
            .style('height', '100%')
            .style('display', 'flex')
            .style('align-items', 'center')
            .style('justify-content', 'center')
            .style('pointer-events', 'none')
            .html(d => {
                const config = getNodeConfig(d);
                const state = getStateConfig(d.state);
                const fontSize = config.size === 'large' ? '14px' : config.size === 'small' ? '10px' : '12px';

                const iconClass = config.icon;

                let badgeHtml = '';
                if (state.badge && state.badge !== 'success') {
                    const badgeColor = state.badge === 'warning' ? '#f59e0b' :
                                    state.badge === 'error' ? '#ef4444' :
                                    state.badge === 'info' ? '#3b82f6' : '#6b7280';
                    badgeHtml = `<div class="state-badge" style="
                        position: absolute;
                        top: -4px;
                        right: -4px;
                        width: 8px;
                        height: 8px;
                        border-radius: 50%;
                        background: ${badgeColor};
                        border: 1px solid white;
                        box-shadow: 0 0 2px rgba(0,0,0,0.3);
                    "></div>`;
                }

                return `
                    <div style="position: relative;">
                        <i class="${iconClass}" style="font-size: ${fontSize}; color: #000000;"></i>
                    </div>
                `;
            });

          // Enhanced labels
          node.append('text')
              .attr('dx', d => {
                  const radius = d.type === 'module' ? 14 : d.type === 'resource' ? 11 : 9;
                  const dependencyCount = (d.dependencies_out || 0) + (d.dependencies_in || 0);
                  return radius + Math.min(dependencyCount * 0.6, 6) + 4;
              })
              .attr('dy', 4)
              .text(d => {
                  const maxLength = d.type === 'module' ? 25 : 18;
                  return d.label.length > maxLength ? d.label.substring(0, maxLength) + '...' : d.label;
              })
              .style('fill', '{{ colors.text_primary }}')
              .style('font-size', d => d.type === 'module' ? '12px' : '11px')
              .style('font-weight', '500')
              .style('pointer-events', 'none')
              .style('text-shadow', `0 1px 4px {{ colors.bg_primary }}`);

          // Performance-optimized simulation tick
          simulation.on('tick', () => {
              if (config.performance.throttleRender && renderThrottled) return;
              renderThrottled = true;

              requestAnimationFrame(() => {
                  link.attr('x1', d => d.source.x)
                      .attr('y1', d => d.source.y)
                      .attr('x2', d => d.target.x)
                      .attr('y2', d => d.target.y);

                  node.attr('transform', d => `translate(${d.x},${d.y})`);
                  renderThrottled = false;
              });
          });

          // Export for global access
          window.zoom = zoom;
          window.svg = svg;
          window.width = width;
          window.height = height;

          // Apply initial filters
          applyFilters();

          // Start animations if enabled
          if (animationsEnabled) {
              startLinkAnimation();
          }
      }

      // Enhanced filter system
      function filterByType(type) {
          if (currentFilters.types.has(type)) {
              currentFilters.types.delete(type);
          } else {
              currentFilters.types.add(type);
          }
          applyFilters();
      }

      function filterByState(state) {
          if (currentFilters.states.has(state)) {
              currentFilters.states.delete(state);
          } else {
              currentFilters.states.add(state);
          }
          applyFilters();
      }

      function applyFilters() {
          if (!graphG) return; // Wait for graph to be initialized

          const nodes = graphG.selectAll('.node');
          const links = graphG.selectAll('.link');

          nodes.style('display', d => {
              if (currentFilters.types.size > 0 && !currentFilters.types.has(d.type)) return 'none';
              if (currentFilters.states.size > 0 && !currentFilters.states.has(d.state)) return 'none';
              return null;
          });

          links.style('display', d => {
              const source = typeof d.source === 'object' ? d.source : nodeMap.get(d.source);
              const target = typeof d.target === 'object' ? d.target : nodeMap.get(d.target);

              if (!source || !target) return 'none';
              if (currentFilters.types.size > 0 &&
                  (!currentFilters.types.has(source.type) || !currentFilters.types.has(target.type))) return 'none';
              if (currentFilters.states.size > 0 &&
                  (!currentFilters.states.has(source.state) || !currentFilters.states.has(target.state))) return 'none';
              return null;
          });
      }

      function clearFilters() {
          currentFilters.types.clear();
          currentFilters.states.clear();
          applyFilters();
      }

      // Enhanced legend interactions
      function toggleLegendSection(section) {
          const content = document.getElementById(`${section}-section`);
          const chevron = document.getElementById(`${section}-chevron`);

          if (content.style.display === 'none') {
              content.style.display = 'block';
              chevron.className = 'fas fa-chevron-down';
          } else {
              content.style.display = 'none';
              chevron.className = 'fas fa-chevron-right';
          }
      }

      // Zoom control functions
      function zoomHandler(direction) {
          const zoomAmount = direction === 'in' ? 1.2 : 1 / 1.2;
          window.svg.transition().duration(300).call(window.zoom.scaleBy, zoomAmount);
      }

      function zoomIn() { zoomHandler('in'); }
      function zoomOut() { zoomHandler('out'); }
      function resetZoom() {
          window.svg.transition().duration(500).call(window.zoom.transform, d3.zoomIdentity);
      }
      function centerGraph() {
          const initialScale = 1;
          const x = window.width / 2;
          const y = window.height / 2;

          const transform = d3.zoomIdentity
              .translate(x, y)
              .scale(initialScale)
              .translate(-x, -y);

          window.svg.transition().duration(500).call(window.zoom.transform, transform);
      }

      function resetView() {
          resetZoom();
          clearHighlight();
          clearFilters();
          if (!physicsEnabled) togglePhysics();
      }

      function togglePhysics() {
          physicsEnabled = !physicsEnabled;
          const btn = document.getElementById('physics-btn');
          btn.innerHTML = physicsEnabled ? '<i class="fas fa-bolt"></i> Physics' : '<i class="fas fa-bolt-slash"></i> Physics';

          if (physicsEnabled) {
              simulation.alpha(0.3).restart();
          } else {
              simulation.stop();
          }
      }

      function toggleAnimations() {
          animationsEnabled = !animationsEnabled;
          const btn = document.getElementById('animations-btn');
          if (animationsEnabled) {
              btn.innerHTML = '<i class="fas fa-sparkles"></i> Animations';
              startLinkAnimation();
          } else {
              btn.innerHTML = '<i class="fas fa-ban"></i> Animations';
              stopLinkAnimation();
          }
      }

      // Enhanced animation system with performance optimizations
      function startLinkAnimation() {
          // No need for timer or particles, using CSS animation
          d3.selectAll('.link').classed('highlight', function(d) {
              const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
              const targetId = typeof d.target === 'object' ? d.target.id : d.target;
              return highlightedEdges.has(sourceId + '->' + targetId);
          });
      }

      function stopLinkAnimation() {
          d3.selectAll('.link').classed('highlight', false);
      }

      // Enhanced tooltip functions
      function showTooltip(event, d) {
          if (hoveredNode) hideTooltip(null, hoveredNode);
          hoveredNode = d;

          console.log(hoveredNode);

          const tooltip = document.getElementById('node-tooltip');
          let content = `<div class="node-info-title">${d.label}</div>`;
          content += `<div class="node-state state-${d.state}">${d.state.charAt(0).toUpperCase() + d.state.slice(1).replace('_', ' ')}</div>`;

          const details = d.details || {};

          if (details.resource_type || details.provider) {
              content += `<div class="tooltip-section">`;
              content += `<div class="tooltip-label">Resource</div>`;
              if (details.resource_type) {
                  content += `<div class="tooltip-stat"><span>Type:</span><span>${details.resource_type}</span></div>`;
              }
              if (details.provider) {
                  content += `<div class="tooltip-stat"><span>Provider:</span><span>${details.provider}</span></div>`;
              }
              content += `</div>`;
          }

          if (details.loc) {
              content += `<div class="tooltip-section">`;
              content += `<div class="tooltip-label">Location</div>`;
              content += `<div class="tooltip-value">${details.loc}</div>`;
              content += `</div>`;
          }

          // Dependencies information
          content += `<div class="tooltip-section">`;
          content += `<div class="tooltip-label">Dependencies</div>`;
          content += `<div class="tooltip-stat">
              <span><i class="fas fa-arrow-down"></i> Incoming:</span>
              <span class="badge-incoming">${d.dependencies_in || 0}</span>
          </div>`;
          content += `<div class="tooltip-stat">
              <span><i class="fas fa-arrow-up"></i> Outgoing:</span>
              <span class="badge-outgoing">${d.dependencies_out || 0}</span>
          </div>`;
          content += `</div>`;

          // Reference Count
          if (d.references_count !== undefined) {
              content += `<div class="tooltip-section">`;
              content += `<div class="tooltip-label">References</div>`;
              content += `<div class="tooltip-stat">
                  <span><i class="fas fa-code"></i> Count:</span>
                  <span class="badge-references">${d.references_count}</span>
              </div>`;
              content += `</div>`;
          }

          // Additional details with icons
          if (details.desc) {
              content += `<div class="tooltip-section">`;
              content += `<div class="tooltip-label">
                  <i class="fas fa-info-circle"></i> Description
              </div>`;
              content += `<div class="tooltip-value">${details.desc}</div>`;
              content += `</div>`;
          }

          // Source file details
          if (details.file || details.line) {
              content += `<div class="tooltip-section">`;
              content += `<div class="tooltip-label">
                  <i class="fas fa-file-code"></i> Source
              </div>`;
              if (details.file) {
                  content += `<div class="tooltip-stat">
                      <span>File:</span>
                      <span class="source-file">${details.file}</span>
                  </div>`;
              }
              if (details.line) {
                  content += `<div class="tooltip-stat">
                      <span>Line:</span>
                      <span class="source-line">${details.line}</span>
                  </div>`;
              }
              content += `</div>`;
          }

          // Tags or metadata


          tooltip.innerHTML = content;
          tooltip.style.left = (event.pageX + 15) + 'px';
          tooltip.style.top = (event.pageY + 15) + 'px';
          tooltip.classList.add('show');

          // Enhanced hover effect
          d3.select(event.currentTarget).select('circle')
              .style('filter', `drop-shadow(0 0 15px ${getStateConfig(d.state).glow})`);
      }

      function hideTooltip(event, d) {
          const tooltip = document.getElementById('node-tooltip');
          tooltip.classList.remove('show');

          if (d && !highlightedNodes.has(d.id)) {
              const selector = event ? event.currentTarget : `[data-id="${d.id}"]`;
              d3.select(selector).select('circle')
                  .style('filter', `drop-shadow(0 0 8px ${getStateConfig(d.state).glow})`);
          }
          hoveredNode = null;
      }

      function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
      }

      function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
      }

      function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
      }

      // Enhanced highlight system
      function highlightConnected(event, d) {
          event.stopPropagation();

          if (highlightedNodes.has(d.id)) {
              clearHighlight();
              return;
          }

          clearHighlight();
          highlightedNodes.add(d.id);

          // Get connected nodes from the edge data
          const edges = graphData.edges.filter(edge => {
              const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
              const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
              return sourceId === d.id || targetId === d.id;
          });

          // Add connected nodes and edges to highlight sets
          edges.forEach(edge => {
              const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
              const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
              highlightedNodes.add(sourceId);
              highlightedNodes.add(targetId);
              highlightedEdges.add(`${sourceId}->${targetId}`);
          });

          // Apply highlights
          d3.selectAll('.node').transition().duration(300)
              .style('opacity', n => highlightedNodes.has(n.id) ? 1 : 0.2);

        d3.selectAll('.link').transition().duration(300)
            .style('stroke-opacity', edge => {
                const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                const edgeKey = sourceId + '->' + targetId;
                return highlightedEdges.has(edgeKey) ? 1 : 0.1;
            })
            .style('stroke', edge => {
                const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                const targetId = typeof edge.target === 'object' ? edge.target.id : targetId;
                const edgeKey = sourceId + '->' + targetId;
                const target = nodeMap.get(targetId);
                const config = target ? getNodeConfig(target) : nodeConfig.resource;
                const state = target ? getStateConfig(target.state) : stateConfig.active;

                return highlightedEdges.has(edgeKey) ? state.color : '{{ colors.text_secondary }}';
            })
            .style('stroke-dasharray', edge => {
                const target = typeof edge.target === 'object' ? edge.target : nodeMap.get(edge.target);
                return target && target.state === 'unused' ? '3,3' : 'none';
            })
            .style('stroke-width', edge => {
                const target = typeof edge.target === 'object' ? edge.target : nodeMap.get(edge.target);
                return target && ['orphaned', 'incomplete'].includes(target.state) ? '2px' : '1px';
            });

          // Restart animations for highlighted edges
          if (animationsEnabled) {
              stopLinkAnimation();
              startLinkAnimation();
          }
      }

      function clearHighlight() {
          highlightedNodes.clear();
          highlightedEdges.clear();

          d3.selectAll('.node').transition().duration(300)
              .style('opacity', 1);

          d3.selectAll('.link').transition().duration(300)
              .style('stroke-opacity', 0.4)
              .style('stroke', '{{ colors.text_secondary }}');

          if (animationsEnabled) {
              stopLinkAnimation();
          }
      }

      // Global function exports
      window.filterByType = filterByType;
      window.filterByState = filterByState;
      window.clearFilters = clearFilters;
      window.toggleLegendSection = toggleLegendSection;
      window.resetView = resetView;
      window.zoomIn = zoomIn;
      window.zoomOut = zoomOut;
      window.resetZoom = resetZoom;
      window.centerGraph = centerGraph;
      window.togglePhysics = togglePhysics;
      window.toggleAnimations = toggleAnimations;
      window.clearHighlight = clearHighlight;

      // Initialize on load and resize with debouncing
      let resizeTimer;
      window.addEventListener('resize', () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(init, config.performance.debounceDelay);
      });

      // Add click outside to clear highlights
      document.addEventListener('click', (event) => {
          if (!event.target.closest('.node') && !event.target.closest('.nexus-indicator') && !event.target.closest('.legend-item')) {
              clearHighlight();
          }
      });

      // Command Palette and Quick Actions
      class CommandPalette {
          constructor() {
              this.backdrop = document.getElementById('backdrop');
              this.commandPalette = document.getElementById('commandPalette');
              this.commandInput = document.getElementById('commandInput');
              this.commandList = document.getElementById('commandList');
              this.toastContainer = document.getElementById('toastContainer');
              this.quickActions = document.getElementById('quickActions');
              this.selectedCommandIndex = 0;
              this.isFullscreen = false;

              this.commands = [
                  {
                      id: 'toggle-fullscreen',
                      title: 'Toggle Fullscreen',
                      description: 'Enter or exit fullscreen mode',
                      icon: 'fas fa-expand',
                      shortcut: 'F11',
                      action: () => this.toggleFullscreen()
                  },
                  {
                      id: 'reset-view',
                      title: 'Reset View',
                      description: 'Reset zoom, position and filters',
                      icon: 'fas fa-sync-alt',
                      shortcut: 'R',
                      action: () => resetView()
                  },
                  {
                      id: 'toggle-physics',
                      title: 'Toggle Physics',
                      description: 'Enable/disable graph physics',
                      icon: 'fas fa-bolt',
                      shortcut: 'P',
                      action: () => togglePhysics()
                  },
                  {
                      id: 'center-graph',
                      title: 'Center Graph',
                      description: 'Center the graph in view',
                      icon: 'fas fa-bullseye',
                      shortcut: 'C',
                      action: () => centerGraph()
                  },
                  {
                      id: 'toggle-animations',
                      title: 'Toggle Animations',
                      description: 'Enable/disable graph animations',
                      icon: 'fas fa-sparkles',
                      shortcut: 'A',
                      action: () => toggleAnimations()
                  },
                  {
                      id: 'clear-filters',
                      title: 'Clear Filters',
                      description: 'Remove all active filters',
                      icon: 'fas fa-filter',
                      shortcut: 'F',
                      action: () => clearFilters()
                  },
                  {
                      id: 'show-help',
                      title: 'Show Help',
                      description: 'Display keyboard shortcuts and tips',
                      icon: 'fas fa-question-circle',
                      shortcut: 'H',
                      action: () => this.showHelp()
                  }
              ];

                  // Flags used to pause/resume heavy background work while palette is open
                  this._hadPhysics = false;
                  this._hadAnimations = false;
                  // Allow enabling/disabling backtick key to open palette (can be exposed later)
                  this.enableBacktickKey = true;

                  this.setupEventListeners();
          }

          setupEventListeners() {
              // Keyboard shortcuts
              document.addEventListener('keydown', (e) => this.handleKeyboard(e));

              // Command palette
              this.commandInput.addEventListener('input', () => this.filterCommands());
              this.commandInput.addEventListener('keydown', (e) => this.handleCommandNavigation(e));

              // Quick actions
              this.quickActions.addEventListener('click', (e) => {
                  const action = e.target.closest('.quick-action');
                  if (action) {
                      this.handleQuickAction(action.dataset.action);
                  }
              });

              // Backdrop click
              this.backdrop.addEventListener('click', () => {
                  this.hideCommandPalette();
              });
          }

          handleKeyboard(event) {
              if (event.target.tagName === 'INPUT') return;

              // Global shortcuts
              switch (event.key) {
                  case 'Escape':
                      this.hideCommandPalette();
                      break;
                  case 'F11':
                      event.preventDefault();
                      this.toggleFullscreen();
                      break;
                  case 'k':
                      if (event.ctrlKey || event.metaKey) {
                          event.preventDefault();
                          this.showCommandPalette();
                      }
                      break;
                  case '/':
                      if (!event.ctrlKey && !event.metaKey) {
                          event.preventDefault();
                          this.showCommandPalette();
                      }
                      break;
                  case '`':
                      if (this.enableBacktickKey && !event.ctrlKey && !event.metaKey && !event.altKey) {
                          event.preventDefault();
                          this.showCommandPalette();
                      }
                      break;
                  case 'r':
                  case 'R':
                      if (!event.ctrlKey && !event.metaKey) {
                          event.preventDefault();
                          resetView();
                      }
                      break;
                  case 'p':
                  case 'P':
                      if (!event.ctrlKey && !event.metaKey) {
                          event.preventDefault();
                          togglePhysics();
                      }
                      break;
                  case 'c':
                  case 'C':
                      if (!event.ctrlKey && !event.metaKey) {
                          event.preventDefault();
                          centerGraph();
                      }
                      break;
                  case 'f':
                  case 'F':
                      if (!event.ctrlKey && !event.metaKey) {
                          event.preventDefault();
                          clearFilters();
                      }
                      break;
                  case 'a':
                  case 'A':
                      if (!event.ctrlKey && !event.metaKey) {
                          event.preventDefault();
                          toggleAnimations();
                      }
                      break;
                  case 'h':
                  case 'H':
                      if (!event.ctrlKey && !event.metaKey) {
                          event.preventDefault();
                          this.showHelp();
                      }
                      break;
              }
          }

          showCommandPalette() {
              // Pause heavy background work (physics simulation & animations) to keep UI responsive
              try {
                  this._hadPhysics = (typeof physicsEnabled !== 'undefined' && physicsEnabled === true);
                  if (this._hadPhysics && typeof simulation !== 'undefined' && simulation) {
                      simulation.stop();
                  }
              } catch (err) {
                  // ignore if simulation not available yet
              }

              try {
                  this._hadAnimations = (typeof animationTimer !== 'undefined' && animationTimer !== null);
                  if (this._hadAnimations) {
                      stopLinkAnimation();
                  }
              } catch (err) {
                  // ignore if animation system not available
              }

              this.backdrop.classList.add('show');
              this.commandPalette.classList.add('show');
              this.commandInput.focus();
              this.filterCommands();
          }

          hideCommandPalette() {
              this.backdrop.classList.remove('show');
              this.commandPalette.classList.remove('show');
              this.commandInput.value = '';
              this.selectedCommandIndex = 0;
              // Resume paused background work if it was running before
              try {
                  if (this._hadPhysics && typeof simulation !== 'undefined' && simulation) {
                      // restart simulation with a small alpha to smooth back in
                      simulation.alpha(0.3).restart();
                  }
              } catch (err) {
                  // ignore
              }

              try {
                  if (this._hadAnimations && typeof animationsEnabled !== 'undefined' && animationsEnabled) {
                      startLinkAnimation();
                  }
              } catch (err) {
                  // ignore
              }
          }

          filterCommands() {
              const query = this.commandInput.value.toLowerCase();
              const filteredCommands = this.commands.filter(cmd =>
                  cmd.title.toLowerCase().includes(query) ||
                  cmd.description.toLowerCase().includes(query)
              );
              this.renderCommands(filteredCommands);
          }

          renderCommands(commands) {
              this.commandList.innerHTML = '';
              this.selectedCommandIndex = 0;

              commands.forEach((command, index) => {
                  const item = document.createElement('div');
                  item.className = `command-item ${index === 0 ? 'selected' : ''}`;
                  item.innerHTML = `
                      <div class="command-icon">
                          <i class="${command.icon}"></i>
                      </div>
                      <div class="command-content">
                          <div class="command-title">${command.title}</div>
                          <div class="command-description">${command.description}</div>
                      </div>
                      <div class="command-shortcut-item">${command.shortcut}</div>
                  `;
                  item.addEventListener('click', () => this.executeCommand(command));
                  this.commandList.appendChild(item);
              });
          }

          handleCommandNavigation(event) {
              const items = this.commandList.querySelectorAll('.command-item');

              switch (event.key) {
                  case 'ArrowDown':
                      event.preventDefault();
                      this.selectedCommandIndex = Math.min(this.selectedCommandIndex + 1, items.length - 1);
                      this.updateCommandSelection();
                      break;
                  case 'ArrowUp':
                      event.preventDefault();
                      this.selectedCommandIndex = Math.max(this.selectedCommandIndex - 1, 0);
                      this.updateCommandSelection();
                      break;
                  case 'Enter':
                      event.preventDefault();
                      if (items[this.selectedCommandIndex]) {
                          items[this.selectedCommandIndex].click();
                      }
                      break;
              }
          }

          updateCommandSelection() {
              const items = this.commandList.querySelectorAll('.command-item');
              items.forEach((item, index) => {
                  item.classList.toggle('selected', index === this.selectedCommandIndex);
              });
          }

          executeCommand(command) {
              command.action();
              this.hideCommandPalette();
              this.showToast('Command Executed', command.title, 'success');
          }

          handleQuickAction(action) {
              switch (action) {
                  case 'command':
                      this.showCommandPalette();
                      break;
                  case 'center':
                      centerGraph();
                      break;
                  case 'physics':
                      togglePhysics();
                      break;
                  case 'fullscreen':
                      this.toggleFullscreen();
                      break;
                  case 'help':
                      this.showHelp();
                      break;
              }
          }

          toggleFullscreen() {
              const updateGraph = () => {
                  const container = document.getElementById('graph-container');

                  // Force graph update
                  simulation.alpha(0.3).restart();

                  // Update SVG dimensions
                  const width = container.clientWidth;
                  const height = container.clientHeight;

                  window.svg
                      .attr('width', width)
                      .attr('height', height)
                      .attr('viewBox', [0, 0, width, height]);

                  // Update viewport
                  window.zoom.extent([[0, 0], [width, height]]);
                  window.svg.call(window.zoom.transform, d3.zoomIdentity);

                  // Force relayout
                  simulation.force('center', d3.forceCenter(width / 2, height / 2));
                  simulation.alpha(0.3).restart();
              };

              if (!document.fullscreenElement) {
                  document.documentElement.requestFullscreen().then(() => {
                      this.isFullscreen = true;
                      // Wait for the fullscreen transition to complete
                      setTimeout(updateGraph, 200);
                  }).catch(err => {
                      this.showToast('Fullscreen Error', 'Failed to enter fullscreen mode', 'error');
                  });
              } else {
                  document.exitFullscreen().then(() => {
                      this.isFullscreen = false;
                      // Wait for the fullscreen exit transition to complete
                      setTimeout(updateGraph, 200);
                  });
              }
          }

          showHelp() {
              const helpContent = `Graph View Help & Shortcuts

        Keyboard Shortcuts:
       Ctrl+K / +K - Command palette
       / - Command palette (alternative)
       F11 - Toggle fullscreen
       R - Reset view
       P - Toggle physics
       C - Center graph
       A - Toggle animations
       F - Clear filters
       H - Show this help
       Escape - Close dialogs

       Navigation:
       Click and drag nodes
       Mouse wheel to zoom
       Click node to highlight connections
       Hover node for details
       Click outside to clear highlight

       Quick Actions:
       Command - Open command palette
       Center - Center the graph
       Physics - Toggle graph physics
       Fullscreen - Toggle fullscreen
       Help - Show this guide`;

              console.log(helpContent);
              this.showToast('Help & Shortcuts', 'Check the console for detailed help', 'info');
          }

          showToast(title, message, type = 'info') {
              const toast = document.createElement('div');
              toast.className = `toast ${type}`;

              const icons = {
                  success: 'fas fa-check-circle',
                  error: 'fas fa-exclamation-circle',
                  warning: 'fas fa-exclamation-triangle',
                  info: 'fas fa-info-circle'
              };

              toast.innerHTML = `
                  <div class="toast-icon">
                      <i class="${icons[type] || icons.info}"></i>
                  </div>
                  <div class="toast-content">
                      <div class="toast-title">${title}</div>
                      <div class="toast-message">${message}</div>
                  </div>
                  <button class="toast-close">
                      <i class="fas fa-times"></i>
                  </button>
              `;

              this.toastContainer.appendChild(toast);

              setTimeout(() => toast.classList.add('show'), 10);

              const autoRemove = setTimeout(() => {
                  toast.classList.remove('show');
                  setTimeout(() => toast.remove(), 300);
              }, 5000);

              toast.querySelector('.toast-close').addEventListener('click', () => {
                  clearTimeout(autoRemove);
                  toast.classList.remove('show');
                  setTimeout(() => toast.remove(), 300);
              });
          }
      }

      // Initialize components when DOM is ready
      function initializeComponents() {
          // Initialize Command Palette
          const commandPalette = new CommandPalette();
          window.commandPalette = commandPalette;

          // Initialize the graph
          init();

          // Initialize state indicators
          updateStateIndicators();
          // Update state indicators when window is resized
          window.addEventListener('resize', () => {
              clearTimeout(resizeTimer);
              resizeTimer = setTimeout(() => {
                  updateStateIndicators();
              }, config.performance.debounceDelay);
          });
      }
      // Configuration Viewer Functions
        function toggleConfigViewer() {
            const content = document.getElementById('configContent');
            const chevron = document.getElementById('configChevron');
            
            content.classList.toggle('expanded');
            chevron.classList.toggle('rotated');
        }

        function toggleConfigFile(fileIndex) {
            const body = document.getElementById(`configFileBody-${fileIndex}`);
            const chevron = document.getElementById(`configFileChevron-${fileIndex}`);
            
            body.classList.toggle('expanded');
            chevron.classList.toggle('rotated');
        }

        function getValueType(value) {
            if (Array.isArray(value)) return 'array';
            if (typeof value === 'object' && value !== null) return 'object';
            if (typeof value === 'boolean') return 'boolean';
            if (typeof value === 'number') return 'number';
            return 'string';
        }

        function formatConfigValue(value, indent = 0) {
            const type = getValueType(value);
            const indentStr = '  '.repeat(indent);
            
            if (type === 'object') {
                const entries = Object.entries(value)
                    .map(([k, v]) => `${indentStr}  ${k}: ${formatConfigValue(v, indent + 1)}`)
                    .join('\n');
                return `{\n${entries}\n${indentStr}}`;
            }
            
            if (type === 'array') {
                const items = value
                    .map(v => `${indentStr}  - ${formatConfigValue(v, indent + 1)}`)
                    .join('\n');
                return `[\n${items}\n${indentStr}]`;
            }
            
            if (type === 'boolean') {
                return value ? 'true' : 'false';
            }
            
            if (type === 'string') {
                return `"${value}"`;
            }
            
            return String(value);
        }

        function initializeConfigViewer() {
            const configData = {{ config_data|safe }};
            const configContent = document.getElementById('configContent');
            const configCount = document.getElementById('configCount');
            
            const files = Object.entries(configData);
            configCount.textContent = files.length;
            
            if (files.length === 0) {
                configContent.innerHTML = `
                    <div class="config-empty">
                        <i class="fas fa-inbox"></i>
                        <div>No configuration files found</div>
                    </div>
                `;
                return;
            }
            
            configContent.innerHTML = files.map(([filePath, variables], index) => {
                const fileName = filePath.split('/').pop();
                const varCount = Object.keys(variables).length;
                
                const varsHtml = Object.entries(variables).map(([key, value]) => {
                    const type = getValueType(value);
                    const formattedValue = formatConfigValue(value);
                    
                    return `
                        <div class="config-var">
                            <div class="config-var-key">
                                <i class="fas fa-terminal"></i>
                                ${key}
                                <span class="config-var-type type-${type}">${type}</span>
                            </div>
                            <div class="config-var-value">${formattedValue}</div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="config-file">
                        <div class="config-file-header" onclick="toggleConfigFile(${index})">
                            <div class="config-file-icon">
                                <i class="fas fa-file-code"></i>
                            </div>
                            <div class="config-file-info">
                                <div class="config-file-name" title="${fileName}">${fileName}</div>
                                <div class="config-file-path">
                                    <i class="fas fa-layer-group"></i>
                                    ${varCount} variable${varCount !== 1 ? 's' : ''}
                                </div>
                            </div>
                            <i class="fas fa-chevron-right config-file-chevron" id="configFileChevron-${index}"></i>
                        </div>
                        <div class="config-file-body" id="configFileBody-${index}">
                            <div class="config-variables">
                                ${varsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize config viewer when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initializeConfigViewer();
        });

      // Ensure initialization happens after DOM is ready
      if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initializeComponents);
      } else {
          initializeComponents();
      }
    </script>
  </body>
</html>
