<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurica Auth - Passkey Login</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            position: relative;
            background: #0a0a0a;
            opacity: 0; /* Hide page until auth check completes */
            transition: opacity 0.3s ease-in;
        }
        
        body.loaded {
            opacity: 1; /* Show page after auth check */
        }
        
        /* Import professional fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800;900&display=swap');
        
        /* Full screen split layout */
        .auth-wrapper {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
            background: radial-gradient(ellipse at top, #1a1a2e 0%, #0a0a0a 50%, #000000 100%);
            overflow: hidden;
        }
        
        /* Left side - Carousel area - extends full width behind auth */
        .carousel-side {
            flex: 1;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            overflow: hidden;
            z-index: 1;
            pointer-events: auto; /* Make carousel interactive */
        }
        
        .carousel-side * {
            pointer-events: auto; /* Enable interactions with carousel elements */
        }
        
        /* Background decorations */
        .hero-side {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            background: 
                radial-gradient(circle at 15% 20%, rgba(138, 43, 226, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 85% 80%, rgba(30, 144, 255, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(255, 20, 147, 0.1) 0%, transparent 50%);
        }

        /* Decorations should not capture pointer events and must stay behind UI */
        .hero-side,
        .hero-side .shape {
            pointer-events: none;
            z-index: 1;
        }
        
        /* Right side - Auth form (1/3 width) */
        .form-side-wrapper {
            flex: 0 0 33.333%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background: transparent; /* No background - blend with carousel */
            backdrop-filter: none; /* No blur separator */
            border-left: none; /* No border - seamless flow */
            z-index: 100; /* Always above carousel */
            pointer-events: auto; /* Ensure buttons are clickable */
            position: relative; /* Stack on top of carousel */
            margin-left: auto; /* Push to right side */
        }
        
        /* Carousel Styles */
        .carousel-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            z-index: 2;
        }
        
        .carousel-wrapper {
            position: relative;
            width: 100%;
            overflow: hidden;
        }
        
        .carousel-track {
            display: flex;
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: grab;
            user-select: none;
            pointer-events: auto;
        }
        
        .carousel-track:active {
            cursor: grabbing;
        }
        
        .carousel-slide {
            min-width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 40px;
            z-index: 2;
            position: relative;
        }
        
        .carousel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: auto;
        }
        
        .carousel-dot.active {
            width: 40px;
            border-radius: 5px;
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.8), rgba(30, 144, 255, 0.8));
        }
        
        .carousel-arrow {
            display: none !important; /* Hidden - no visual arrows */
        }
        
        .feature-card {
            background: transparent;
            backdrop-filter: none;
            border: none;
            border-radius: 0;
            padding: 48px 40px;
            text-align: center;
            box-shadow: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.03) 50%,
                transparent 70%
            );
            animation: shimmer 8s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }
        
        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: none;
            border-color: transparent;
        }
        
        .feature-icon {
            font-size: 120px;
            margin-bottom: 40px;
            display: block;
            animation: subtleFloat 6s ease-in-out infinite;
            filter: drop-shadow(0 8px 24px rgba(138, 43, 226, 0.6));
        }
        
        @keyframes subtleFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        
        .feature-title {
            font-size: 56px;
            font-weight: 800;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.95) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 24px;
            letter-spacing: -2px;
            line-height: 1.1;
            text-shadow: 0 4px 20px rgba(138, 43, 226, 0.5);
        }
        
        .feature-description {
            font-size: 22px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 36px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .feature-list-carousel {
            margin-top: 32px;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        
        .feature-list-carousel li {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 19px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.95);
            transition: all 0.3s ease;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: fadeInUp 0.6s ease-out backwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .feature-list-carousel li:nth-child(1) { animation-delay: 0.1s; }
        .feature-list-carousel li:nth-child(2) { animation-delay: 0.2s; }
        .feature-list-carousel li:nth-child(3) { animation-delay: 0.3s; }
        .feature-list-carousel li:nth-child(4) { animation-delay: 0.4s; }
        
        .feature-list-carousel li:hover {
            color: rgba(255, 255, 255, 1);
            transform: translateX(8px);
        }
        
        .feature-list-carousel li::before {
            content: "‚úì";
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.5), rgba(30, 144, 255, 0.5));
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 16px rgba(138, 43, 226, 0.4);
        }
        
        /* Animated gradient overlay */
        .hero-side::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(138, 43, 226, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(30, 144, 255, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 40% 20%, rgba(255, 20, 147, 0.15) 0%, transparent 40%);
            animation: subtleGradientShift 25s ease-in-out infinite;
        }
        
        @keyframes subtleGradientShift {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.05); }
        }
        
        /* Floating geometric shapes */
        .shape {
            position: absolute;
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(30, 144, 255, 0.1));
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: subtleFloat 30s ease-in-out infinite;
            box-shadow: 0 8px 32px 0 rgba(138, 43, 226, 0.2);
            pointer-events: none;
        }
        
        @keyframes subtleFloat {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(10px, -10px) rotate(2deg);
            }
            50% {
                transform: translate(15px, 5px) rotate(-2deg);
            }
            75% {
                transform: translate(-5px, 10px) rotate(1deg);
            }
        }
        
        .shape-1 {
            width: 400px;
            height: 400px;
            top: 5%;
            left: 5%;
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            animation-delay: 0s;
        }
        
        .shape-2 {
            width: 300px;
            height: 300px;
            bottom: 10%;
            right: 10%;
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            animation-delay: -8s;
        }
        
        .shape-3 {
            width: 200px;
            height: 200px;
            top: 50%;
            left: 60%;
            border-radius: 40% 60% 60% 40% / 70% 30% 70% 30%;
            animation-delay: -15s;
        }
        
        @keyframes float {
            0%, 100% { 
                transform: translate(0, 0) rotate(0deg);
            }
            25% { 
                transform: translate(40px, -40px) rotate(90deg);
            }
            50% { 
                transform: translate(20px, 30px) rotate(180deg);
            }
            75% { 
                transform: translate(-30px, 20px) rotate(270deg);
            }
        }
        
        /* Hero content */
        .hero-content {
            position: relative;
            z-index: 2;
            text-align: center;
            color: white;
            padding: 60px;
            max-width: 600px;
        }
        
        /* Auth form container - centered */
        .form-side {
            position: relative;
            z-index: 2;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.5),
                0 0 1px rgba(255, 255, 255, 0.1) inset;
            max-width: 460px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid rgba(138, 43, 226, 0.1);
        }
        
        /* Custom scrollbar */
        .form-side::-webkit-scrollbar {
            width: 4px;
        }
        
        .form-side::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .form-side::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(138, 43, 226, 0.6), rgba(30, 144, 255, 0.6));
            border-radius: 10px;
        }
        
        .form-container {
            padding: 56px 48px;
        }
        
        .form-header {
            margin-bottom: 40px;
            text-align: center;
        }
        
        .brand-logo {
            font-size: 56px;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 12px rgba(138, 43, 226, 0.3));
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .form-title {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #1a1a1a 0%, #4a4a4a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: -1.5px;
        }
        
        .form-subtitle {
            font-size: 15px;
            color: #666;
            font-weight: 400;
            letter-spacing: 0.2px;
        }
        
        .device-badge {
            display: none;
        }
        
        .hidden { display: none !important; }
        
        /* Desktop/Mobile specific buttons */
        .desktop-only {
            display: block;
        }
        
        .mobile-only {
            display: none;
        }
        
        /* Primary action styling for prominence */
        .primary-action {
            background: linear-gradient(135deg, #8a2be2 0%, #1e90ff 100%);
            color: white;
            font-size: 18px;
            font-weight: 700;
            padding: 20px 32px;
            border: none;
            box-shadow: 0 8px 24px rgba(138, 43, 226, 0.4);
        }
        
        .primary-action:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(138, 43, 226, 0.5);
        }
        
        /* QR Code Modal Styles */
        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        
        .qr-modal:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }
        
        .qr-content {
            background: white;
            border-radius: 24px;
            padding: 48px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.5);
        }
        
        .qr-content h3 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #8a2be2 0%, #1e90ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .qr-instruction {
            font-size: 16px;
            color: #666;
            margin-bottom: 32px;
        }
        
        .qr-code-container {
            background: #f5f5f5;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            min-height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qr-code-container canvas,
        .qr-code-container img {
            max-width: 100%;
            height: auto;
        }
        
        .loading-spinner {
            color: #999;
            font-size: 16px;
        }
        
        /* Registration form styling - Full screen overlay with slide-up animation */
        #registration-form {
            position: fixed;
            top: 0;
            right: 0;
            width: 33.333%;
            bottom: 0;
            z-index: 2000;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
            overflow: hidden;
        }
        
        #registration-form.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        #registration-form:not(.hidden) {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        
        /* When registration form is open, push carousel content to top 1/3 (DISABLED ON DESKTOP) */
        
        body.registration-open .form-side-wrapper {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        /* Slide-up animation for the form container - takes 2/3 of viewport */
        #registration-form .form-side {
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-width: 100%;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 32px;
            overflow-y: auto;
            position: relative;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.5),
                0 0 1px rgba(255, 255, 255, 0.1) inset;
            border: 1px solid rgba(138, 43, 226, 0.1);
            padding: 56px 48px;
        }
        
        #registration-form:not(.hidden) .form-side {
            transform: translateX(0);
        }
        
        #registration-form h2 {
            text-align: center;
            color: #333;
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 700;
        }
        
        /* Buttons */
        button {
            width: 100%;
            padding: 18px 32px;
            background: linear-gradient(135deg, rgba(138, 43, 226, 1) 0%, rgba(30, 144, 255, 1) 100%);
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 12px;
            box-shadow: 
                0 8px 24px rgba(138, 43, 226, 0.4),
                0 4px 12px rgba(30, 144, 255, 0.2);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.3px;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(30, 144, 255, 1) 0%, rgba(138, 43, 226, 1) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        button:hover:not(:disabled)::before {
            opacity: 1;
        }
        
        button span {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        button:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 
                0 16px 32px rgba(138, 43, 226, 0.5),
                0 8px 16px rgba(30, 144, 255, 0.3);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled { 
            background: linear-gradient(135deg, #e0e0e0 0%, #c0c0c0 100%);
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        
        button.secondary {
            background: transparent;
            color: #666;
            border: 2px solid #e8e8e8;
            margin-top: 12px;
            box-shadow: none;
        }
        
        button.secondary::before {
            background: #f8f8f8;
        }
        
        button.secondary:hover:not(:disabled) {
            border-color: rgba(138, 43, 226, 0.3);
            color: rgba(138, 43, 226, 1);
            box-shadow: 0 8px 24px rgba(138, 43, 226, 0.15);
        }
        
        .divider {
            text-align: center;
            margin: 32px 0;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(138, 43, 226, 0.2), transparent);
        }
        
        .divider span {
            background: rgba(255, 255, 255, 0.98);
            padding: 0 20px;
            position: relative;
            color: #999;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        /* Form inputs */
        .form-group { 
            margin-bottom: 24px;
        }
        
        label { 
            display: block; 
            margin-bottom: 10px; 
            font-weight: 600; 
            color: #2a2a2a; 
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        
        input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fafafa;
            font-family: inherit;
            color: #1a1a1a;
        }
        
        input:focus { 
            outline: none; 
            border-color: rgba(138, 43, 226, 0.5);
            background: white;
            box-shadow: 0 0 0 4px rgba(138, 43, 226, 0.08);
            transform: translateY(-1px);
        }
        
        input::placeholder {
            color: #bbb;
        }
        
        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,.25);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        /* Messages */
        .message {
            margin-top: 20px;
            padding: 14px 18px;
            border-radius: 10px;
            display: none;
            font-size: 14px;
            font-weight: 600;
            animation: slideInDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        #registration-form .message {
            margin-top: 16px;
        }
        
        @keyframes slideInDown {
            from { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .message.success { 
            background: linear-gradient(135deg, #d4edda 0%, #e8f5e9 100%);
            color: #155724; 
            border: 2px solid #c3e6cb;
            border-left: 4px solid #28a745;
        }
        
        .message.error { 
            background: linear-gradient(135deg, #f8d7da 0%, #ffe5e8 100%);
            color: #721c24; 
            border: 2px solid #f5c6cb;
            border-left: 4px solid #dc3545;
        }
        
        .message.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #fffbf0 100%);
            color: #856404;
            border: 2px solid #ffc107;
            border-left: 4px solid #ff9800;
        }
        
        .info {
            display: none;
        }
        
        .warning {
            background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%);
            color: #856404;
            border: 2px solid #ffc107;
            border-left: 4px solid #ff9800;
            padding: 16px;
            border-radius: 10px;
            font-size: 13px;
            margin-top: 16px;
            line-height: 1.6;
        }
        
        .feature-list {
            display: none;
        }
        
        .help-link {
            text-align: center;
            margin-top: 28px;
            padding-top: 28px;
            border-top: 1px solid rgba(138, 43, 226, 0.1);
        }
        
        .help-link a {
            color: rgba(138, 43, 226, 0.9);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 20px;
            border-radius: 50px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .help-link a:hover {
            background: rgba(138, 43, 226, 0.08);
            transform: translateY(-1px);
        }
        
        /* Mobile Responsive */
        @media (max-width: 1024px) {
            /* Mobile: Show passkey button, hide scan button */
            .desktop-only {
                display: none;
            }
            
            .mobile-only {
                display: block;
            }
            
            .auth-wrapper {
                flex-direction: column;
            }
            
            .carousel-side {
                flex: 1;
                padding: 40px 30px 20px;
                min-height: calc(100vh - 140px);
                overflow: visible; /* Prevent content from being cut off */
            }
            
            /* Mobile: pin the auth bar to the bottom so buttons are always visible and clickable */
            .form-side-wrapper {
                position: fixed;
                left: 12px;
                right: 12px;
                bottom: 16px;
                z-index: 999;
                display: flex;
                justify-content: center;
                align-items: center;
                flex: 0 0 auto;
                padding: 12px 16px;
                max-width: 820px;
                margin: 0 auto;
                background: rgba(10, 10, 10, 0.85);
                backdrop-filter: blur(14px) saturate(1.1);
                border-radius: 14px;
                border: 1px solid rgba(255, 255, 255, 0.12);
                box-shadow: 0 10px 30px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05) inset;
                touch-action: manipulation;
                will-change: auto;
            }
            
            .carousel-container {
                max-width: 500px;
            }
            
            .form-side {
                max-width: 100%;
                border-radius: 0;
                max-height: none;
                background: transparent;
                backdrop-filter: none;
                box-shadow: none;
                border: none;
            }
            
            .form-container {
                padding: 0;
            }
            
            .form-header {
                display: none;
            }
            
            #auth-section {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            button {
                padding: 18px 24px;
                font-size: 16px;
                font-weight: 600;
                margin-top: 0;
                border-radius: 14px;
            }
            
            button.secondary {
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                color: white;
                border: 2px solid rgba(255, 255, 255, 0.4);
                font-weight: 600;
            }
            
            button.secondary:hover:not(:disabled) {
                background: rgba(255, 255, 255, 0.25);
                border-color: rgba(255, 255, 255, 0.5);
            }
            
            .divider {
                display: none;
            }
            
            .help-link {
                display: none;
            }
            
            /* Registration form on mobile - overlay with slide-up */
            #registration-form {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                z-index: 2000;
                background: transparent;
                backdrop-filter: none;
                padding: 0;
                display: flex;
                align-items: flex-end;
                justify-content: center;
                overflow: hidden;
            }
            
            /* Mobile: Push carousel to top 1/3 when registration opens */
            body.registration-open .carousel-side {
                transform: translateY(-33.333vh) scale(0.85);
                transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
                pointer-events: none;
            }
            
            /* Position icon as background element on the left */
            body.registration-open .feature-icon {
                position: absolute;
                left: -30px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 180px;
                opacity: 0.15;
                z-index: 0;
                margin: 0;
                transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }
            
            /* Stack layout to allow icon as background */
            body.registration-open .feature-card {
                position: relative;
                display: block;
                text-align: left;
                padding-left: 20px;
                transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }
            
            body.registration-open .feature-content {
                position: relative;
                z-index: 1;
                width: 100%;
            }
            
            /* Reduce fonts by 30% when scaled */
            body.registration-open .feature-title {
                font-size: 39px; /* 56px * 0.7 */
                transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }
            
            body.registration-open .feature-description {
                font-size: 15.4px; /* 22px * 0.7 */
                transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }
            
            body.registration-open .feature-list-carousel li {
                font-size: 13.3px; /* 19px * 0.7 */
                transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }
            
            /* Shift entire card content left for better composition */
            body.registration-open .feature-card {
                transform: translateX(-30px);
                transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }
            
            #registration-form .form-side {
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                border-radius: 24px 24px 0 0;
                box-shadow: 0 -10px 60px rgba(0, 0, 0, 0.5);
                border: 1px solid rgba(138, 43, 226, 0.2);
                border-bottom: none;
                padding: 32px 24px 40px;
                max-width: 100%;
                width: 100%;
                height: 66.666vh;
                margin: 0;
                overflow-y: auto;
                transform: translateY(100%);
            }
            
            #registration-form:not(.hidden) .form-side {
                transform: translateY(0);
            }
            
            #registration-form h2 {
                color: #333;
                margin-bottom: 24px;
                font-size: 24px;
            }
            
            #registration-form button {
                background: linear-gradient(135deg, rgba(138, 43, 226, 1) 0%, rgba(30, 144, 255, 1) 100%);
                color: white;
                border: none;
            }
            
            #registration-form button.secondary {
                background: transparent;
                color: #666;
                border: 2px solid #e8e8e8;
            }
            
            .feature-icon {
                font-size: 72px;
            }
            
            .feature-title {
                font-size: 32px;
            }
            
            .feature-description {
                font-size: 16px;
            }
            
            .feature-list-carousel {
                margin-top: 20px;
                gap: 12px;
            }
            
            .feature-list-carousel li {
                font-size: 15px;
            }
            
            .carousel-arrow {
                width: 44px;
                height: 44px;
                font-size: 22px;
            }
            
            .carousel-arrow.left {
                left: 10px;
            }
            
            .carousel-arrow.right {
                right: 10px;
            }
            
            .carousel-dots {
                margin-top: 24px;
                margin-bottom: 0;
            }
        }
        
        @media (max-width: 600px) {
            .carousel-side {
                flex: 1;
                padding: 30px 20px 20px;
                min-height: calc(100vh - 120px);
            }
            
            /* Tighter spacing on very small screens; keep pinned at bottom */
            .form-side-wrapper {
                position: fixed;
                left: 8px;
                right: 8px;
                bottom: 12px;
                z-index: 999;
                padding: 10px 12px;
                border-radius: 12px;
                max-width: 760px;
                background: rgba(10,10,10,0.9);
                backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.15);
                box-shadow: 0 8px 24px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.08) inset;
            }
            
            /* Add protective backdrop to ensure buttons are always visible */
            .form-side-wrapper::before {
                content: '';
                position: absolute;
                top: -60px;
                left: -20px;
                right: -20px;
                bottom: -20px;
                background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.4) 30%, rgba(0,0,0,0.7) 100%);
                z-index: -1;
                pointer-events: none;
                border-radius: 20px 20px 12px 12px;
            }
            
            button {
                padding: 16px 20px;
                font-size: 15px;
                font-weight: 600;
                border-radius: 12px;
            }
            
            #auth-section {
                gap: 10px;
            }
            
            /* Registration form on mobile - compact version */
            #registration-form {
                padding: 0;
                align-items: flex-end;
                z-index: 2000;
            }
            
            #registration-form .form-side {
                padding: 28px 20px 36px;
                border-radius: 20px 20px 0 0;
                border-bottom: none;
                height: 66.666vh;
                max-width: 100%;
                transform: translateY(100%);
            }
            
            #registration-form:not(.hidden) .form-side {
                transform: translateY(0);
            }
            
            #registration-form h2 {
                font-size: 22px;
                margin-bottom: 20px;
            }
            
            .feature-card {
                padding: 24px 16px;
            }
            
            .feature-icon {
                font-size: 64px;
                margin-bottom: 20px;
            }
            
            .feature-title {
                font-size: 26px;
                margin-bottom: 12px;
            }
            
            .feature-description {
                font-size: 14px;
                margin-bottom: 20px;
            }
            
            .feature-list-carousel {
                margin-top: 16px;
                gap: 10px;
            }
            
            .feature-list-carousel li {
                font-size: 13px;
                gap: 10px;
            }
            
            .feature-list-carousel li::before {
                min-width: 22px;
                height: 22px;
                font-size: 12px;
            }
            
            .carousel-arrow {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .carousel-dots {
                margin-top: 20px;
            }
            
            .carousel-dot {
                width: 8px;
                height: 8px;
            }
            
            .carousel-dot.active {
                width: 32px;
            }
            
            /* Form adjustments for mobile */
            .form-group {
                margin-bottom: 16px;
            }
            
            label {
                font-size: 13px;
                margin-bottom: 8px;
            }
            
            input {
                padding: 13px 16px;
                font-size: 14px;
            }
            
            .message {
                font-size: 13px;
                padding: 12px 16px;
                margin-top: 16px;
            }
            
            .warning {
                font-size: 12px;
                padding: 12px;
                margin-top: 12px;
            }
            
            /* Make auth buttons easy to tap and always on top */
            .form-side-wrapper #auth-section {
                display: flex;
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            
            .form-side-wrapper button,
            .form-side-wrapper button.secondary {
                width: 100%;
                pointer-events: auto;
                transform: none !important; /* Prevent animation transforms from affecting buttons */
            }
            
            /* Ensure feature-card floating/animation doesn't overlay the auth bar */
            .feature-card {
                pointer-events: none; /* allow clicks to pass through when overlapping */
            }
            
            /* DISABLE ALL ANIMATIONS ON MOBILE - they interfere with button visibility */
            *,
            *::before,
            *::after {
                animation: none !important;
                transition: none !important;
            }
            
            /* Re-enable only essential carousel transition */
            .carousel-track {
                transition: transform 0.3s ease !important;
            }
            
            /* Static positioning for all decorative elements on mobile */
            .hero-side,
            .hero-side::before,
            .shape,
            .feature-icon,
            .feature-card,
            .brand-logo {
                animation: none !important;
                transform: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="auth-wrapper">
        <!-- Background decorations -->
        <div class="hero-side">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
        </div>
        
        <!-- Left side - Carousel -->
        <div class="carousel-side">
            <div class="carousel-container">
                <div class="carousel-wrapper">
                    <div class="carousel-track" id="carouselTrack">
                        <!-- Slide 1: Welcome -->
                        <div class="carousel-slide">
                            <div class="feature-card">
                                <span class="feature-icon">üîê</span>
                                <div class="feature-content">
                                    <h2 class="feature-title">Secure Authentication</h2>
                                    <p class="feature-description">Experience passwordless login with cutting-edge passkey technology</p>
                                    <ul class="feature-list-carousel">
                                        <li>No passwords to remember</li>
                                        <li>Biometric authentication</li>
                                        <li>Phishing-resistant security</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slide 2: Multi-Device -->
                        <div class="carousel-slide">
                            <div class="feature-card">
                                <span class="feature-icon">üì±</span>
                                <div class="feature-content">
                                    <h2 class="feature-title">Multi-Device Access</h2>
                                    <p class="feature-description">Sign in seamlessly across all your devices</p>
                                    <ul class="feature-list-carousel">
                                        <li>Desktop & mobile support</li>
                                        <li>Sync across devices</li>
                                        <li>One account, everywhere</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slide 3: Fast & Easy -->
                        <div class="carousel-slide">
                            <div class="feature-card">
                                <span class="feature-icon">‚ö°</span>
                                <div class="feature-content">
                                    <h2 class="feature-title">Lightning Fast</h2>
                                    <p class="feature-description">Login in seconds with just a tap or touch</p>
                                    <ul class="feature-list-carousel">
                                        <li>Instant authentication</li>
                                        <li>No typing required</li>
                                        <li>Works offline</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slide 4: Privacy -->
                        <div class="carousel-slide">
                            <div class="feature-card">
                                <span class="feature-icon">üõ°Ô∏è</span>
                                <div class="feature-content">
                                    <h2 class="feature-title">Privacy First</h2>
                                    <p class="feature-description">Your data stays secure on your device</p>
                                    <ul class="feature-list-carousel">
                                        <li>End-to-end encryption</li>
                                        <li>No password databases</li>
                                        <li>Bank-level security</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Slide 5: Apps -->
                        <div class="carousel-slide">
                            <div class="feature-card">
                                <span class="feature-icon">üöÄ</span>
                                <div class="feature-content">
                                    <h2 class="feature-title">Access Your Apps</h2>
                                    <p class="feature-description">Unlock powerful features after signing in</p>
                                    <ul class="feature-list-carousel">
                                        <li>Personalized dashboard</li>
                                        <li>App management</li>
                                        <li>Profile customization</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="carousel-dots" id="carouselDots"></div>
                </div>
                
                <div class="carousel-arrow left" id="carouselPrev">‚Äπ</div>
                <div class="carousel-arrow right" id="carouselNext">‚Ä∫</div>
            </div>
        </div>
        
        <!-- Right side - Auth form (1/3 width) -->
        <div class="form-side-wrapper">
            <div class="form-side">
                <div class="form-container">
                    <div class="form-header">
                        <div class="brand-logo">üîê</div>
                        <h2 class="form-title" id="main-title">Sign In</h2>
                        <p class="form-subtitle" id="main-subtitle">Use your device to login securely</p>
                    </div>

                    <!-- Main Authentication Section -->
                    <div id="auth-section">
                        <!-- Desktop: Scan to Login (Primary) -->
                        <button id="scan-login-btn" class="desktop-only primary-action" onclick="showQRCode()">
                            <span>
                                <span>üì±</span>
                                <span>Scan to Login</span>
                            </span>
                        </button>

                        <!-- Mobile: Passkey Login (Primary) -->
                        <button id="passkey-login-btn" class="mobile-only primary-action" onclick="handleLogin()">
                            <span id="passkey-login-btn-text">
                                <span>üîë</span>
                                <span>Sign In with Passkey</span>
                            </span>
                        </button>

                        <!-- Desktop: Passkey Login (Secondary) -->
                        <button id="desktop-passkey-btn" class="desktop-only secondary" onclick="handleLogin()">
                            <span id="desktop-passkey-btn-text">
                                <span>üîë</span>
                                <span>Sign In with Passkey</span>
                            </span>
                        </button>

                        <div class="divider"><span>or</span></div>

                        <button class="secondary" id="register-btn" onclick="showRegistrationForm()">
                            <span>
                                <span>‚ú®</span>
                                <span>Create New Account</span>
                            </span>
                        </button>
                    </div>

                    <!-- QR Code Modal for Desktop Scan Login -->
                    <div id="qr-modal" class="qr-modal hidden">
                        <div class="qr-content">
                            <h3>Scan to Login</h3>
                            <p class="qr-instruction">Use your logged-in mobile app to scan this QR code</p>
                            <div id="qr-code-container" class="qr-code-container">
                                <div class="loading-spinner">Generating QR code...</div>
                            </div>
                            <button class="secondary" onclick="closeQRCode()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Form Overlay (Outside auth-wrapper for proper z-index layering) -->
    <div id="registration-form" class="hidden">
        <div class="form-side">
            <!-- Drag handle indicator -->
            <div style="text-align: center; padding: 12px 0 8px; cursor: pointer;" onclick="showAuthSection()">
                <div style="width: 40px; height: 4px; background: rgba(0,0,0,0.3); border-radius: 2px; margin: 0 auto;"></div>
            </div>
            <h2>Create Your Account</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="reg-username">Username:</label>
                    <input type="text" id="reg-username" placeholder="your_username" required minlength="3">
                </div>
                <div class="form-group">
                    <label for="reg-email">Email:</label>
                    <input type="email" id="reg-email" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label for="reg-display-name">Display Name:</label>
                    <input type="text" id="reg-display-name" placeholder="Your Full Name" required>
                </div>
                <button type="submit">
                    <span id="register-form-btn-text">‚ú® Create Account with Passkey</span>
                </button>
                <button type="button" class="secondary" onclick="showAuthSection()">
                    ‚Üê Back to Sign In
                </button>
            </form>
            
            <div id="mobile-warning" class="warning hidden">
                <strong>‚ö†Ô∏è Mobile Device Limit:</strong><br>
                Only one account can be registered per mobile device for security. If you already have an account on this device, please sign in instead.
            </div>
            
            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        // ==================== CAROUSEL FUNCTIONALITY ====================
        const carouselTrack = document.getElementById('carouselTrack');
        const carouselDots = document.getElementById('carouselDots');
        const carouselPrev = document.getElementById('carouselPrev');
        const carouselNext = document.getElementById('carouselNext');
        
        let currentSlide = 0;
        const slides = document.querySelectorAll('.carousel-slide');
        const totalSlides = slides.length;
        
        // Auto-advance carousel
        let autoAdvanceInterval;
        const AUTO_ADVANCE_DELAY = 5000; // 5 seconds
        
        // Touch/drag support
        let isDragging = false;
        let startPos = 0;
        let currentTranslate = 0;
        let prevTranslate = 0;
        let animationID = 0;
        
        // Create dots
        function createDots() {
            carouselDots.innerHTML = '';
            for (let i = 0; i < totalSlides; i++) {
                const dot = document.createElement('div');
                dot.className = 'carousel-dot';
                if (i === 0) dot.classList.add('active');
                dot.addEventListener('click', () => goToSlide(i));
                carouselDots.appendChild(dot);
            }
        }
        
        // Update dots
        function updateDots() {
            const dots = carouselDots.querySelectorAll('.carousel-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentSlide);
            });
        }
        
        // Go to specific slide
        function goToSlide(index) {
            currentSlide = index;
            const translateValue = -currentSlide * 100;
            carouselTrack.style.transform = `translateX(${translateValue}%)`;
            updateDots();
            resetAutoAdvance();
        }
        
        // Next slide
        function nextSlide() {
            currentSlide = (currentSlide + 1) % totalSlides;
            goToSlide(currentSlide);
        }
        
        // Previous slide
        function prevSlide() {
            currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
            goToSlide(currentSlide);
        }
        
        // Auto advance - DISABLED for page-level carousel
        function startAutoAdvance() {
            // Disabled
        }
        
        function resetAutoAdvance() {
            // Disabled
        }
        
        // Touch/Mouse drag support
        function touchStart(index) {
            return function(event) {
                isDragging = true;
                startPos = getPositionX(event);
                animationID = requestAnimationFrame(animation);
                carouselTrack.style.cursor = 'grabbing';
            }
        }
        
        function touchMove(event) {
            if (isDragging) {
                const currentPosition = getPositionX(event);
                currentTranslate = prevTranslate + currentPosition - startPos;
            }
        }
        
        function touchEnd() {
            isDragging = false;
            cancelAnimationFrame(animationID);
            carouselTrack.style.cursor = 'grab';
            
            const movedBy = currentTranslate - prevTranslate;
            
            // If moved enough, go to next/prev slide
            if (movedBy < -100 && currentSlide < totalSlides - 1) {
                nextSlide();
            } else if (movedBy > 100 && currentSlide > 0) {
                prevSlide();
            } else {
                goToSlide(currentSlide);
            }
            
            prevTranslate = -currentSlide * carouselTrack.offsetWidth;
        }
        
        function getPositionX(event) {
            return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX;
        }
        
        function animation() {
            if (isDragging) {
                const slideWidth = carouselTrack.offsetWidth;
                const maxTranslate = -(totalSlides - 1) * slideWidth;
                const boundedTranslate = Math.max(Math.min(currentTranslate, 0), maxTranslate);
                carouselTrack.style.transform = `translateX(${boundedTranslate}px)`;
                requestAnimationFrame(animation);
            }
        }
        
        // Initialize carousel
        function initCarousel() {
            createDots();
            startAutoAdvance();
            
            // Arrow navigation
            carouselPrev.addEventListener('click', prevSlide);
            carouselNext.addEventListener('click', nextSlide);
            
            // Keyboard navigation - DISABLED for page-level carousel
            // Users navigate using buttons on each slide
            
            // Touch/Mouse drag
            carouselTrack.addEventListener('mousedown', touchStart(0));
            carouselTrack.addEventListener('touchstart', touchStart(0));
            carouselTrack.addEventListener('mousemove', touchMove);
            carouselTrack.addEventListener('touchmove', touchMove);
            carouselTrack.addEventListener('mouseup', touchEnd);
            carouselTrack.addEventListener('touchend', touchEnd);
            carouselTrack.addEventListener('mouseleave', () => {
                if (isDragging) touchEnd();
            });
            
            // Pause on hover
            const carouselContainer = document.querySelector('.carousel-container');
            carouselContainer.addEventListener('mouseenter', () => {
                clearInterval(autoAdvanceInterval);
            });
            carouselContainer.addEventListener('mouseleave', () => {
                startAutoAdvance();
            });
        }
        
        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCarousel);
        } else {
            initCarousel();
        }
        
        // ==================== AUTH FUNCTIONALITY ====================
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let hasShownMobileWarning = false;
        let qrPollInterval = null;
        let currentSessionId = null;

        // QR Code Login Functions
        async function showQRCode() {
            const modal = document.getElementById('qr-modal');
            const container = document.getElementById('qr-code-container');
            
            try {
                modal.classList.remove('hidden');
                container.innerHTML = '<div class="loading-spinner">Generating QR code...</div>';
                
                console.log('Creating QR session...');
                
                // Step 1: Create a login session
                const sessionRes = await fetch('/auth-app/api/authenticate/create-qr-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                
                console.log('Session response status:', sessionRes.status);
                
                if (!sessionRes.ok) {
                    const errorText = await sessionRes.text();
                    console.error('Session creation failed:', errorText);
                    throw new Error(`Failed to create QR session: ${sessionRes.status} ${errorText}`);
                }
                
                const data = await sessionRes.json();
                console.log('Session data:', data);
                
                const { session_id, qr_data } = data;
                currentSessionId = session_id;
                
                // Step 2: Generate QR code
                container.innerHTML = '';
                const qrCode = document.createElement('div');
                qrCode.style.cssText = 'background: white; padding: 16px; border-radius: 12px; display: inline-block;';
                
                // Use QRCode library if available, otherwise show text
                if (typeof QRCode !== 'undefined') {
                    console.log('Using QRCode library');
                    try {
                        new QRCode(qrCode, {
                            text: qr_data,
                            width: 256,
                            height: 256,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    } catch (qrError) {
                        console.error('QRCode library error:', qrError);
                        // Fall back to text display
                        qrCode.innerHTML = `
                            <div style="font-size: 12px; color: #666; max-width: 256px; word-wrap: break-word;">
                                <p><strong>QR Code URL:</strong></p>
                                <a href="${qr_data}" style="display: block; margin-top: 8px; padding: 8px; background: #f0f0f0; border-radius: 4px; word-break: break-all;">${qr_data}</a>
                                <p style="margin-top: 12px; font-size: 11px;">Click the link above on your mobile device to authenticate</p>
                            </div>
                        `;
                    }
                } else {
                    console.warn('QRCode library not available, showing link instead');
                    // Fallback: create clickable link
                    qrCode.innerHTML = `
                        <div style="font-size: 12px; color: #666; max-width: 256px; word-wrap: break-word;">
                            <p><strong>Scan to Login URL:</strong></p>
                            <a href="${qr_data}" target="_blank" style="display: block; margin-top: 8px; padding: 12px; background: #f0f0f0; border-radius: 4px; word-break: break-all; text-decoration: none; color: #1e90ff;">${qr_data}</a>
                            <p style="margin-top: 12px; font-size: 11px; color: #999;">Click the link above on your mobile device to authenticate</p>
                        </div>
                    `;
                }
                
                container.appendChild(qrCode);
                
                // Step 3: Start polling for authentication
                startQRPolling(session_id);
                
            } catch (error) {
                console.error('QR code error:', error);
                container.innerHTML = `
                    <div style="color: #d32f2f; padding: 20px; text-align: center;">
                        <p style="font-weight: bold; margin-bottom: 8px;">‚ùå Failed to generate QR code</p>
                        <p style="font-size: 13px;">${error.message}</p>
                        <button onclick="closeQRCode()" style="margin-top: 16px; padding: 8px 16px; background: #e0e0e0; border: none; border-radius: 8px; cursor: pointer;">Close</button>
                    </div>
                `;
            }
        }
        
        function closeQRCode() {
            const modal = document.getElementById('qr-modal');
            modal.classList.add('hidden');
            stopQRPolling();
        }
        
        async function startQRPolling(sessionId) {
            stopQRPolling(); // Clear any existing polling
            
            qrPollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/auth-app/api/authenticate/check-qr-session/${sessionId}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.authenticated) {
                            stopQRPolling();
                            closeQRCode();
                            
                            // Store session info
                            localStorage.setItem('auth_token', result.token);
                            localStorage.setItem('username', result.username);
                            localStorage.setItem('user_id', result.user_id);
                            
                            showMessage(`‚úÖ Welcome back, ${result.username}!`, 'success');
                            
                            // Handle redirect
                            handlePostLoginRedirect(result);
                        }
                    }
                } catch (error) {
                    console.error('QR polling error:', error);
                }
            }, 2000); // Poll every 2 seconds
        }
        
        function stopQRPolling() {
            if (qrPollInterval) {
                clearInterval(qrPollInterval);
                qrPollInterval = null;
            }
        }
        
        function handlePostLoginRedirect(result) {
            const savedRedirectUri = sessionStorage.getItem('redirect_uri');
            const savedState = sessionStorage.getItem('redirect_state');
            
            sessionStorage.removeItem('redirect_uri');
            sessionStorage.removeItem('redirect_state');
            
            if (savedRedirectUri) {
                setTimeout(() => {
                    const separator = savedRedirectUri.includes('?') ? '&' : '?';
                    let redirectUrl = `${savedRedirectUri}${separator}token=${encodeURIComponent(result.token)}`;
                    if (savedState) {
                        redirectUrl += `&state=${encodeURIComponent(savedState)}`;
                    }
                    window.location.href = redirectUrl;
                }, 1000);
            } else {
                const returnUrl = sessionStorage.getItem('return_url');
                sessionStorage.removeItem('return_url');
                
                setTimeout(() => {
                    window.location.href = returnUrl || '/auth-app/static/welcome.html';
                }, 1000);
            }
        }

        // Check WebAuthn support
        if (!window.PublicKeyCredential) {
            alert('‚ö†Ô∏è Passkeys are not supported in this browser. Please use a modern browser like Chrome, Safari, Edge, or Firefox.');
        }

        // Update UI based on device type
        window.addEventListener('DOMContentLoaded', () => {
            const mainTitle = document.getElementById('main-title');
            const mainSubtitle = document.getElementById('main-subtitle');
            
            if (isMobile) {
                if (mainSubtitle) mainSubtitle.textContent = 'Tap to sign in with your passkey';
            } else {
                if (mainSubtitle) mainSubtitle.textContent = 'Scan with your phone or use passkey';
            }
        });

        // Show mobile warning when registration form is visible
        window.addEventListener('DOMContentLoaded', () => {
            if (isMobile) {
                const observer = new MutationObserver(() => {
                    const regForm = document.getElementById('registration-form');
                    const mobileWarning = document.getElementById('mobile-warning');
                    if (!regForm.classList.contains('hidden') && !hasShownMobileWarning) {
                        mobileWarning.classList.remove('hidden');
                        hasShownMobileWarning = true;
                    }
                });
                observer.observe(document.getElementById('registration-form'), { attributes: true, attributeFilter: ['class'] });
            }
        });

        // Navigation functions
        function showRegistrationForm() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('registration-form').classList.remove('hidden');
            document.body.classList.add('registration-open');
            hideMessage();
        }

        function showAuthSection() {
            document.getElementById('registration-form').classList.add('hidden');
            document.getElementById('auth-section').classList.remove('hidden');
            document.body.classList.remove('registration-open');
            hideMessage();
            document.getElementById('registerForm').reset();
        }
        
        // Close registration form when clicking on backdrop
        document.addEventListener('DOMContentLoaded', () => {
            const regForm = document.getElementById('registration-form');
            regForm.addEventListener('click', (e) => {
                // If clicking on the backdrop (not the form itself), close it
                if (e.target === regForm) {
                    showAuthSection();
                }
            });
        });

        // Message functions
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.style.display = 'block';
            msg.className = 'message ' + type;
            msg.textContent = text;
        }

        function hideMessage() {
            const msg = document.getElementById('message');
            if (msg) msg.style.display = 'none';
        }

        // WebAuthn helper functions
        function base64urlToUint8Array(base64url) {
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            const padLen = (4 - (base64.length % 4)) % 4;
            const padded = base64 + '='.repeat(padLen);
            const binary = atob(padded);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes;
        }

        function uint8ArrayToBase64url(uint8Array) {
            let binary = '';
            for (let i = 0; i < uint8Array.byteLength; i++) {
                binary += String.fromCharCode(uint8Array[i]);
            }
            return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // Login Handler
        async function handleLogin() {
            // Support both desktop and mobile buttons
            const desktopBtn = document.getElementById('desktop-passkey-btn');
            const mobileBtn = document.getElementById('passkey-login-btn');
            const btn = desktopBtn && !desktopBtn.classList.contains('desktop-only') ? desktopBtn : mobileBtn;
            
            const desktopBtnText = document.getElementById('desktop-passkey-btn-text');
            const mobileBtnText = document.getElementById('passkey-login-btn-text');
            const btnText = desktopBtnText || mobileBtnText;
            
            const originalText = btnText ? btnText.textContent : 'Sign In with Passkey';
            
            try {
                if (btn) btn.disabled = true;
                if (desktopBtn) desktopBtn.disabled = true;
                if (mobileBtn) mobileBtn.disabled = true;
                
                if (btnText) btnText.innerHTML = '<span class="loading"></span> Initializing...';
                hideMessage();

                // Step 1: Get authentication options
                const startRes = await fetch('/auth-app/api/authenticate/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: null }) // Allow any credential
                });

                if (!startRes.ok) {
                    const error = await startRes.json();
                    throw new Error(error.detail || 'Failed to start authentication');
                }

                const { options, session_id } = await startRes.json();
                
                btnText.innerHTML = '<span class="loading"></span> Authenticating...';

                // Step 2: Convert options for WebAuthn API
                const publicKeyOptions = {
                    ...options,
                    challenge: base64urlToUint8Array(options.challenge),
                    allowCredentials: options.allowCredentials?.map(cred => ({
                        ...cred,
                        id: base64urlToUint8Array(cred.id)
                    })) || []
                };

                // Step 3: Get credential from authenticator
                const credential = await navigator.credentials.get({
                    publicKey: publicKeyOptions
                });

                if (!credential) {
                    throw new Error('No credential selected');
                }

                btnText.innerHTML = '<span class="loading"></span> Verifying...';

                // Step 4: Prepare credential for server
                const credentialJSON = {
                    id: credential.id,
                    rawId: uint8ArrayToBase64url(new Uint8Array(credential.rawId)),
                    response: {
                        authenticatorData: uint8ArrayToBase64url(new Uint8Array(credential.response.authenticatorData)),
                        clientDataJSON: uint8ArrayToBase64url(new Uint8Array(credential.response.clientDataJSON)),
                        signature: uint8ArrayToBase64url(new Uint8Array(credential.response.signature)),
                        userHandle: credential.response.userHandle ? uint8ArrayToBase64url(new Uint8Array(credential.response.userHandle)) : null
                    },
                    type: credential.type
                };

                // Step 5: Verify with server
                const verifyRes = await fetch('/auth-app/api/authenticate/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: session_id,
                        credential: credentialJSON
                    })
                });

                if (!verifyRes.ok) {
                    const error = await verifyRes.json();
                    throw new Error(error.detail || 'Authentication verification failed');
                }

                const result = await verifyRes.json();
                
                // Store session info in localStorage for persistent login
                localStorage.setItem('auth_token', result.token);
                localStorage.setItem('username', result.username);
                localStorage.setItem('user_id', result.user_id);
                
                // Note: The cookie is set by the server automatically

                showMessage(`‚úÖ Welcome back, ${result.username}!`, 'success');
                
                // Check if there's a redirect URI (for centralized auth flow)
                const savedRedirectUri = sessionStorage.getItem('redirect_uri');
                const savedState = sessionStorage.getItem('redirect_state');
                
                // Clear session storage
                sessionStorage.removeItem('redirect_uri');
                sessionStorage.removeItem('redirect_state');
                
                // Redirect back to the requesting app with the token
                if (savedRedirectUri) {
                    setTimeout(() => {
                        const separator = savedRedirectUri.includes('?') ? '&' : '?';
                        let redirectUrl = `${savedRedirectUri}${separator}token=${encodeURIComponent(result.token)}`;
                        if (savedState) {
                            redirectUrl += `&state=${encodeURIComponent(savedState)}`;
                        }
                        window.location.href = redirectUrl;
                    }, 1000);
                } else {
                    // No redirect, check for legacy return URL or go to welcome page
                    const returnUrl = sessionStorage.getItem('return_url');
                    sessionStorage.removeItem('return_url');
                    
                    setTimeout(() => {
                        window.location.href = returnUrl || '/auth-app/static/welcome.html';
                    }, 1000);
                }

            } catch (error) {
                console.error('Login error:', error);
                let errorMsg = error.message;
                
                // User-friendly error messages
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'Authentication was cancelled or timed out';
                } else if (error.name === 'InvalidStateError') {
                    errorMsg = 'No passkey found. Please register first';
                }
                
                showMessage('‚ùå Sign in failed: ' + errorMsg, 'error');
            } finally {
                if (desktopBtn) desktopBtn.disabled = false;
                if (mobileBtn) mobileBtn.disabled = false;
                if (btnText) btnText.textContent = originalText;
            }
        }

        // Registration Form Handler
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const displayName = document.getElementById('reg-display-name').value.trim();
            const btn = e.target.querySelector('button[type="submit"]');
            const btnText = document.getElementById('register-form-btn-text');
            const originalText = btnText.textContent;
            
            try {
                btn.disabled = true;
                btnText.innerHTML = '<span class="loading"></span> Starting registration...';
                hideMessage();

                // Step 1: Get registration options
                const startRes = await fetch('/auth-app/api/register/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        display_name: displayName
                    })
                });

                if (!startRes.ok) {
                    const error = await startRes.json();
                    throw new Error(error.detail || 'Failed to start registration');
                }

                const { options, user_id } = await startRes.json();
                
                btnText.innerHTML = '<span class="loading"></span> Creating passkey...';

                // Step 2: Convert options for WebAuthn API
                const publicKeyOptions = {
                    ...options,
                    challenge: base64urlToUint8Array(options.challenge),
                    user: {
                        ...options.user,
                        id: base64urlToUint8Array(options.user.id)
                    },
                    excludeCredentials: options.excludeCredentials?.map(cred => ({
                        ...cred,
                        id: base64urlToUint8Array(cred.id)
                    })) || []
                };

                // Step 3: Create credential
                const credential = await navigator.credentials.create({
                    publicKey: publicKeyOptions
                });

                if (!credential) {
                    throw new Error('Credential creation failed');
                }

                btnText.innerHTML = '<span class="loading"></span> Verifying...';

                // Step 4: Prepare credential for server
                const credentialJSON = {
                    id: credential.id,
                    rawId: uint8ArrayToBase64url(new Uint8Array(credential.rawId)),
                    response: {
                        attestationObject: uint8ArrayToBase64url(new Uint8Array(credential.response.attestationObject)),
                        clientDataJSON: uint8ArrayToBase64url(new Uint8Array(credential.response.clientDataJSON)),
                        transports: credential.response.getTransports ? credential.response.getTransports() : []
                    },
                    type: credential.type
                };

                // Step 5: Verify with server
                const verifyRes = await fetch('/auth-app/api/register/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: user_id,
                        credential: credentialJSON
                    })
                });

                if (!verifyRes.ok) {
                    const error = await verifyRes.json();
                    throw new Error(error.detail || 'Registration verification failed');
                }

                const result = await verifyRes.json();
                
                showMessage(`‚úÖ Account created successfully! Welcome, ${result.username}!`, 'success');
                
                // Auto-switch to login after successful registration
                setTimeout(() => {
                    showAuthSection();
                    showMessage('‚úÖ Now sign in with your new passkey', 'success');
                }, 2000);

            } catch (error) {
                console.error('Registration error:', error);
                let errorMsg = error.message;
                
                // User-friendly error messages
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'Registration was cancelled or timed out';
                } else if (error.name === 'InvalidStateError') {
                    if (isMobile) {
                        errorMsg = 'This device already has a passkey registered. Only one account per mobile device is allowed';
                    } else {
                        errorMsg = 'A passkey already exists for this device';
                    }
                }
                
                showMessage('‚ùå Registration failed: ' + errorMsg, 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = originalText;
            }
        });
    </script>
    
    <!-- Centralized Auth: Redirect to auth server if not already there -->
    <script>
        (function() {
            // ALWAYS use centralized auth server for login/registration
            // Even on localhost, redirect to api.oneaurica.com for authentication
            const AUTH_SERVER = 'https://api.oneaurica.com';
            const currentOrigin = window.location.origin;
            
            // Check if we're NOT on the auth server
            if (currentOrigin !== AUTH_SERVER) {
                // Get URL parameters
                const params = new URLSearchParams(window.location.search);
                
                // If there's already a token in the URL, we're done - don't redirect again!
                // This prevents infinite loops
                if (params.get('token')) {
                    console.log('‚úÖ Token received from auth server, staying on current page');
                    return; // Stop - user is authenticated, token handler will process it
                }
                
                // If logout parameter is present, skip token check and force redirect
                const isLogout = params.get('logout') === 'true';
                if (!isLogout) {
                    // Check if user already has a valid token in localStorage
                    const existingToken = localStorage.getItem('auth_token');
                    if (existingToken) {
                        console.log('‚úÖ User already has JWT token, no need to redirect to auth server');
                        console.log('   üí° JWKS-based verification allows local authentication');
                        return; // Stop - let the auth check below handle it
                    }
                }
                
                console.log('üîÑ Not on auth server, redirecting to centralized login...');
                console.log('   Current:', currentOrigin);
                console.log('   Auth Server:', AUTH_SERVER);
                console.log('   üí° All authentication goes through centralized server');
                
                // Build clean redirect URI (without any existing tokens or auth params)
                const cleanUrl = new URL(window.location.href);
                cleanUrl.searchParams.delete('token'); // Remove any stale tokens
                cleanUrl.searchParams.delete('redirect_uri'); // Remove nested redirects
                cleanUrl.searchParams.delete('state'); // Remove state
                cleanUrl.searchParams.delete('logout'); // Remove logout flag
                
                // Use full current URL as redirect target
                const redirectUri = params.get('redirect_uri') || cleanUrl.toString();
                const state = params.get('state') || '';
                
                console.log('   Redirect URI:', redirectUri);
                
                // Redirect to centralized auth server
                const authUrl = new URL('/auth-app/static/index.html', AUTH_SERVER);
                authUrl.searchParams.set('redirect_uri', redirectUri);
                if (state) authUrl.searchParams.set('state', state);
                if (isLogout) authUrl.searchParams.set('logout', 'true');
                
                window.location.href = authUrl.toString();
                return; // Stop execution
            }
            
            console.log('‚úÖ On auth server, proceeding with login/registration');
            
            // On auth server - check for logout parameter
            const params = new URLSearchParams(window.location.search);
            if (params.get('logout') === 'true') {
                console.log('üîÑ Logout requested, clearing auth server session...');
                // Call logout API to clear server session
                fetch('/auth-app/api/authenticate/logout', {
                    method: 'POST',
                    credentials: 'include'
                }).then(() => {
                    console.log('‚úÖ Logged out from auth server');
                    // Clean the URL
                    params.delete('logout');
                    const newSearch = params.toString();
                    const newUrl = window.location.pathname + (newSearch ? '?' + newSearch : '');
                    window.history.replaceState({}, '', newUrl);
                }).catch(error => {
                    console.error('Logout error:', error);
                });
            }
        })();
    </script>
    
    <!-- Check if user is already logged in -->
    <script>
        // Get redirect parameters from URL (for centralized auth flow)
        const urlParams = new URLSearchParams(window.location.search);
        const redirectUri = urlParams.get('redirect_uri');
        const state = urlParams.get('state');
        
        // Store redirect info for after login
        if (redirectUri) {
            sessionStorage.setItem('redirect_uri', redirectUri);
            if (state) {
                sessionStorage.setItem('redirect_state', state);
            }
        }
        
        // Check authentication on page load
        async function checkIfAlreadyLoggedIn() {
            // First, check if there's a token in the URL (from redirect)
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            
            if (tokenFromUrl) {
                console.log('‚úÖ Token found in URL, storing and checking auth');
                // Store the token
                localStorage.setItem('auth_token', tokenFromUrl);
                
                // Clean the URL
                urlParams.delete('token');
                const newSearch = urlParams.toString();
                const newUrl = window.location.pathname + (newSearch ? '?' + newSearch : '');
                window.history.replaceState({}, '', newUrl);
            }
            
            try {
                // Get token from localStorage or cookie
                const token = localStorage.getItem('auth_token');
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // If we have a token, send it as Bearer token
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/auth-app/api/authenticate/current-user', {
                    credentials: 'include', // Include cookies
                    headers: headers
                });
                
                if (response.ok) {
                    // User is already authenticated
                    const userData = await response.json();
                    console.log('User already logged in:', userData.username);
                    
                    // Check if we need to redirect back to another app
                    const savedRedirectUri = sessionStorage.getItem('redirect_uri');
                    if (savedRedirectUri) {
                        // Get the JWT token from the API response
                        const token = userData.token;
                        
                        if (!token) {
                            console.error('No token in API response:', userData);
                            console.log('User not logged in, showing login page');
                            document.body.classList.add('loaded'); // Show login page
                            return; // Stay on login page
                        }
                        
                        const savedState = sessionStorage.getItem('redirect_state');
                        
                        // Clear session storage
                        sessionStorage.removeItem('redirect_uri');
                        sessionStorage.removeItem('redirect_state');
                        
                        // Redirect back with token
                        const separator = savedRedirectUri.includes('?') ? '&' : '?';
                        let redirectUrl = `${savedRedirectUri}${separator}token=${encodeURIComponent(token)}`;
                        if (savedState) {
                            redirectUrl += `&state=${encodeURIComponent(savedState)}`;
                        }
                        console.log('Redirecting back to:', redirectUrl);
                        window.location.href = redirectUrl;
                        return; // Don't show login page
                    } else {
                        // No redirect needed, go to welcome page
                        window.location.href = '/auth-app/static/welcome.html';
                        return; // Don't show login page
                    }
                }
            } catch (error) {
                // Not logged in or error checking, stay on login page
                console.log('User not logged in, showing login page');
            }
            
            // If we reach here, user is not logged in - show the page
            document.body.classList.add('loaded');
        }
        
        // Check on page load (before page is visible)
        checkIfAlreadyLoggedIn();
    </script>
</body>
</html>