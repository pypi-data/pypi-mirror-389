"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["93381"],{30883:function(t,e,o){o.a(t,async function(t,r){try{o.d(e,{EO:function(){return v},Yq:function(){return O},_U:function(){return M},eE:function(){return D},fU:function(){return T},ol:function(){return b},xo:function(){return w}});var n=o(80850),s=o(78320),a=o(99904),i=o(9151),c=o(78061),l=o(70162),_=o(3313),u=o(41484),f=o(91927),g=o(28829),y=o(49418),d=o(86564),m=o(92149),p=t([d]);d=(p.then?(await p)():p)[0];const h=(t,e,o,r)=>{const n=o(new d.BB(t,e),r);return n instanceof Date?new Date(n.getTime()):n},b=(t,e,o,r,n)=>o.time_zone===m.Wj.server?h(t,r.time_zone,e,n):e(t,n),w=(t,e,o,r,n)=>o.time_zone===m.Wj.server?h(t,r.time_zone,e,n):e(t,n),v=(t,e,o,r,n)=>w(t,o,r,n,r.time_zone===m.Wj.server?new d.BB(e,n.time_zone):e),D=(t,e,o,r,d)=>{let m,p;if(w(t,n.e,r,d)&&w(e,s.c,r,d)){const n=(v(e,t,a.W,r,d)+1)*(o?1:-1);m=b(t,i.P,r,d,n),p=b(b(e,i.P,r,d,n),c.p,r,d)}else if(w(t,t=>(0,l.o)(t).getMilliseconds()===t.getMilliseconds(),r,d)&&w(e,t=>(0,_.D)(t).getMilliseconds()===t.getMilliseconds(),r,d)){const n=(v(e,t,u.c,r,d)+1)*(o?1:-1);m=b(t,f.f,r,d,n),p=b(e,f.f,r,d,n)}else{const n=v(e,t,g.b,r,d)*(o?1:-1);m=b(t,y.A,r,d,n),p=b(e,y.A,r,d,n)}return{start:m,end:p}},M=(t,e)=>{const o=new d.BB(t,e);return new Date(o.getTime())},O=(t,e)=>new d.BB(t,e).toISOString().split("T")[0],T=(t,e)=>new d.BB(t,e).toISOString().split("T")[1].split(".")[0];r()}catch(h){r(h)}})},76037:function(t,e,o){o.a(t,async function(t,r){try{o.d(e,{b:function(){return v}});var n=o(70162),s=o(3313),a=o(91927),i=o(88258),c=o(25223),l=o(83466),_=o(78061),u=o(47432),f=o(44943),g=o(40391),y=o(93910),d=o(13486),m=o(11042),p=o(4494),h=o(30883),b=o(50654),w=t([b,h]);[b,h]=w.then?(await w)():w;const v=(t,e)=>{const o=new Date,r=(0,b.PE)(t.locale);switch(e){case"today":return[(0,h.ol)(o,n.o,t.locale,t.config,{weekStartsOn:r}),(0,h.ol)(o,s.D,t.locale,t.config,{weekStartsOn:r})];case"yesterday":return[(0,h.ol)((0,a.f)(o,-1),n.o,t.locale,t.config,{weekStartsOn:r}),(0,h.ol)((0,a.f)(o,-1),s.D,t.locale,t.config,{weekStartsOn:r})];case"this_week":return[(0,h.ol)(o,i.k,t.locale,t.config,{weekStartsOn:r}),(0,h.ol)(o,c.$,t.locale,t.config,{weekStartsOn:r})];case"this_month":return[(0,h.ol)(o,l.w,t.locale,t.config),(0,h.ol)(o,_.p,t.locale,t.config)];case"this_quarter":return[(0,h.ol)(o,u.a,t.locale,t.config),(0,h.ol)(o,f.j,t.locale,t.config)];case"this_year":return[(0,h.ol)(o,g.D,t.locale,t.config),(0,h.ol)(o,y.Q,t.locale,t.config)];case"now-7d":return[(0,h.ol)(o,d.e,t.locale,t.config,7),(0,h.ol)(o,d.e,t.locale,t.config,0)];case"now-30d":return[(0,h.ol)(o,d.e,t.locale,t.config,30),(0,h.ol)(o,d.e,t.locale,t.config,0)];case"now-12m":return[(0,h.ol)((0,m.a)(o,12),l.w,t.locale,t.config),(0,h.ol)((0,m.a)(o,1),_.p,t.locale,t.config)];case"now-1h":return[(0,h.ol)(o,p.O,t.locale,t.config,1),(0,h.ol)(o,p.O,t.locale,t.config,0)];case"now-12h":return[(0,h.ol)(o,p.O,t.locale,t.config,12),(0,h.ol)(o,p.O,t.locale,t.config,0)];case"now-24h":return[(0,h.ol)(o,p.O,t.locale,t.config,24),(0,h.ol)(o,p.O,t.locale,t.config,0)]}return[o,o]};r()}catch(v){r(v)}})},47781:function(t,e,o){o.d(e,{$:function(){return r}});o(35748),o(99342),o(95013);const r=(t,e)=>{const o={};for(const r of t){const t=e(r);t in o?o[t].push(r):o[t]=[r]}return o}},43716:function(t,e,o){o.a(t,async function(t,r){try{o.d(e,{AN:function(){return $},B2:function(){return j},BV:function(){return P},DR:function(){return K},E$:function(){return U},GW:function(){return C},Q4:function(){return E},RB:function(){return k},WN:function(){return I},X4:function(){return Q},_d:function(){return G},al:function(){return V},bs:function(){return z},c:function(){return x},gv:function(){return X},lh:function(){return O},m7:function(){return S},n3:function(){return et},oU:function(){return B},pe:function(){return ot},tb:function(){return R},uh:function(){return W}});o(46852),o(79827),o(35748),o(99342),o(35058),o(65315),o(12840),o(837),o(22416),o(37089),o(12977),o(5934),o(88238),o(34536),o(16257),o(20152),o(44711),o(72108),o(77030),o(18223),o(56660),o(95013);var n=o(41484),s=o(80850),a=o(78320),i=o(9151),c=o(99904),l=o(91927),_=o(49418),u=o(23336),f=o(70162),g=o(3313),y=o(4681),d=o(47308),m=o(65940),p=o(30883),h=o(65380),b=o(47781),w=o(63002),v=o(76037),D=o(8868),M=t([h,v,p,w,D]);[h,v,p,w,D]=M.then?(await M)():M;const T=[],S=()=>({stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),k=()=>({stat_energy_to:"",stat_compensation:null,entity_energy_price:null,number_energy_price:null}),W=()=>({type:"grid",flow_from:[],flow_to:[],cost_adjustment_day:0}),E=()=>({type:"solar",stat_energy_from:"",config_entry_solar_forecast:null}),B=()=>({type:"battery",stat_energy_from:"",stat_energy_to:""}),x=()=>({type:"gas",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),C=()=>({type:"water",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),P=t=>t.callWS({type:"energy/info"}),j=async t=>(await t.loadBackendTranslation("issues","energy"),t.callWS({type:"energy/validate"})),z=t=>t.callWS({type:"energy/get_prefs"}),I=async(t,e)=>{const o=t.callWS(Object.assign({type:"energy/save_prefs"},e));return q(t),o},A=async(t,e,o,r,n,s="hour")=>t.callWS({type:"energy/fossil_energy_consumption",start_time:e.toISOString(),end_time:null==n?void 0:n.toISOString(),energy_statistic_ids:o,co2_statistic_id:r,period:s}),U=t=>(0,b.$)(t.energy_sources,t=>t.type),$=(t,e,o)=>{const r=[];for(const n of t.energy_sources)if(!o||o.includes(n.type))if("solar"!==n.type){if("gas"===n.type||"water"===n.type){r.push(n.stat_energy_from),n.stat_cost&&r.push(n.stat_cost);const t=e.cost_sensors[n.stat_energy_from];t&&r.push(t);continue}if("battery"!==n.type){for(const t of n.flow_from){r.push(t.stat_energy_from),t.stat_cost&&r.push(t.stat_cost);const o=e.cost_sensors[t.stat_energy_from];o&&r.push(o)}for(const t of n.flow_to){r.push(t.stat_energy_to),t.stat_compensation&&r.push(t.stat_compensation);const o=e.cost_sensors[t.stat_energy_to];o&&r.push(o)}}else r.push(n.stat_energy_from),r.push(n.stat_energy_to)}else r.push(n.stat_energy_from);return o&&!o.includes("device")||r.push(...t.device_consumption.map(t=>t.stat_consumption)),r};var O=function(t){return t.NONE="",t.PREVIOUS="previous",t.YOY="yoy",t}({});const N=async(t,e,o,r,f)=>{const g=await P(t);let y;for(const n of Object.values(t.entities)){if("co2signal"!==n.platform)continue;const e=t.states[n.entity_id];if(e&&"%"===e.attributes.unit_of_measurement){y=e.entity_id;break}}const d=[];for(const n of e.energy_sources)if("grid"===n.type)for(const t of n.flow_from)d.push(t.stat_energy_from);const m=$(e,g,["grid","solar","battery","gas","device"]),h=$(e,g,["water"]),b=[...m,...h],v=(0,n.c)(r||new Date,o),D=(0,s.e)(o)&&(!r||(0,a.c)(r))&&v>35?"month":v>2?"day":"hour",M={},O=b.length?await(0,w.Wr)(t,b):[];b.length&&O.forEach(t=>{M[t.statistic_id]=t});const T=H(t,e,M),S={energy:"kWh",volume:w.r_.includes(T)?T:void 0},k=J(t,e,M),W={volume:k},E=m.length?(0,w.sz)(t,o,r,m,D,S,["change"]):{},B=h.length?(0,w.sz)(t,o,r,h,D,W,["change"]):{};let x,C,j,z,I,U={},N={};f&&("previous"===f?(C=(0,p.xo)(o,s.e,t.locale,t.config)&&(0,p.xo)(r||new Date,a.c,t.locale,t.config)?(0,p.ol)(o,i.P,t.locale,t.config,-(0,p.EO)(r||new Date,o,c.W,t.locale,t.config)-1):(0,p.ol)(o,l.f,t.locale,t.config,-1*(v+1)),j=(0,_.A)(o,-1)):"yoy"===f&&(C=(0,p.ol)(o,u.e,t.locale,t.config,-1),j=(0,p.ol)(r,u.e,t.locale,t.config,-1)),m.length&&(U=(0,w.sz)(t,C,j,m,D,S,["change"])),h.length&&(N=(0,w.sz)(t,C,j,h,D,W,["change"]))),void 0!==y&&(z=A(t,o,d,y,r,v>35?"month":v>2?"day":"hour"),f&&(I=A(t,C,d,y,j,v>35?"month":v>2?"day":"hour")));const[q,L,R,V,Y,G]=await Promise.all([E,B,U,N,z,I]),Q=Object.assign(Object.assign({},q),L);f&&(x=Object.assign(Object.assign({},R),V));return{start:o,end:r,startCompare:C,endCompare:j,compareMode:f,info:g,prefs:e,stats:Q,statsMetadata:M,statsCompare:x,co2SignalEntity:y,fossilEnergyConsumption:Y,fossilEnergyConsumptionCompare:G,waterUnit:k,gasUnit:T}},q=t=>{T.forEach(e=>{const o=R(t,{key:e});o.clearPrefs(),o._active&&o.refresh()})},L=t=>{if(t._refreshTimeout&&clearTimeout(t._refreshTimeout),t._active&&(!t.end||t.end>new Date)){const e=new Date;e.getMinutes()>=20&&e.setHours(e.getHours()+1),e.setMinutes(20,0,0),t._refreshTimeout=window.setTimeout(()=>t.refresh(),e.getTime()-Date.now())}},R=(t,e={})=>{let o="_energy";if(e.key){if(!e.key.startsWith("energy_"))throw new Error("Key need to start with energy_");o=`_${e.key}`}if(t.connection[o])return t.connection[o];T.push(e.key);const r=(0,d.X)(t.connection,o,async()=>(r.prefs||(r.prefs=await z(t)),L(r),N(t,r.prefs,r.start,r.end,r.compare))),n=r.subscribe;r.subscribe=t=>{const e=n(t);return r._active++,void 0===r._refreshTimeout&&L(r),()=>{r._active--,r._active<1&&(clearTimeout(r._refreshTimeout),r._refreshTimeout=void 0),e()}},r._active=0,r.prefs=e.prefs;const s=new Date,a=(0,h.LW)(s,t.locale,t.config).split(":")[0],i=localStorage.getItem(`energy-default-period-${o}`)||"today",c="today"===i&&"0"===a?"yesterday":i,[l,_]=(0,v.b)(t,c);r.start=(0,p.ol)(l,f.o,t.locale,t.config),r.end=(0,p.ol)(_,g.D,t.locale,t.config);const u=()=>{r._updatePeriodTimeout=window.setTimeout(()=>{r.start=(0,p.ol)(new Date,f.o,t.locale,t.config),r.end=(0,p.ol)(new Date,g.D,t.locale,t.config),u()},(0,y.L)((0,p.ol)(new Date,g.D,t.locale,t.config),1).getTime()-Date.now())};return u(),r.clearPrefs=()=>{r.prefs=void 0},r.setPeriod=(e,o)=>{var n;r._updatePeriodTimeout&&(clearTimeout(r._updatePeriodTimeout),r._updatePeriodTimeout=void 0),r.start=e,r.end=o,r.start.getTime()===(0,p.ol)(new Date,f.o,t.locale,t.config).getTime()&&(null===(n=r.end)||void 0===n?void 0:n.getTime())===(0,p.ol)(new Date,g.D,t.locale,t.config).getTime()&&u()},r.setCompare=t=>{r.compare=t},r},V=t=>t.callWS({type:"energy/solar_forecast"}),Y=["volume","energy"],G=(t,e,o={})=>{for(const r of t.energy_sources){if("gas"!==r.type)continue;if(e&&e===r.stat_energy_from)continue;const t=o[r.stat_energy_from];if(Y.includes(null==t?void 0:t.unit_class))return t.unit_class}},H=(t,e,o={})=>{if("energy"===G(e,void 0,o))return"kWh";const r=e.energy_sources.filter(t=>"gas"===t.type).map(e=>(0,w.JE)(t,e.stat_energy_from,o[e.stat_energy_from]));if(r.length){const t=r[0];if(w.r_.includes(t)&&r.every(e=>e===t))return t}return"km"===t.config.unit_system.length?"m³":"ft³"},J=(t,e,o)=>{const r=e.energy_sources.filter(t=>"water"===t.type).map(e=>(0,w.JE)(t,e.stat_energy_from,o[e.stat_energy_from]));if(r.length){const t=r[0];if(w.r_.includes(t)&&r.every(e=>e===t))return t}return"km"===t.config.unit_system.length?"L":"gal"},Q="/docs/energy/faq/#troubleshooting-missing-entities",X=(0,m.A)(t=>({summedData:F(t),compareSummedData:t.statsCompare?F(t,!0):void 0})),F=(t,e)=>{const o={};for(const s of t.prefs.energy_sources)if("solar"!==s.type)if("battery"!==s.type){if("grid"===s.type){for(const t of s.flow_from)o.from_grid?o.from_grid.push(t.stat_energy_from):o.from_grid=[t.stat_energy_from];for(const t of s.flow_to)o.to_grid?o.to_grid.push(t.stat_energy_to):o.to_grid=[t.stat_energy_to]}}else o.to_battery?(o.to_battery.push(s.stat_energy_to),o.from_battery.push(s.stat_energy_from)):(o.to_battery=[s.stat_energy_to],o.from_battery=[s.stat_energy_from]);else o.solar?o.solar.push(s.stat_energy_from):o.solar=[s.stat_energy_from];const r={total:{},timestamps:[]},n=new Set;return Object.entries(o).forEach(([o,s])=>{const a={},i={};let c=0;s.forEach(o=>{const r=e?t.statsCompare[o]:t.stats[o];if(!r)return;r.forEach(t=>{if(null===t.change||void 0===t.change)return;const e=t.change;c+=e,a[t.start]=t.start in a?a[t.start]+e:e,n.add(t.start)}),i[o]={}}),r[o]=a,r.total[o]=c}),r.timestamps=Array.from(n).sort(),r},K=(0,m.A)((t,e)=>({consumption:Z(t),compareConsumption:e?Z(e):void 0})),Z=t=>{const e={used_total:{},grid_to_battery:{},battery_to_grid:{},solar_to_battery:{},solar_to_grid:{},used_solar:{},used_grid:{},used_battery:{},total:{used_total:0,grid_to_battery:0,battery_to_grid:0,solar_to_battery:0,solar_to_grid:0,used_solar:0,used_grid:0,used_battery:0}};return t.timestamps.forEach(o=>{var r,n,s,a,i;const{grid_to_battery:c,battery_to_grid:l,used_solar:_,used_grid:u,used_battery:f,used_total:g,solar_to_battery:y,solar_to_grid:d}=tt({from_grid:t.from_grid&&(null!==(r=t.from_grid[o])&&void 0!==r?r:0),to_grid:t.to_grid&&(null!==(n=t.to_grid[o])&&void 0!==n?n:0),solar:t.solar&&(null!==(s=t.solar[o])&&void 0!==s?s:0),to_battery:t.to_battery&&(null!==(a=t.to_battery[o])&&void 0!==a?a:0),from_battery:t.from_battery&&(null!==(i=t.from_battery[o])&&void 0!==i?i:0)});e.used_total[o]=g,e.total.used_total+=g,e.grid_to_battery[o]=c,e.total.grid_to_battery+=c,e.battery_to_grid[o]=l,e.total.battery_to_grid+=l,e.used_battery[o]=f,e.total.used_battery+=f,e.used_grid[o]=u,e.total.used_grid+=u,e.used_solar[o]=_,e.total.used_solar+=_,e.solar_to_battery[o]=y,e.total.solar_to_battery+=y,e.solar_to_grid[o]=d,e.total.solar_to_grid+=d}),e},tt=t=>{let e=Math.max(t.to_grid||0,0),o=Math.max(t.to_battery||0,0),r=Math.max(t.solar||0,0),n=Math.max(t.from_grid||0,0),s=Math.max(t.from_battery||0,0);const a=(n||0)+(r||0)+(s||0)-(e||0)-(o||0);let i=0,c=0,l=0,_=0,u=0,f=0,g=0,y=Math.max(a,0);const d=Math.max(0,Math.min(o,n-y));c+=d,o-=d,n-=d,_=Math.min(r,o),o-=_,r-=_,u=Math.min(r,e),e-=u,r-=u,l=Math.min(s,e),s-=l,e-=l;const m=Math.min(n,o);return c+=m,n-=m,o-=m,i=Math.min(y,r),y-=i,r-=i,f=Math.min(s,y),s-=f,y-=f,g=Math.min(y,n),n-=g,y-=n,{used_solar:i,used_grid:g,used_battery:f,used_total:a,grid_to_battery:c,battery_to_grid:l,solar_to_battery:_,solar_to_grid:u}},et=(t,e,o,r)=>{const n=["Wh","kWh","MWh","GWh","TWh"];let s=o,a=e||0,i=-1;r&&(i=n.findIndex(t=>t===r));let c=n.findIndex(t=>t===o);if(c>=0){for(;i>-1?i<c:Math.abs(a)<1&&c>0;)a*=1e3,c--;for(;i>-1?i>c:Math.abs(a)>=1e3&&c<n.length-1;)a/=1e3,c++;s=n[c]}return(0,D.ZV)(a,t.locale,{maximumFractionDigits:Math.abs(a)<10?2:Math.abs(a)<100?1:0})+" "+s},ot=(t,e)=>{if(!e.total.solar)return;const{consumption:o,compareConsumption:r}=K(e,void 0);if(!t){const t=e.total.solar;return o.total.used_solar/t*100}let n=0,s=0;const a=[];e.timestamps.forEach(t=>{var e,r,i,c;n+=null!==(e=o.used_solar[t])&&void 0!==e?e:0,s+=null!==(r=o.solar_to_grid[t])&&void 0!==r?r:0,o.grid_to_battery[t]&&a.push({type:"grid",value:o.grid_to_battery[t]}),o.solar_to_battery[t]&&a.push({type:"solar",value:o.solar_to_battery[t]});let l=null!==(i=o.battery_to_grid[t])&&void 0!==i?i:0,_=null!==(c=o.used_battery[t])&&void 0!==c?c:0;const u=function(t){const e=a[a.length-1],o=e.type;if(t>=e.value){const t=e.value;return a.pop(),{energy:t,type:o}}return e.value-=t,{energy:t,type:o}};for(;_>0&&a.length;){const{energy:t,type:e}=u(_);"solar"===e&&(n+=t),_-=t}for(;l>0&&a.length;){const{energy:t,type:e}=u(l);"solar"===e&&(s+=t),l-=t}});const i=n+s;return!!i?n/i*100:void 0};r()}catch(T){r(T)}})}}]);
//# sourceMappingURL=93381.7522b9edbeacd3b2.js.map