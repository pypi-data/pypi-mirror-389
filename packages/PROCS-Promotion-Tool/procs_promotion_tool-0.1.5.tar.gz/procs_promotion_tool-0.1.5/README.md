# promotionflow

Skeleton Python package for Promotion Excel import/processing flow.

## Install

```bash
pip install .
# or for editable install during development
pip install -e .
```

## CLI

After install you can run:

```bash
promotionflow
```


USE [FlowReport] GO /****** Object: Table [dbo].[promotion_data] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[promotion_data]( [promotion_code] [nvarchar](max) NULL, [promotion_name] [nvarchar](max) NULL, [active_from] [nvarchar](max) NULL, [active_to] [nvarchar](max) NULL, [entity_code] [nvarchar](max) NULL, [entity_name] [nvarchar](max) NULL, [coupon_code39] [nvarchar](max) NULL, [barcode] [nvarchar](max) NULL, [member_segmentation] [nvarchar](max) NULL, [levelid] [nvarchar](max) NULL, [barcode_code39] [nvarchar](max) NULL, [reward_type] [nvarchar](max) NULL, [reward_value] [nvarchar](max) NULL, [reward_ma_name] [nvarchar](max) NULL, [reward_ma_id] [nvarchar](max) NULL, [promotion_status] [nvarchar](max) NULL, [condition_name] [nvarchar](max) NULL, [condition_ma_id] [nvarchar](max) NULL, [condition_ma_name] [nvarchar](max) NULL, [promotion_type] [nvarchar](max) NULL, [receipt_promotion_name] [nvarchar](max) NULL, [group_name] [nvarchar](max) NULL, [coupon_id] [nvarchar](max) NULL, [redemption_limit_per_transaction] [nvarchar](max) NULL, [redemption_limit_per_day] [nvarchar](max) NULL, [maximum_redemption_limit] [nvarchar](max) NULL, [notes] [nvarchar](max) NULL, [sheet] [nvarchar](max) NULL, [worksheet] [nvarchar](max) NULL, [optimal_date] [nvarchar](max) NULL, [version] [nvarchar](max) NULL, [round] [nvarchar](max) NULL, [bucketid] [nvarchar](max) NULL, [trigger_value] [nvarchar](max) NULL, [attachmentmode] [nvarchar](max) NULL, [entity_type] [nvarchar](max) NULL, [all_members_card_required] [nvarchar](max) NULL, [member_segments_tiers] [nvarchar](max) NULL, [cv_code_supplier] [nvarchar](max) NULL, [cv_name] [nvarchar](max) NULL, [trigger_type] [nvarchar](max) NULL, [updated_date] [nvarchar](max) NULL, [external_id] [nvarchar](max) NULL, [limit_number_of_items_to] [nvarchar](max) NULL ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] GO /****** Object: View [dbo].[VW_PROMOTION_VERSION] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE VIEW [dbo].[VW_PROMOTION_VERSION] AS SELECT version, round, sheet, worksheet, APPROX_COUNT_DISTINCT(promotion_code) as count_promotion,COUNT(entity_code) as count_entity FROM dbo.promotion_data GROUP BY version, round, sheet, worksheet; GO /****** Object: Table [dbo].[PM_PROMOTION] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[PM_PROMOTION]( [PROMOTION_ID] [int] IDENTITY(1,1) NOT NULL, [SHEET_ID] [int] NULL, [PROMOTION_CODE] [int] NULL, [PROMOTION_NAME] [nvarchar](255) NULL, [PROMOTION_RECEIPT] [nvarchar](255) NULL, [PROMOTION_STATUS] [nvarchar](255) NULL, [PROMOTION_TYPE] [nvarchar](100) NULL, [LEVEL_ID] [int] NULL, [ACTIVE_TO] [date] NULL, [ACTIVE_FROM] [date] NULL, [OPTION_TIME] [date] NULL, [UPDATED_DATE] [date] NULL, [COUPON] [nvarchar](20) NULL, [LIMIT_PER_TRANSACTION] [int] NULL, [LIMIT_PER_DAY] [int] NULL, [LIMIT_NUMBER_OF_ITEM] [int] NULL, [MAXIMUM_LIMIT] [int] NULL, [MEMBER_SEGMENTS_TIERS] [nvarchar](max) NULL, [MEMBER_SEGMENTS] [nvarchar](max) NULL, [ALL_MEMBER_CARD_REQUIRED] [nvarchar](max) NULL, [REWARD_VALUE] [decimal](10, 2) NULL, [REWARD_TYPE] [nvarchar](100) NULL, [REWARD_MA_ID] [nvarchar](255) NULL, [REWARD_MA_NAME] [nvarchar](255) NULL, [CONDITION_MA_ID] [nvarchar](255) NULL, [CONDITION_MA_NAME] [nvarchar](255) NULL, [CONDITION_NAME] [nvarchar](255) NULL, [GROUP_NAME] [nvarchar](255) NULL, [NOTES] [nvarchar](max) NULL, [BUSINESS_TYPE] [nvarchar](100) NULL, [EXTERNAL_ID] [nvarchar](255) NULL, [FLAG] [nvarchar](255) NULL, [TOTAL_USER] [int] NULL, [PRODUCT_COUNT] [int] NULL, [NOTE] [nvarchar](500) NULL, CONSTRAINT [PK__PM_PROMO__F956993AEED7A54B] PRIMARY KEY CLUSTERED ( [PROMOTION_ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY], CONSTRAINT [UQ_PM_PROMOTION] UNIQUE NONCLUSTERED ( [SHEET_ID] ASC, [PROMOTION_CODE] ASC, [PROMOTION_NAME] ASC, [PROMOTION_RECEIPT] ASC, [COUPON] ASC, [BUSINESS_TYPE] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY] ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] GO /****** Object: Table [dbo].[PM_PRODUCT] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[PM_PRODUCT]( [ENTITY_ID] [int] IDENTITY(1,1) NOT NULL, [PROMOTION_ID] [int] NULL, [ENTITY_CODE] [varchar](26) NULL, [ENTITY_NAME] [nvarchar](255) NULL, [ATTACHMENTMODE] [nvarchar](255) NULL, [ENTITY_TYPE] [nvarchar](150) NULL, [BUCKET_ID] [nvarchar](255) NULL, [BARCODE] [nvarchar](25) NULL, [TRIGGER_TYPE] [nvarchar](100) NULL, [TRIGGER_VALUE] [nvarchar](255) NULL, [STATUS] [nvarchar](50) NULL, [NOTE] [nvarchar](500) NULL, CONSTRAINT [PK__PM_PRODU__2E73818B31E0BC4F] PRIMARY KEY CLUSTERED ( [ENTITY_ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY], CONSTRAINT [PM_PRODUCT_UNIQUE] UNIQUE NONCLUSTERED ( [ENTITY_CODE] ASC, [BUCKET_ID] ASC, [TRIGGER_TYPE] ASC, [TRIGGER_VALUE] ASC, [ENTITY_TYPE] ASC, [ATTACHMENTMODE] ASC, [PROMOTION_ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY] ) ON [PRIMARY] GO /****** Object: Table [dbo].[PM_VERSION] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[PM_VERSION]( [VERSION_ID] [int] IDENTITY(1,1) NOT NULL, [VERSION_NAME] [nvarchar](255) NULL, [GROUP_NO] [int] NOT NULL, [YEAR] [int] NOT NULL, [MONTH] [int] NOT NULL, [START_DATE] [datetime] NULL, [END_DATE] [datetime] NULL, [TOTAL_DAY] [decimal](10, 2) NULL, [TOTAL_USER] [int] NULL, [REMARK] [nvarchar](500) NULL, CONSTRAINT [PK__PM_VERSI__D4FACC3A3945D96D] PRIMARY KEY CLUSTERED ( [VERSION_ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY], CONSTRAINT [UQ_PM_VERSION] UNIQUE NONCLUSTERED ( [GROUP_NO] ASC, [MONTH] ASC, [YEAR] ASC, [VERSION_NAME] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY] ) ON [PRIMARY] GO /****** Object: Table [dbo].[PM_WORKSHEET] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[PM_WORKSHEET]( [WORKSHEET_ID] [int] IDENTITY(1,1) NOT NULL, [VERSION_ID] [int] NULL, [FILE_NAME] [nvarchar](255) NULL, [FILE_PATH] [nvarchar](255) NULL, [FILE_SIZE] [decimal](10, 2) NULL, [TOTAL_DAY] [decimal](10, 2) NULL, [TOTAL_USER] [int] NULL, [CREATED_USER] [nvarchar](100) NULL, [NOTE] [nvarchar](500) NULL, PRIMARY KEY CLUSTERED ( [WORKSHEET_ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY] ) ON [PRIMARY] GO /****** Object: Table [dbo].[PM_SHEET] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[PM_SHEET]( [SHEET_ID] [int] IDENTITY(1,1) NOT NULL, [WORKSHEET_ID] [int] NULL, [SHEET_NAME] [nvarchar](255) NULL, [RD_COL] [int] NULL, [RD_ROW] [int] NULL, [STATUS] [nvarchar](50) NULL, [NOTE] [nvarchar](500) NULL, PRIMARY KEY CLUSTERED ( [SHEET_ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY] ) ON [PRIMARY] GO /****** Object: Table [dbo].[PM_PROMOTION_USER] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[PM_PROMOTION_USER]( [PROMO_USER_ID] [int] IDENTITY(1,1) NOT NULL, [PROMOTION_ID] [int] NULL, [USER_NAME] [nvarchar](100) NULL, [ROLE_IN_PROJECT] [nvarchar](100) NULL, [WORK_HOURS] [decimal](10, 2) NULL, [START_TIME] [datetime] NULL, [END_TIME] [datetime] NULL, [STATUS] [nvarchar](50) NULL, [NOTE] [nvarchar](500) NULL, PRIMARY KEY CLUSTERED ( [PROMO_USER_ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY] ) ON [PRIMARY] GO /****** Object: Table [dbo].[PM_DEFECT] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[PM_DEFECT]( [DEFECT_ID] [int] IDENTITY(1,1) NOT NULL, [ENTITY_ID] [int] NULL, [DEFECT_DETAIL] [varchar](max) NULL, [DEFECT_TYPE] [tinyint] NULL, [CREATED_USER] [nvarchar](100) NULL, [CREATED_DATE] [date] NULL, [DEFECT_VALUE] [tinyint] NULL, [DEFECT_STATUS] [tinyint] NULL, [UPDATE_USER] [nvarchar](100) NULL, [UPDATE_DATE] [date] NULL, [NOTE] [nvarchar](500) NULL, PRIMARY KEY CLUSTERED ( [DEFECT_ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY] ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] GO /****** Object: View [dbo].[VW_PROMOTION_SUMMARY] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE VIEW [dbo].[VW_PROMOTION_SUMMARY] AS SELECT v.YEAR, v.MONTH, COUNT(DISTINCT w.WORKSHEET_ID) AS TOTAL_WORKSHEET, COUNT(DISTINCT s.SHEET_ID) AS TOTAL_SHEET, COUNT(DISTINCT p.PROMOTION_ID) AS TOTAL_PROMOTION, COUNT(DISTINCT pr.ENTITY_ID) AS TOTAL_PRODUCT, COUNT(df.DEFECT_ID) AS TOTAL_DEFECT, COUNT(DISTINCT pu.USER_NAME) AS TOTAL_USER, SUM(pu.WORK_HOURS) AS TOTAL_HOURS FROM PM_VERSION v LEFT JOIN PM_WORKSHEET w ON w.VERSION_ID = v.VERSION_ID LEFT JOIN PM_SHEET s ON s.WORKSHEET_ID = w.WORKSHEET_ID LEFT JOIN PM_PROMOTION p ON p.SHEET_ID = s.SHEET_ID LEFT JOIN PM_PRODUCT pr ON pr.PROMOTION_ID = p.PROMOTION_ID LEFT JOIN PM_DEFECT df ON df.ENTITY_ID = pr.ENTITY_ID LEFT JOIN PM_PROMOTION_USER pu ON pu.PROMOTION_ID = p.PROMOTION_ID GROUP BY v.YEAR, v.MONTH; GO /****** Object: View [dbo].[VW_PROMOTION_DETAIL] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE VIEW [dbo].[VW_PROMOTION_DETAIL] AS SELECT v.YEAR, v.MONTH, v.VERSION_NAME, w.WORKSHEET_ID, w.FILE_NAME AS WORKSHEET_NAME, s.SHEET_ID, s.SHEET_NAME, p.PROMOTION_ID, p.PROMOTION_CODE, p.PROMOTION_NAME, p.PROMOTION_RECEIPT, p.PROMOTION_STATUS, p.PROMOTION_TYPE, p.LEVEL_ID, p.ACTIVE_FROM, p.ACTIVE_TO, p.COUPON, p.LIMIT_PER_TRANSACTION, p.LIMIT_PER_DAY, p.LIMIT_NUMBER_OF_ITEM, p.MAXIMUM_LIMIT, p.MEMBER_SEGMENTS_TIERS, p.MEMBER_SEGMENTS, p.ALL_MEMBER_CARD_REQUIRED, p.REWARD_VALUE, p.REWARD_TYPE, p.REWARD_MA_ID, p.REWARD_MA_NAME, p.BUSINESS_TYPE, p.TOTAL_USER AS PROMO_TOTAL_USER, pr.ENTITY_ID, pr.ENTITY_CODE, pr.ENTITY_NAME, pr.ENTITY_TYPE, pr.BARCODE, pr.STATUS AS PRODUCT_STATUS, df.DEFECT_ID, df.DEFECT_DETAIL, df.DEFECT_TYPE, df.DEFECT_STATUS, pu.USER_NAME, pu.WORK_HOURS, pu.STATUS AS USER_STATUS FROM PM_VERSION v LEFT JOIN PM_WORKSHEET w ON w.VERSION_ID = v.VERSION_ID LEFT JOIN PM_SHEET s ON s.WORKSHEET_ID = w.WORKSHEET_ID LEFT JOIN PM_PROMOTION p ON p.SHEET_ID = s.SHEET_ID LEFT JOIN PM_PRODUCT pr ON pr.PROMOTION_ID = p.PROMOTION_ID LEFT JOIN PM_DEFECT df ON df.ENTITY_ID = pr.ENTITY_ID LEFT JOIN PM_PROMOTION_USER pu ON pu.PROMOTION_ID = p.PROMOTION_ID; GO /****** Object: Table [dbo].[PM_PROMOTION_STEP] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[PM_PROMOTION_STEP]( [STEP_ID] [int] IDENTITY(1,1) NOT NULL, [PROMOTION_ID] [int] NULL, [ENTITY_ID] [int] NULL, [STEP_NAME] [nvarchar](255) NULL, [STEP_ORDER] [int] NULL, [STEP_STATUS] [nvarchar](50) NULL, [WORK_HOURS] [decimal](10, 2) NULL, [USER_NAME] [nvarchar](100) NULL, [NOTE] [nvarchar](500) NULL, PRIMARY KEY CLUSTERED ( [STEP_ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY] ) ON [PRIMARY] GO /****** Object: View [dbo].[VW_PROMOTION_DETAIL_FULL] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE VIEW [dbo].[VW_PROMOTION_DETAIL_FULL] AS SELECT v.YEAR, v.MONTH, v.VERSION_NAME, w.WORKSHEET_ID, w.FILE_NAME AS WORKSHEET_NAME, s.SHEET_ID, s.SHEET_NAME, p.PROMOTION_ID, p.PROMOTION_CODE, p.PROMOTION_NAME, p.PROMOTION_RECEIPT, p.PROMOTION_STATUS, p.PROMOTION_TYPE, p.LEVEL_ID, p.ACTIVE_FROM, p.ACTIVE_TO, p.COUPON, p.LIMIT_PER_TRANSACTION, p.LIMIT_PER_DAY, p.LIMIT_NUMBER_OF_ITEM, p.MAXIMUM_LIMIT, p.MEMBER_SEGMENTS_TIERS, p.MEMBER_SEGMENTS, p.ALL_MEMBER_CARD_REQUIRED, p.REWARD_VALUE, p.REWARD_TYPE, p.REWARD_MA_ID, p.REWARD_MA_NAME, p.BUSINESS_TYPE, p.TOTAL_USER AS PROMO_TOTAL_USER, pr.ENTITY_ID, pr.ENTITY_CODE, pr.ENTITY_NAME, pr.ENTITY_TYPE, pr.BARCODE, pr.STATUS AS PRODUCT_STATUS, st.STEP_ID, st.STEP_NAME, st.STEP_ORDER, st.STEP_STATUS, st.WORK_HOURS AS STEP_WORK_HOURS, st.USER_NAME AS STEP_USER, df.DEFECT_ID, df.DEFECT_DETAIL, df.DEFECT_TYPE, df.DEFECT_STATUS, df.CREATED_USER AS DEFECT_USER, df.CREATED_DATE AS DEFECT_DATE, pu.USER_NAME AS PROMO_USER, pu.WORK_HOURS AS PROMO_USER_HOURS, pu.STATUS AS PROMO_USER_STATUS FROM PM_VERSION v LEFT JOIN PM_WORKSHEET w ON w.VERSION_ID = v.VERSION_ID LEFT JOIN PM_SHEET s ON s.WORKSHEET_ID = w.WORKSHEET_ID LEFT JOIN PM_PROMOTION p ON p.SHEET_ID = s.SHEET_ID LEFT JOIN PM_PRODUCT pr ON pr.PROMOTION_ID = p.PROMOTION_ID LEFT JOIN PM_PROMOTION_STEP st ON st.PROMOTION_ID = p.PROMOTION_ID AND st.ENTITY_ID = pr.ENTITY_ID LEFT JOIN PM_DEFECT df ON df.ENTITY_ID = pr.ENTITY_ID LEFT JOIN PM_PROMOTION_USER pu ON pu.PROMOTION_ID = p.PROMOTION_ID; GO /****** Object: View [dbo].[VW_PROMOTION_DETAIL_PROGRESS] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE VIEW [dbo].[VW_PROMOTION_DETAIL_PROGRESS] AS WITH STEP_SUMMARY AS ( SELECT p.PROMOTION_ID, pr.ENTITY_ID, st.STEP_ID, st.STEP_STATUS, st.USER_NAME, CASE WHEN st.STEP_STATUS = 'Completed' THEN 1 ELSE 0 END AS STEP_COMPLETED FROM PM_PROMOTION p LEFT JOIN PM_PRODUCT pr ON pr.PROMOTION_ID = p.PROMOTION_ID LEFT JOIN PM_PROMOTION_STEP st ON st.PROMOTION_ID = p.PROMOTION_ID AND st.ENTITY_ID = pr.ENTITY_ID ), PROMO_PROGRESS AS ( SELECT PROMOTION_ID, COUNT(STEP_ID) AS TOTAL_STEP, SUM(STEP_COMPLETED) AS COMPLETED_STEP, CASE WHEN COUNT(STEP_ID) = 0 THEN 0 ELSE CAST(SUM(STEP_COMPLETED)*100.0/COUNT(STEP_ID) AS DECIMAL(5,2)) END AS PERCENT_PROGRESS_PROMO FROM STEP_SUMMARY GROUP BY PROMOTION_ID ), PRODUCT_PROGRESS AS ( SELECT PROMOTION_ID, ENTITY_ID, COUNT(STEP_ID) AS TOTAL_STEP, SUM(STEP_COMPLETED) AS COMPLETED_STEP, CASE WHEN COUNT(STEP_ID) = 0 THEN 0 ELSE CAST(SUM(STEP_COMPLETED)*100.0/COUNT(STEP_ID) AS DECIMAL(5,2)) END AS PERCENT_PROGRESS_PRODUCT FROM STEP_SUMMARY GROUP BY PROMOTION_ID, ENTITY_ID ), USER_PROGRESS AS ( SELECT PROMOTION_ID, USER_NAME, COUNT(STEP_ID) AS TOTAL_STEP, SUM(STEP_COMPLETED) AS COMPLETED_STEP, CASE WHEN COUNT(STEP_ID) = 0 THEN 0 ELSE CAST(SUM(STEP_COMPLETED)*100.0/COUNT(STEP_ID) AS DECIMAL(5,2)) END AS PERCENT_PROGRESS_USER FROM STEP_SUMMARY GROUP BY PROMOTION_ID, USER_NAME ) SELECT v.YEAR, v.MONTH, v.VERSION_NAME, w.WORKSHEET_ID, w.FILE_NAME AS WORKSHEET_NAME, s.SHEET_ID, s.SHEET_NAME, p.PROMOTION_ID, p.PROMOTION_CODE, p.PROMOTION_NAME, p.PROMOTION_STATUS, p.PROMOTION_TYPE, pr.ENTITY_ID, pr.ENTITY_NAME, st.STEP_ID, st.STEP_NAME, st.STEP_STATUS, st.USER_NAME AS STEP_USER, pp.PERCENT_PROGRESS_PROMO, prp.PERCENT_PROGRESS_PRODUCT, up.PERCENT_PROGRESS_USER FROM PM_VERSION v LEFT JOIN PM_WORKSHEET w ON w.VERSION_ID = v.VERSION_ID LEFT JOIN PM_SHEET s ON s.WORKSHEET_ID = w.WORKSHEET_ID LEFT JOIN PM_PROMOTION p ON p.SHEET_ID = s.SHEET_ID LEFT JOIN PM_PRODUCT pr ON pr.PROMOTION_ID = p.PROMOTION_ID LEFT JOIN PM_PROMOTION_STEP st ON st.PROMOTION_ID = p.PROMOTION_ID AND st.ENTITY_ID = pr.ENTITY_ID LEFT JOIN PROMO_PROGRESS pp ON pp.PROMOTION_ID = p.PROMOTION_ID LEFT JOIN PRODUCT_PROGRESS prp ON prp.PROMOTION_ID = p.PROMOTION_ID AND prp.ENTITY_ID = pr.ENTITY_ID LEFT JOIN USER_PROGRESS up ON up.PROMOTION_ID = p.PROMOTION_ID AND up.USER_NAME = st.USER_NAME; GO /****** Object: Table [dbo].[PM_CHANGE_LOG] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[PM_CHANGE_LOG]( [LOG_ID] [int] IDENTITY(1,1) NOT NULL, [TABLE_NAME] [nvarchar](100) NULL, [RECORD_ID] [nvarchar](100) NULL, [ACTION_TYPE] [nvarchar](10) NULL, [CHANGED_DATE] [datetime] NULL, [CHANGED_USER] [nvarchar](100) NULL, [OLD_VALUES] [nvarchar](max) NULL, [NEW_VALUES] [nvarchar](max) NULL, [NOTE] [nvarchar](500) NULL, PRIMARY KEY CLUSTERED ( [LOG_ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY] ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] GO /****** Object: Table [dbo].[PM_USER_PROFILE] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[PM_USER_PROFILE]( [USER_NAME] [nvarchar](100) NOT NULL, [EMAIL] [nvarchar](255) NULL, [ROLE] [nvarchar](100) NULL, [DEPARTMENT] [nvarchar](100) NULL, PRIMARY KEY CLUSTERED ( [USER_NAME] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY] ) ON [PRIMARY] GO /****** Object: Table [dbo].[PT_DETAIL] Script Date: 2/11/2568 21:38:39 ******/ SET ANSI_NULLS ON GO SET QUOTED_IDENTIFIER ON GO CREATE TABLE [dbo].[PT_DETAIL]( [STORE_NO] [nvarchar](5) NOT NULL, [POS_NO] [int] NOT NULL, [BUSINESS_DATE] [datetime] NOT NULL, [SHIFT_NO] [int] NULL, [RECEIPT_NO] [int] NOT NULL, [RUNNING_NO] [int] NOT NULL, [PROMOTION_ID] [int] NOT NULL, [PROMOTION_NAME] [nvarchar](100) NULL, [SYSTEM_DATE] [datetime] NULL, [UPDATE_USER_ID] [nvarchar](25) NULL, CONSTRAINT [PK_PT_DETAIL] PRIMARY KEY CLUSTERED ( [STORE_NO] ASC, [POS_NO] ASC, [BUSINESS_DATE] ASC, [RECEIPT_NO] ASC, [RUNNING_NO] ASC, [PROMOTION_ID] ASC )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY] ) ON [PRIMARY] GO ALTER TABLE [dbo].[PM_CHANGE_LOG] ADD DEFAULT (getdate()) FOR [CHANGED_DATE] GO ALTER TABLE [dbo].[PM_CHANGE_LOG] ADD DEFAULT (suser_sname()) FOR [CHANGED_USER] GO ALTER TABLE [dbo].[PM_DEFECT] WITH CHECK ADD CONSTRAINT [FK__PM_DEFECT__ENTIT__60A75C0F] FOREIGN KEY([ENTITY_ID]) REFERENCES [dbo].[PM_PRODUCT] ([ENTITY_ID]) GO ALTER TABLE [dbo].[PM_DEFECT] CHECK CONSTRAINT [FK__PM_DEFECT__ENTIT__60A75C0F] GO ALTER TABLE [dbo].[PM_PRODUCT] WITH CHECK ADD CONSTRAINT [FK__PM_PRODUC__PROMO__5DCAEF64] FOREIGN KEY([PROMOTION_ID]) REFERENCES [dbo].[PM_PROMOTION] ([PROMOTION_ID]) GO ALTER TABLE [dbo].[PM_PRODUCT] CHECK CONSTRAINT [FK__PM_PRODUC__PROMO__5DCAEF64] GO ALTER TABLE [dbo].[PM_PROMOTION] WITH CHECK ADD CONSTRAINT [FK__PM_PROMOT__SHEET__5165187F] FOREIGN KEY([SHEET_ID]) REFERENCES [dbo].[PM_SHEET] ([SHEET_ID]) GO ALTER TABLE [dbo].[PM_PROMOTION] CHECK CONSTRAINT [FK__PM_PROMOT__SHEET__5165187F] GO ALTER TABLE [dbo].[PM_PROMOTION] WITH CHECK ADD CONSTRAINT [FK__PM_PROMOT__SHEET__68487DD7] FOREIGN KEY([SHEET_ID]) REFERENCES [dbo].[PM_SHEET] ([SHEET_ID]) GO ALTER TABLE [dbo].[PM_PROMOTION] CHECK CONSTRAINT [FK__PM_PROMOT__SHEET__68487DD7] GO ALTER TABLE [dbo].[PM_PROMOTION_STEP] WITH CHECK ADD CONSTRAINT [FK__PM_PROMOT__ENTIT__6A30C649] FOREIGN KEY([ENTITY_ID]) REFERENCES [dbo].[PM_PRODUCT] ([ENTITY_ID]) GO ALTER TABLE [dbo].[PM_PROMOTION_STEP] CHECK CONSTRAINT [FK__PM_PROMOT__ENTIT__6A30C649] GO ALTER TABLE [dbo].[PM_PROMOTION_STEP] WITH CHECK ADD CONSTRAINT [FK__PM_PROMOT__PROMO__534D60F1] FOREIGN KEY([PROMOTION_ID]) REFERENCES [dbo].[PM_PROMOTION] ([PROMOTION_ID]) GO ALTER TABLE [dbo].[PM_PROMOTION_STEP] CHECK CONSTRAINT [FK__PM_PROMOT__PROMO__534D60F1] GO ALTER TABLE [dbo].[PM_PROMOTION_STEP] WITH CHECK ADD CONSTRAINT [FK__PM_PROMOT__PROMO__693CA210] FOREIGN KEY([PROMOTION_ID]) REFERENCES [dbo].[PM_PROMOTION] ([PROMOTION_ID]) GO ALTER TABLE [dbo].[PM_PROMOTION_STEP] CHECK CONSTRAINT [FK__PM_PROMOT__PROMO__693CA210] GO ALTER TABLE [dbo].[PM_PROMOTION_STEP] WITH CHECK ADD FOREIGN KEY([USER_NAME]) REFERENCES [dbo].[PM_USER_PROFILE] ([USER_NAME]) GO ALTER TABLE [dbo].[PM_PROMOTION_STEP] WITH CHECK ADD FOREIGN KEY([USER_NAME]) REFERENCES [dbo].[PM_USER_PROFILE] ([USER_NAME]) GO ALTER TABLE [dbo].[PM_PROMOTION_USER] WITH CHECK ADD CONSTRAINT [FK__PM_PROMOT__PROMO__5535A963] FOREIGN KEY([PROMOTION_ID]) REFERENCES [dbo].[PM_PROMOTION] ([PROMOTION_ID]) GO ALTER TABLE [dbo].[PM_PROMOTION_USER] CHECK CONSTRAINT [FK__PM_PROMOT__PROMO__5535A963] GO ALTER TABLE [dbo].[PM_PROMOTION_USER] WITH CHECK ADD CONSTRAINT [FK__PM_PROMOT__PROMO__6B24EA82] FOREIGN KEY([PROMOTION_ID]) REFERENCES [dbo].[PM_PROMOTION] ([PROMOTION_ID]) GO ALTER TABLE [dbo].[PM_PROMOTION_USER] CHECK CONSTRAINT [FK__PM_PROMOT__PROMO__6B24EA82] GO ALTER TABLE [dbo].[PM_PROMOTION_USER] WITH CHECK ADD FOREIGN KEY([USER_NAME]) REFERENCES [dbo].[PM_USER_PROFILE] ([USER_NAME]) GO ALTER TABLE [dbo].[PM_PROMOTION_USER] WITH CHECK ADD FOREIGN KEY([USER_NAME]) REFERENCES [dbo].[PM_USER_PROFILE] ([USER_NAME]) GO ALTER TABLE [dbo].[PM_SHEET] WITH CHECK ADD FOREIGN KEY([WORKSHEET_ID]) REFERENCES [dbo].[PM_WORKSHEET] ([WORKSHEET_ID]) GO ALTER TABLE [dbo].[PM_SHEET] WITH CHECK ADD FOREIGN KEY([WORKSHEET_ID]) REFERENCES [dbo].[PM_WORKSHEET] ([WORKSHEET_ID]) GO ALTER TABLE [dbo].[PM_VERSION] WITH NOCHECK ADD CONSTRAINT [FK_PM_VERSION_PM_VERSION] FOREIGN KEY([VERSION_ID]) REFERENCES [dbo].[PM_VERSION] ([VERSION_ID]) GO ALTER TABLE [dbo].[PM_VERSION] CHECK CONSTRAINT [FK_PM_VERSION_PM_VERSION] GO ALTER TABLE [dbo].[PM_VERSION] WITH CHECK ADD CONSTRAINT [FK_PM_VERSION_PM_VERSION1] FOREIGN KEY([VERSION_ID]) REFERENCES [dbo].[PM_VERSION] ([VERSION_ID]) GO ALTER TABLE [dbo].[PM_VERSION] CHECK CONSTRAINT [FK_PM_VERSION_PM_VERSION1] GO