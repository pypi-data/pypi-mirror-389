name: Publish to PyPI

on:
  push:
    branches:
      - master
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: false
        type: string

jobs:
  check-version:
    name: Check if version changed
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      version_changed: ${{ steps.check_version.outputs.changed }}
      tag_exists: ${{ steps.check_tag.outputs.exists }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version from pyproject.toml
      id: get_version
      run: |
        VERSION=$(grep -E '^version = ' pyproject.toml | sed -E "s/^version = ['\"](.*)['\"]/\1/")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Check if tag exists
      id: check_tag
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag v${VERSION} already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Tag v${VERSION} does not exist"
        fi

    - name: Check if version changed
      id: check_version
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        TAG_EXISTS="${{ steps.check_tag.outputs.exists }}"
        if [ "$TAG_EXISTS" = "false" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Version ${VERSION} is new, will publish"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "Version ${VERSION} already published"
        fi

  publish:
    name: Build and publish to PyPI
    needs: check-version
    if: needs.check-version.outputs.version_changed == 'true' || github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install build dependencies
      run: |
        uv venv
        uv pip install build --python .venv/bin/python

    - name: Extract version from pyproject.toml
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=$(grep -E '^version = ' pyproject.toml | sed -E "s/^version = ['\"](.*)['\"]/\1/")
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version to publish: $VERSION"

    - name: Build package
      run: |
        .venv/bin/python -m build

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: dist/
        print-hash: true

    - name: Create Git tag
      if: needs.check-version.outputs.version_changed == 'true' && github.event_name != 'release'
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "v${VERSION}" -m "Release v${VERSION}"
        git push origin "v${VERSION}"

    - name: Create GitHub Release
      if: needs.check-version.outputs.version_changed == 'true' && github.event_name != 'release'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: Release v${{ steps.get_version.outputs.version }}
        body: |
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for details.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
