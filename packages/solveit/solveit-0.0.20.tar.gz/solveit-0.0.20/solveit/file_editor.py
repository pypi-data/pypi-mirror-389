"""Create solveit in Fasthtml for course"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/09_file_editor.ipynb.

# %% auto 0
__all__ = ['not_editable', 'file_editor_', 'callgit', 'get_top', 'Git', 'git_btn', 'handle_git_', 'save_file_', 'save_dlg_']

# %% ../nbs/09_file_editor.ipynb
import subprocess
from subprocess import CalledProcessError
import shutil,stat
from datetime import datetime, UTC
from fasthtml.common import *
from monsterui.all import *
from .db import *
from .setup_app import rt

# %% ../nbs/09_file_editor.ipynb
not_editable = {".png", ".jpg", ".jpeg", ".wav", ".mp3", ".mp4", ".m4a", ".zip", ".db", ".ipynb"}

# %% ../nbs/09_file_editor.ipynb
def _file_editor_js(fp:Path):
    return """import loader from 'https://esm.sh/@monaco-editor/loader@1.6.1';
loader.init().then(monaco => {
  window.editor?.getModel()?.dispose();
  const model = monaco.editor.createModel(%s, null, monaco.Uri.file('%s'));
  const editor = monaco.editor.create(document.getElementById('file_editor'), {
    model:model, fontSize:16, scrollBeyondLastLine:false,
    theme:htmlTag.classList.contains('dark')? 'vs-dark': 'vs-light',
  });
  editor.focus();
  editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KeyS, () => {
    htmx.ajax('POST', '/save_file_', {values: {fp:'%s', content:editor.getValue()}, swap:'none'});
  });
  window.editor = editor;
});
""" % (repr(fp.read_text()), fp.name, str(fp))

# %% ../nbs/09_file_editor.ipynb
@rt
def file_editor_(fp:str):
    return Div(cls="h-screen p-4")(
        Div(id="file_editor", cls="h-full"),
        Script(_file_editor_js(Path(fp)), type="module")
    )

# %% ../nbs/09_file_editor.ipynb
def callgit(path, *args, split=None):
    fp = Path(path).resolve()
    args = ['git', '-C', str(fp)] + list(args)
    if uname: args = ['sudo', '-u', uname] + args
    res = subprocess.run(args, capture_output=True, text=True, check=True).stdout.strip()
    if split is None: return res.splitlines() if '\n' in res else res
    return res.splitlines() if split else res

# %% ../nbs/09_file_editor.ipynb
def get_top(folder):
    try: return callgit(folder, 'rev-parse', '--show-toplevel')
    except CalledProcessError: return None

# %% ../nbs/09_file_editor.ipynb
class Git:
    def __init__(self, d): self.d = Path(d)

    def __call__(self, cmd, *args, split=None, **kwargs):
        args = listify(args)
        args += concat((f'-{k}',v) for k,v in kwargs.items() if len(k)==1)
        args += [f'--{k}={v}' for k,v in kwargs.items() if len(k)>1]
        try: return callgit(self.d, cmd, *args, split=split)
        except CalledProcessError: return None

    def __getattr__(self, nm):
        if nm.startswith('_'): raise AttributeError(nm)
        return partial(self, nm.replace('_','-'))

    def top(self): return self.rev_parse('--show-toplevel')
    
    @property
    def exists(self): return self.top() is not None

# %% ../nbs/09_file_editor.ipynb
def _git_init(g):
    if g.exists: return r # Return early if git already initialised
    g.init(b='main')
    (g.d/".gitignore").mk_write(Path("solveit/.gitignore.sample").read_text(), uid=uid, gid=gid)
    g.add(".gitignore")
    g.commit(m="solveit commit: add .gitignore")
    g.checkout(b=friendly_name())

# %% ../nbs/09_file_editor.ipynb
@patch(as_prop=True)
def last_commit(self:Git): return self.log('-1', pretty='format:%s')

# %% ../nbs/09_file_editor.ipynb
def _git_commit(g):
    if not g.exists: return
    if not g.status('--porcelain'): return  # No changes
    g.add('-A')
    g.commit(m=f"solveit commit: {datetime.now(UTC):%b. %d %H:%M:%S UTC}")

# %% ../nbs/09_file_editor.ipynb
def _merge_branch(g, msg=''):
    _git_commit(g)  # Prelim commit to avoid losing local changes
    current = g.branch('--show-current')
    base = 'main'
    if g.show_ref('--verify', '--quiet', 'refs/heads/main') is None: base = 'master'
    g.checkout(base)
    g.merge(current, '--squash')
    g.commit(m=msg or f'Checkpoint saved: {current}')
    g.branch(D=current)
    new_branch = friendly_name()
    g.checkout(b=new_branch)
    return new_branch

# %% ../nbs/09_file_editor.ipynb
def git_btn(fp):
    g = Git(fp)
    has_git = g.exists
    txt = 'Checkpoint' if has_git else 'Enable versioning'
    prompt='Enter a checkpoint name:' if has_git else None
    return Button(txt,
                  hx_post=handle_git_.to(fp=fp), hx_swap='outerHTML', hx_prompt=prompt,
                  cls="uk-btn-sm uk-btn-default text-nowrap")

@rt
async def handle_git_(sess, htmx:HtmxHeaders, fp:str):
    "Init git at `fp` if not created, else squash commits -> merge w/ main -> checkout new branch"
    g = Git(fp)
    if g.exists:
        try: _merge_branch(g, htmx.prompt)
        except Exception as e: add_toast(sess, f'Error saving checkpoint: {e}', 'error')
    else:
        _git_init(g)
        add_toast(sess, f'Version tracking enabled for {Path(fp).relative_to(datapath)}')
    return git_btn(fp)

# %% ../nbs/09_file_editor.ipynb
@patch(as_prop=True)
def commits(self:Git): return self.log('--oneline', split=True)

# %% ../nbs/09_file_editor.ipynb
def _save_alert():
    return Div(hx_swap_oob="afterbegin:body")(
        P("Saved!", id="save-alert", cls="text-white fixed top-2 left-1/2 -translate-x-1/2 z-10 bg-green-600/90 py-2 px-4 rounded-lg",
            hx_trigger="load", hx_on__trigger="setTimeout(() => {htmx.find('#save-alert').remove()}, 1000)"
        )
    )

# %% ../nbs/09_file_editor.ipynb
@rt
def save_file_(fp:str, content:str):
    "Save the file and commit any changes."
    fp = Path(fp)
    fp.write_text(content)
    _git_commit(Git(Path(datapath/f'{fp}').parent))
    return _save_alert()

# %% ../nbs/09_file_editor.ipynb
@rt
def save_dlg_(dlg:Dialog):
    "Save the dialog and commit any changes."
    # Note: `dlg` is automatically written to disk in `Dialog.__from_request__`
    _git_commit(Git(Path(datapath/f'{dlg.name}.ipynb').parent))
    return _save_alert()
