"""Create solveit in Fasthtml for course"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/07_cards.ipynb.

# %% auto 0
__all__ = ['md_cls_d', 'nbdev_index', 'pylexer', 'txtlexer', 'fmtr', 'code_types', 'msg_colors', 'icon_cls', 'scrollkw', 'jsid',
           'full_editor', 'h_ptn', 'mk_data_url', 'embed_attachments', 'MathBase', 'MathInlineParens',
           'MathBlockBrackets', 'MathInlineDollar', 'MathBlockTwoDollar', 'SolveItRenderer', 'md', 'code2md',
           'get_md_blocks', 'prefill_form', 'Icon', 'CollapseIcon', 'ToggleIco', 'SkipIcon', 'ExportIcon', 'PinIcon',
           'MsgCollapseIcon', 'MsgButtons', 'MagicCard', 'Js', 'edit_kw', 'MessageCard', 'vals_from_code',
           'get_heading', 'sb_data', 'sb_item', 'sb_block']

# %% ../nbs/07_cards.ipynb
from base64 import b64decode,b64encode
from fasthtml.common import *
from fastcore.utils import *
from fastcore.ansi import ansi2html
from monsterui.all import *
from datetime import datetime
from nbdev.doclinks import NbdevLookup
from uuid import uuid4
from queue import Empty
from mistletoe.contrib.pygments_renderer import PygmentsRenderer
from mistletoe.markdown_renderer import MarkdownRenderer
from lisette import re_tools

from pygments import highlight
from pygments.lexers import PythonLexer, TextLexer
from pygments.formatters import HtmlFormatter

import io, mistletoe, ast, PIL, re, itertools

from .db import *
from .gateway import *
from .kernel import *
from .ipynb import *
from .aimsg import *

# %% ../nbs/07_cards.ipynb
from fastlucide.icons import (
    spritesheet, Eye_off, Eye, Bookmark_check, Bookmark_x, Pin, Pin_off,
    Chevron_right, Chevron_left, Chevron_up, Chevron_down, External_link, Loader,
    Clipboard_copy, Clipboard_list, Message_square_plus, Play, Trash, Database_zap, Log_out, Log_in,
    Arrow_up_to_line, Arrow_down_to_line, Book_up, Book_down, Merge, Search, Sparkles,
    Ampersand, Ampersands
)

# %% ../nbs/07_cards.ipynb
def mk_data_url(attachment_id, attd):
    try: img = attd[attachment_id]
    except KeyError: return f"<div>image '{attachment_id}' not found</div>"
    try: pil_img = PIL.Image.open(io.BytesIO(img.data))
    except PIL.UnidentifiedImageError: return f"<div>Unable to identify image file.</div>"
    w,_ = pil_img.size
    dpi = pil_img.info.get('dpi')
    if dpi and dpi[0] > 92 or w > 1000:
        return f'<img srcset="data:{img.content_type};base64,{b64encode(img.data).decode()} 2x" alt="pasted_image">'
    else:  return f'<img src="data:{img.content_type};base64,{b64encode(img.data).decode()}" alt="pasted_image">'

def embed_attachments(html, attd:dict=None):
    if not attd: attd={}
    if not isinstance(html,NotStr): return html
    else: raw_str = str(html)
    pat = r"""<img\s+(?:[^>]*?\s+)?src=["']attachment:(?P<attachid>[^"']+)["'][^>]*?>"""
    replacements = [(m.start(), m.end(), mk_data_url(m.group('attachid'), attd)) for m in re.finditer(pat,raw_str)]
    for start, end, data_url in reversed(replacements):
        raw_str = raw_str[:start] + data_url + raw_str[end:]
    return NotStr(raw_str)

# %% ../nbs/07_cards.ipynb
class MathBase(mistletoe.span_token.SpanToken): parse_inner = False
class MathInlineParens(MathBase):   pattern = re.compile(r"(?s)\\\((.*?)\\\)")
class MathBlockBrackets(MathBase):  pattern = re.compile(r"(?s)\\\[(.*?)\\\]")
class MathInlineDollar(MathBase):   pattern = re.compile(r"\$((?!\s)(?:\\\$|[^$\n])+?(?<!\s))\$")
class MathBlockTwoDollar(MathBase): pattern = re.compile(r"(?s)\$\$(.*?)\$\$")

# %% ../nbs/07_cards.ipynb
class SolveItRenderer(FrankenRenderer, PygmentsRenderer):
    formatter = HtmlFormatter(noclasses=False)
    def __init__(self, *args, math_mode=0, **kwargs):
        tokens = [MathBlockTwoDollar,MathBlockBrackets,MathInlineParens] if math_mode > 0 else []
        if math_mode==2: tokens.append(MathInlineDollar)
        super().__init__(*tokens, *args, **kwargs)
        self.render_map["BlankLine"] = self.render_blank_line

    def render_math_block_brackets(self,token):   return fr"\[{self.render_raw_text(token)}\]"
    def render_math_block_two_dollar(self,token): return fr"\[{self.render_raw_text(token)}\]"
    def render_math_inline_parens(self,token):    return fr"\({self.render_raw_text(token)}\)"
    def render_math_inline_dollar(self,token):    return fr"\({self.render_raw_text(token)}\)"
    def render_blank_line(self, token): return ""

# %% ../nbs/07_cards.ipynb
md_cls_d = {
    **{f'h{i}': f'uk-h{i}' for i in range(1,5)},
    'a': "uk-link",
    'blockquote': "uk-blockquote",
    'hr':'uk-divider-icon',
    'table':'uk-table uk-table-sm uk-table-middle uk-table-divider border [&_tr]:divide-x w-[80%] mx-auto',
    'ol': 'uk-list uk-list-decimal space-y-0', 
    'ul': 'uk-list uk-list-bullet space-y-0',
    'p': 'leading-tight',
    'li': 'leading-tight',
    'pre': '', 'pre code': '',
    'code': 'tracking-tight'
}

nbdev_index = NbdevLookup(('nbdev_stdlib','nbdev_numpy'))

def md(s, is_code=False, atts:list=None, img_dir='.'): 
    if not s: return s
    s = str(s)
    if not is_code: s = nbdev_index.linkify(s)
    renderer = partial(SolveItRenderer, math_mode=get_math_mode())
    res = render_md(s, class_map=md_cls_d, img_dir=img_dir, renderer=renderer)
    attd = {a.id:a for a in atts or []}
    return embed_attachments(res, attd=attd)

# %% ../nbs/07_cards.ipynb
pylexer,txtlexer,fmtr = PythonLexer(),TextLexer(),HtmlFormatter()

def code2md(code, lang='python'):
    "Create markdown code block from code"
    lexer = pylexer if lang == 'python' else txtlexer
    return NotStr(highlight(code, lexer, fmtr))

# %% ../nbs/07_cards.ipynb
if 'mdr' not in globals(): mdr = MarkdownRenderer().render
def _md_tpl(t):
    if isinstance(t, mistletoe.block_token.CodeFence):
        return (t.language.lower() if t.language else "", t.children[0].content)
    else: return ".",mdr(t)

# %% ../nbs/07_cards.ipynb
code_types = ('python','py','bash','sh')

def get_md_blocks(s, code=True):
    "Get all code blocks with their languages from md string or code outputs"
    if isinstance(s, list):
        return [block for o in s 
                if o.get('output_type') == 'display_data' 
                and 'text/markdown' in o.get('data', {})
                for block in get_md_blocks(o['data']['text/markdown'], code)]
    res = [_md_tpl(t) for t in mistletoe.Document(re_tools.sub('', s)).children]
    if code: return [o for o in res if o[0] in code_types]
    else: return [o for o in res if o[0]!='.']

# %% ../nbs/07_cards.ipynb
def prefill_form(flds, o, **kw):
    "Fills in a form with hidden inputs with given values and names"
    return Form(*[Hidden(name=fld, value=getattr(o, fld)) for fld in flds], **kw)

# %% ../nbs/07_cards.ipynb
msg_colors = {snote:'#2ecc71', scode:'#4a90e2', sprompt:'#e74c3c', sraw:'#f7e017'}

# %% ../nbs/07_cards.ipynb
spritesheet.sz=16

# %% ../nbs/07_cards.ipynb
icon_cls = ('text-muted-foreground', 'uk-btn-ghost', 'hover:text-[hsl(var(--foreground))]', 'transition-all', 'cursor-pointer')
_toggle_cls = ("shadow", "rounded-sm", "outline", "outline-1", "outline-[hsl(var(--border))]")

def Icon(msgid, route, icon=None, tip=None, ico=None, is_input=1, hx_swap='none', **kwargs):
    "Create a button with an icon associated with a message that triggers an HTMX get request when clicked"
    if not ico: ico = icon(uk_tooltip=tip)
    vals = dict(is_input=is_input, msgid=msgid)
    return Div(ico, cls=icon_cls, hx_post='/'+route, hx_vals=vals, hx_swap=hx_swap, hx_sync='body:queue all', **kwargs)

# %% ../nbs/07_cards.ipynb
# Add these to buttons which update multiple messages in the container & need to preserve scroll location
# TODO think about handling scroll location
scrollkw = dict()

def CollapseIcon(msg):
    "Create a button to toggle children collapse state"
    icon = Chevron_right if msg.heading_collapsed else Chevron_down
    return Button(icon(sz=20), cls=(*icon_cls, 'p-0'), hx_post="/toggle_header_collapse_",
                    hx_swap="none", hx_include=f"inherit,#form-{msg.id}", **scrollkw)

# %% ../nbs/07_cards.ipynb
def _is_collapsed(msg, is_input):
    "Check if message `sid` has a collapsed input/output."
    return msg.i_collapsed if is_input else msg.o_collapsed

# %% ../nbs/07_cards.ipynb
def ToggleIco(flag, on, off, tip, cls=""): return (on if flag else off)(uk_tooltip=tip, cls=cls)
def SkipIcon(flag): return ToggleIco(flag, Eye_off, Eye, 'Include in prompt? (h)')
def ExportIcon(flag): return ToggleIco(flag, Bookmark_check, Bookmark_x, 'Will be exported? (e)')
def PinIcon(flag): return ToggleIco(flag, Pin, Pin_off, 'Pin this message? (p)')
def MsgCollapseIcon(flag, cls="", is_input=1): return ToggleIco(flag, Chevron_down, Chevron_up, f'Collapse contents ({"i" if is_input else "o"})', cls=cls)

# %% ../nbs/07_cards.ipynb
def MsgButtons(msg, is_runnable=False, is_input:int=1, is_exported:bool=False,
               skipped:bool=False, pinned:bool=False, **kwargs):
    "Construct the top level of buttons on each card"
    icls = ' '.join(icon_cls)
    Ico = partial(Icon, msg.id)
    focus_clk = dict(
        hx_on_click="document.dispatchEvent(new KeyboardEvent('keydown', {key: '/', code: 'Slash', keyCode: 191}))")
    res = [Ico('copy_msg_', Clipboard_copy, 'Copy (c)', is_input=is_input, hx_swap='innerHTML', **focus_clk)]
    copy_code = Ico('copy_code_', Clipboard_list, 'Copy code ([)', hx_swap='innerHTML', **focus_clk)
    add_code = Ico('split_code_', Message_square_plus, 'Add fenced block messages (w)')
    skip = Ico('toggle_skip_', ico=SkipIcon(skipped))
    export = Ico('toggle_export_', ico=ExportIcon(is_exported))
    pin_msg = Ico('toggle_pin_', ico=PinIcon(pinned))
    run   = Ico('add_runq_', Play, 'Run Cell (⌘/ctrl-enter)', hidden=not is_runnable, hx_swap='none')
    trash = Ico(qp('rm_msg_', msid=msg.id), Trash, 'Delete Message (⇧-d)', hx_swap='none')

    del_after = Ico('del_below_', Database_zap, 'Delete below', hx_confirm="Delete all messages below this?", **scrollkw)

    below = Ico('run_below_', Log_out, 'Run Below (⇧-b)')
    above = Ico('run_above_', Log_in , 'Run Above (⇧-a)')
    add_above = Ico('add_above_', Arrow_up_to_line  , "Add Above (a)")
    add_below = Ico('add_below_', Arrow_down_to_line, "Add Below (b)")
    dup_msg = Ico('dup_msg_', Message_square_plus, 'Add copy of message (q)', tabindex=-1)
    
    shift_upward = Ico('shift_up_', Book_up, 'Shift up', **scrollkw)
    shift_downward = Ico('shift_down_', Book_down,'Shift down', **scrollkw)
    merge_msg = Ico('merge_msg_', Merge, 'Merge with message below (⇧-m)', **scrollkw)
    reprompt = Ico('add_runq_', Sparkles, 'Re-run AI', hx_swap='none')

    sc_url = qp('/show_card_', msgid=msg.id, with_input=is_input, dlg_name=msg.dlg.name)
    newtab = A(External_link(cls=icls, uk_tooltip='Open in new tab (t)'), href=sc_url, target="_blank")
    toggle = Ico('collapse_', ico=MsgCollapseIcon(_is_collapsed(msg, is_input), is_input=is_input), is_input=is_input)

    if is_input:
        res += [run, skip, export, trash, del_after, above, below, add_above, add_below,
                shift_upward, shift_downward, dup_msg, merge_msg, pin_msg]
    else:
        res += [copy_code, add_code]
        if not is_runnable: res += [reprompt]
    res += [newtab, toggle]
    return DivRAligned(*res, cls='space-x-2 mt-1', id=f'btns{msg.id}', **kwargs)

# %% ../nbs/07_cards.ipynb
def MagicCard(*c, msg_type:str, msg:Message, role:str='', is_input:int=1, is_spin=False, time_run=None,
              is_exported:bool=False, skipped:bool=False, pinned:bool=False, num_toks:int=0, **kw):
    "An FT Component representation of a message"
    msgid = msg.id
    collapsed = _is_collapsed(msg, is_input)
    clamped = msg.i_clamp if is_input else msg.o_clamp
    head_cursor = 'cursor-alias' if is_input or msg_type==sprompt else ''
    ctitle = f'{(role or "").capitalize()}: {num_toks or 0:,}'
    has_header = msg and msg.header_level() > 0
    if has_header and msg.heading_collapsed:
        ct = sum(c.token_count for c in msg.children() if not c.skipped)
        if ct > 0: ctitle = f'{(role or "").capitalize()}: {num_toks or 0:,} + {ct:,}'
    collapse_btn = CollapseIcon(msg) if has_header else ""
    spinner = Loader(cls='animate-spin ml-1') if is_spin else ()
    rolecls = f"grow p-1 {head_cursor} flex items-center"
    time_el = Span(f' ({time_run})' if time_run else '', cls='time-el')
    rolep = Div(P(ctitle, time_el, cls=TextPresets.muted_sm), spinner, cls=rolecls, **kw)
    btns = Div(MsgButtons(msg, is_runnable=msg_type==scode, is_input=is_input,
                         is_exported=is_exported, skipped=skipped, pinned=pinned))
    endcls = 'self-end' if not is_input else ''
    colcls = 'collapsed' if collapsed else ''
    inoutcls = 'card-in' if is_input else 'card-out'
    clampcls = 'shadow-inner shadow-slate-600' if clamped else ''
    return Card(*c,
        style={'border-left-color': msg_colors[msg_type], 'border-left-width': '5px'},
        header=DivFullySpaced(collapse_btn, rolep, btns),
        id=f"{msgid}-{'i' if is_input else 'o'}",
        body_cls=f'p-1.5 pt-1 {"max-h-[calc(60vh-7rem)] flex-col-reverse" if clamped else "flex-col"}',
        header_cls='pl-1 pt-0 pb-0 pr-2',
        cls=f"msg-card {endcls} !pb-0 {colcls} {inoutcls} {clampcls}")

# %% ../nbs/07_cards.ipynb
jsid = 'js-script'
def Js(s:str): return Script(s, id=jsid, hidden=True), HtmxResponseHeaders(reswap='outerHTML', retarget=f'#{jsid}')

# %% ../nbs/07_cards.ipynb
def _copy_snippet(cts):
    copy_btn = Div(
        Clipboard_copy(cls='w-4 h-4'),
        data_code=cts,
        onclick="""navigator.clipboard.writeText(this.dataset.code); 
                   const msg = this.nextElementSibling; 
                   msg.style.opacity='1'; 
                   setTimeout(() => msg.style.opacity='0', 2000)""",
        cls='absolute top-2 right-2 opacity-50 hover:opacity-100 cursor-pointer bg-transparent border-0'
    )
    feedback = Span(
        "Copied!",
        cls='absolute top-2 right-10 text-sm bg-green-500 text-white px-2 py-1 rounded opacity-0 transition-opacity duration-500'
    )
    return Div(copy_btn, feedback)

# %% ../nbs/07_cards.ipynb
@patch
def render_block_code(self:SolveItRenderer, token):
    code_html = self._orig_render_block_code(token)    
    return str(Div(_copy_snippet(token.content), NotStr(code_html), cls='relative'))

# %% ../nbs/07_cards.ipynb
@patch(as_prop=True)
def render_content(self: Message):
    if not self._rcts:
        if self.msg_type in (snote, sprompt): self._rcts = md(self.content, is_code=False, atts=self.attachments, img_dir=f'/static/{Path(self.dlg.name).parent}')
        else: self._rcts = code2md(self.content, lang='python' if self.msg_type == scode else 'plaintext')
    return self._rcts

# %% ../nbs/07_cards.ipynb
@patch(as_prop=True)
def render_output(self: Message):
    if not self._rout:
        if self.msg_type==snote: self._rout = ''
        elif self.msg_type==sprompt: self._rout = md(self.output, is_code=False, img_dir=f'/static/{Path(self.dlg.name).parent}')
        elif self.msg_type==scode: self._rout = render_outputs(self.output or [], ansi2html, pygments=True)
    return self._rout

# %% ../nbs/07_cards.ipynb
full_editor = 'full_editor'

# %% ../nbs/07_cards.ipynb
def edit_kw(msg, is_input:int=1):
    "Sets up the kwargs for on click htmx attributes to handle message editing"
    if not is_input and msg.msg_type!=sprompt: return {}
    msgid = msg.id
    return dict(target_id=full_editor, hx_post='/editor_', hx_include=f"inherit,#form-{msgid}", title="Click to edit",
                  hx_vals={"is_input":is_input}, hx_trigger='click[!window.editor?.getValue()]',
                  hx_on__after_request="enterEditMode();")

# %% ../nbs/07_cards.ipynb
def MessageCard(msg:Message, oob=None, run=None, scroll=None, **kwargs):
    update_msg_counts(msg)
    msgid,content,typ,dlg = msg.id,msg.content,msg.msg_type,msg.dlg
    if msg.hidden: return Div(id=msgid, hidden=True) # placeholder for header collapse oob_swaps
    hdn_form = prefill_form(['content', 'output', 'msg_type'], msg, id=f'form-{msgid}', hidden=True)
    # Can't use prefill_form for id since name is different
    hdn_form(Hidden(name='msgid', value=msg.id))

    if oob is None:    oob   =getattr(msg, 'oob'   ,  None)
    if run is None:    run   =getattr(msg, 'run'   , False)
    if scroll is None: scroll=getattr(msg, 'scroll', False)
    msg.oob = None
    if scroll: kwargs['hx-on::load'] = 'debounceScroll(this)'
    inp = MagicCard(Div(msg.render_content, cls='space-y-3'), hdn_form, msg=msg, msg_type=typ, role=typ, is_spin=run,
                    time_run=msg.time_run, is_exported=msg.is_exported, num_toks=msg.input_tokens,
                    skipped=msg.skipped, pinned=msg.pinned, **edit_kw(msg, is_input=1))
    out = MagicCard(Div(Safe(msg.render_output), cls='space-y-3'), msg_type=msg.msg_type,
                    role='Assistant' if msg.msg_type==sprompt else 'Output', is_input=0, skipped=msg.skipped,
                    num_toks=msg.output_tokens, msg=msg, **edit_kw(msg, is_input=0))
    smode_kws = dict(
        hx_on_click='selectMsg($(this))',
        data_sm='unselected',
        data_sm_parent=getattr(msg.parent(),'id',None),
        data_sm_header='collapsed' if msg.heading_collapsed else 'expanded' if msg.header_level()>0 else None,
    )
    res = Div(inp, out if msg.render_output else None, id=msgid, cls='editable space-y-1 flex flex-col my-1.5 p-px rounded-lg', **smode_kws, **kwargs)
    if oob:
        # HTMX docs: "the encapsulating tag pair will be stripped for all strategies other than outerHTML"
        if oob in ('true','outerHTML'): res.hx_swap_oob = oob
        else: res = Div(res, hx_swap_oob=oob)
    return res

# %% ../nbs/07_cards.ipynb
def vals_from_code(code:str):
    "Parse Python code and return user-defined variable/function names"
    try: return [node.id if isinstance(node, ast.Name) else node.name for node in ast.walk(ast.parse(code))
        if isinstance(node, ast.FunctionDef) or (isinstance(node, ast.Name) and isinstance(node.ctx, ast.Store))]
    except Exception: return []

# %% ../nbs/07_cards.ipynb
h_ptn = re.compile(r'\s{0,3}(?P<level>#{1,6})\s+(?P<text>.+)')
def get_heading(content):
    "Return match object from content if content begins with a markdown heading."
    return h_ptn.match(content)

# %% ../nbs/07_cards.ipynb
def sb_data(msgs, vs, fs):
    "Extract all sidebar data in single pass"
    sbvs, sbfs, sbhs = {},{},{}
    for m in msgs:
        if m.msg_type == sprompt: continue
        syms = vals_from_code(m.content)
        if m.msg_type == scode and filter_ex(syms, in_(vs|fs)):
            for var in syms:
                if var in vs: sbvs[var] = (vs[var], m)
                if var in fs: sbfs[var] = (fs[var], m)
        elif m.msg_type == snote and (hd := get_heading(m.content)): 
            sbhs[f'{hd["text"]}:{m.id}'] = (hd['level'].count('#'), m)
    return {"Headings": sbhs, "Variables": sbvs, "Functions": sbfs}

# %% ../nbs/07_cards.ipynb
def sb_item(section, item):
    "Create an li node for sidebar item"
    name,value,msg = flat_tuple(item)
    disp = f"{name}{value}"
    cls = "p-1 rounded-sm cursor-pointer hover:bg-[hsl(var(--muted))] truncate"
    click_js = f"selectMsg($('#{msg.id}'), centered=true)"
    if section == "Headings":
        disp = '\u00a0' * (value-1) * 2 + name.split(':')[0]
        cls += " font-semibold"
        if msg.is_exported: cls += " border-l-2 border-l-[hsl(var(--destructive))]"
        if msg.skipped: cls += " bg-muted"
    elif section == "Variables": disp = f"{name} = {value}"
    return Li(disp, cls=cls, hx_on_click=click_js)

# %% ../nbs/07_cards.ipynb
def sb_block(section, vardict):
    "Create a Ul block from section name & sidebar items"
    content = [sb_item(section, v) for v in vardict.items()] if vardict \
    else [Li(Em("No values found..."), cls="p-1 leading-loose")]
    
    return Div(cls="flex flex-col w-full p-1.5 border rounded")(
                Caption(section, cls='text-[13pt] border-b'),
                Ul(*content, cls='divide-y pt-1'))
