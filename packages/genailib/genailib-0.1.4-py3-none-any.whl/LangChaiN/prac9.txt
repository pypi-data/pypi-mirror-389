# --- Practical 9: SURF and HOG Feature Descriptor ---
#!pip install opencv-python opencv-contrib-python numpy matplotlib

import cv2
import numpy as np

# --- Function to compute HOG features ---
def compute_hog(img):
    hog = cv2.HOGDescriptor()
    img_resized = cv2.resize(img, (64, 128))
    return hog.compute(img_resized)

# --- Load Image ---
path = input("Enter image path: ").strip()
img = cv2.imread(path)
if img is None:
    print("Error: Cannot read image.")
    exit()

gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

# --- Try SURF (if available), else fallback to SIFT ---
try:
    surf = cv2.xfeatures2d.SURF_create(400)
    method = "SURF"
except:
    surf = cv2.SIFT_create()
    method = "SIFT"

# --- Detect keypoints and descriptors ---
kp, des = surf.detectAndCompute(gray, None)
print(f"{method} detected {len(kp)} keypoints with descriptor shape {des.shape}")

# --- Draw keypoints ---
out_img = cv2.drawKeypoints(img, kp, None, (0, 255, 0), flags=2)
cv2.imwrite("keypoints.jpg", out_img)
print("Saved keypoints image as 'keypoints.jpg'")

# --- Compute HOG ---
hog_features = compute_hog(gray)
np.save("hog.npy", hog_features)
print(f"HOG descriptor shape: {hog_features.shape}")

# -------------------------------------------------------------
# 2Ô∏è‚É£ HOG (Histogram of Oriented Gradients)
# -------------------------------------------------------------
hog = cv2.HOGDescriptor()
hog_features = hog.compute(img)

print("\n‚úÖ HOG Descriptor Computed Successfully")
print("HOG Descriptor Shape:", hog_features.shape)


# -------------------------------------------------------------
# üîπ THEORY & EXPLANATION FOR VIVA üîπ
# -------------------------------------------------------------

# üéØ AIM:
# To detect and describe local image features using SURF and HOG descriptors in OpenCV.

# -------------------------------------------------------------
# üß† CONCEPT OVERVIEW:

# ‚û§ Feature Descriptors:
# These are numerical representations of important image regions (edges, corners, textures)
# used for tasks like matching, recognition, and classification.

# -------------------------------------------------------------
# üî∏ 1. SURF (Speeded-Up Robust Features)

# ‚û§ Overview:
#   - Based on SIFT but faster.
#   - Uses **Hessian Matrix** to detect interest points (blobs).
#   - Provides scale and rotation invariance.

# ‚û§ Key Concepts:
#   - Hessian Matrix (H):
#       H(x, y, œÉ) = [[Lxx, Lxy],
#                     [Lxy, Lyy]]
#     where Lxx, Lyy, Lxy are second-order Gaussian derivatives.
#
#   - Points with large determinant |H| are potential keypoints.

# ‚û§ Steps:
#   1Ô∏è‚É£ Interest Point Detection using Hessian Matrix.
#   2Ô∏è‚É£ Orientation Assignment based on Haar wavelet responses.
#   3Ô∏è‚É£ Descriptor Computation using 4x4 sub-regions (each 64-D vector).

# ‚û§ Advantages:
#   - Faster than SIFT.
#   - Robust to scale, rotation, and illumination changes.

# ‚û§ OpenCV Functions:
#   - cv2.xfeatures2d.SURF_create(hessianThreshold)
#   - detectAndCompute(image, mask)
#   - drawKeypoints(image, keypoints, output, color, flags)

# -------------------------------------------------------------
# üî∏ 2. HOG (Histogram of Oriented Gradients)

# ‚û§ Overview:
#   - Describes local object appearance by gradient orientation distribution.
#   - Widely used in **human detection** and **object classification**.

# ‚û§ Steps:
#   1Ô∏è‚É£ Compute gradients (Gx, Gy) for each pixel.
#   2Ô∏è‚É£ Calculate gradient magnitude and orientation.
#   3Ô∏è‚É£ Divide the image into cells (e.g., 8√ó8 pixels).
#   4Ô∏è‚É£ For each cell, build histogram of gradient directions (bins = 0¬∞‚Äì180¬∞).
#   5Ô∏è‚É£ Normalize over blocks for lighting invariance.

# ‚û§ Mathematical Formulas:
#   Gx = ‚àÇI/‚àÇx,   Gy = ‚àÇI/‚àÇy
#   Magnitude = ‚àö(Gx¬≤ + Gy¬≤)
#   Orientation = tan‚Åª¬π(Gy / Gx)

# ‚û§ OpenCV Function:
#   - cv2.HOGDescriptor() ‚Üí creates a HOG descriptor object.
#   - .compute(image) ‚Üí returns HOG feature vector.

# -------------------------------------------------------------
# üß© CODE EXPLANATION:

# 1Ô∏è‚É£ Load grayscale image (real or synthetic).
# 2Ô∏è‚É£ Apply SURF:
#     - Detect keypoints (features of interest).
#     - Compute 64D or 128D descriptors.
#     - Draw detected points in green.
# 3Ô∏è‚É£ Apply HOG:
#     - Compute gradient-based features.
#     - Returns a long vector of features for classification tasks.
# 4Ô∏è‚É£ Display outputs and descriptor details.

# -------------------------------------------------------------
# üìò OUTPUT DESCRIPTION:

# ‚û§ SURF Keypoints:
#     - Displayed as green circles with size and orientation.
#     - len(keypoints): Number of features detected.
#     - descriptors.shape: (number of keypoints, 64 or 128)

# ‚û§ HOG Descriptor:
#     - Printed as a long feature vector of shape (N, 1)
#     - Represents local gradient patterns.

# -------------------------------------------------------------
# üí° APPLICATIONS:

# - Object and face recognition
# - Image retrieval and matching
# - Human detection (especially HOG)
# - Robotics and navigation
# - Computer vision pipelines for scene analysis

# -------------------------------------------------------------
# üó£Ô∏è VIVA QUESTIONS:

# Q1. What does SURF stand for?
#     ‚Üí Speeded-Up Robust Features.

# Q2. What is the main advantage of SURF over SIFT?
#     ‚Üí SURF uses integral images and approximations to compute faster.

# Q3. What is the Hessian Matrix used for in SURF?
#     ‚Üí To find blob-like structures (keypoints) by detecting curvature changes.

# Q4. What does HOG stand for?
#     ‚Üí Histogram of Oriented Gradients.

# Q5. What are the main advantages of HOG?
#     ‚Üí Simple, effective, and robust for object detection (especially pedestrians).

# Q6. What is the difference between SURF and HOG?
#     ‚Üí SURF detects keypoints and descriptors; HOG describes the entire image region.

# Q7. Can SURF and HOG be used together?
#     ‚Üí Yes, combining local (SURF) and global (HOG) features improves recognition accuracy.

# -------------------------------------------------------------
# ‚úÖ RESULT:
# Successfully detected and described features using SURF and HOG descriptors.
# SURF extracted local keypoints and descriptors, while HOG provided gradient-based
# global features representing object appearance. SURF is not included in the default opencv-python package.
#SURF a patented algorithm, so OpenCV moved it under the contrib module (cv2.xfeatures2d).
#Your HOG feature vector contains 51,683,940 elements (‚âà 51 million)
#Each element represents part of the gradient histogram information extracted from your image.
#In simple terms, it‚Äôs a very long 1D vector ‚Äî the numerical description of your image‚Äôs texture and structure.