<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Documentation Statistics</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: sans-serif;
      background: #f5f5f5;
    }

    h1 {
      text-align: center;
      margin: 20px 0;
    }

    .nav {
      text-align: center;
      margin-bottom: 30px;
    }

    .nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #5A88B8;
    }

    .nav a:hover {
      text-decoration: underline;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-card .value {
      font-size: 2.5em;
      font-weight: bold;
      color: #5A88B8;
      margin: 10px 0;
    }

    .stat-card .label {
      font-size: 1.1em;
      color: #666;
    }

    .section {
      background: white;
      padding: 25px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .section h2 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #5A88B8;
      padding-bottom: 10px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .table th {
      background: #5A88B8;
      color: white;
      padding: 12px;
      text-align: left;
    }

    .table td {
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
    }

    .table tr:hover {
      background: #f9f9f9;
    }

    .table a {
      color: #5A88B8;
      text-decoration: none;
    }

    .table a:hover {
      text-decoration: underline;
    }

    .cluster-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }

    .cluster-item {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #5A88B8;
      flex: 1;
      min-width: 200px;
    }

    .cluster-item .cluster-name {
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }

    .cluster-item .cluster-count {
      font-size: 1.5em;
      color: #5A88B8;
    }

    .no-data {
      text-align: center;
      color: #999;
      font-style: italic;
      padding: 20px;
    }
  </style>
  <script src="../js/nodes.js"></script>
  <script src="../js/links.js"></script>
</head>
<body>
  <h1>Documentation Statistics</h1>
  <p class="nav">
    <a href="index.html">Sphinx Visualized</a>
  </p>

  <div class="container">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="value" id="total-pages">-</div>
        <div class="label">Total Pages</div>
      </div>
      <div class="stat-card">
        <div class="value" id="total-links">-</div>
        <div class="label">Total Links</div>
      </div>
      <div class="stat-card">
        <div class="value" id="total-references">-</div>
        <div class="label">Total References</div>
      </div>
      <div class="stat-card">
        <div class="value" id="total-intersphinx">-</div>
        <div class="label">Intersphinx Links</div>
      </div>
    </div>

    <div class="section" id="clusters-section">
      <h2>Cluster Distribution</h2>
      <div class="cluster-stats" id="cluster-stats"></div>
    </div>

    <div class="section" id="intersphinx-section">
      <h2>Intersphinx Links by Project</h2>
      <table class="table">
        <thead>
          <tr>
            <th>Project</th>
            <th>External Pages</th>
            <th>Total References</th>
          </tr>
        </thead>
        <tbody id="intersphinx-stats"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>Most Referenced Pages</h2>
      <table class="table">
        <thead>
          <tr>
            <th>Page</th>
            <th>Inbound References</th>
          </tr>
        </thead>
        <tbody id="most-referenced"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>Pages with Most Outbound Links</h2>
      <table class="table">
        <thead>
          <tr>
            <th>Page</th>
            <th>Outbound Links</th>
          </tr>
        </thead>
        <tbody id="most-outbound"></tbody>
      </table>
    </div>

    <div class="section" id="isolated-section">
      <h2>Isolated Pages</h2>
      <p>Pages with no incoming or outgoing references:</p>
      <table class="table">
        <thead>
          <tr>
            <th>Page</th>
          </tr>
        </thead>
        <tbody id="isolated-pages"></tbody>
      </table>
    </div>
  </div>

  <script>
    // Calculate statistics
    const nodes = nodes_data || [];
    const links = links_data || [];

    // Basic statistics
    const totalPages = nodes.length;
    const totalLinks = links.length;
    const totalReferences = links.reduce((sum, link) => sum + (link.reference_count || 1), 0);

    // Count intersphinx nodes
    const intersphinxNodes = nodes.filter(node => node.is_intersphinx);
    const totalIntersphinx = intersphinxNodes.length;

    document.getElementById('total-pages').textContent = totalPages;
    document.getElementById('total-links').textContent = totalLinks;
    document.getElementById('total-references').textContent = totalReferences;
    document.getElementById('total-intersphinx').textContent = totalIntersphinx;

    // Calculate inbound and outbound references for each page
    const pageStats = nodes.map(node => ({
      id: node.id,
      label: node.label,
      path: node.path,
      cluster: node.cluster,
      inbound: 0,
      outbound: 0
    }));

    links.forEach(link => {
      if (pageStats[link.target]) {
        pageStats[link.target].inbound += (link.reference_count || 1);
      }
      if (pageStats[link.source]) {
        pageStats[link.source].outbound += (link.reference_count || 1);
      }
    });

    // Cluster distribution
    const clusterCounts = {};
    let hasUnclustered = false;

    nodes.forEach(node => {
      if (node.cluster) {
        clusterCounts[node.cluster] = (clusterCounts[node.cluster] || 0) + 1;
      } else {
        hasUnclustered = true;
        clusterCounts['Unclustered'] = (clusterCounts['Unclustered'] || 0) + 1;
      }
    });

    const clusterStatsDiv = document.getElementById('cluster-stats');
    if (Object.keys(clusterCounts).length > 0) {
      Object.entries(clusterCounts).sort((a, b) => b[1] - a[1]).forEach(([cluster, count]) => {
        const div = document.createElement('div');
        div.className = 'cluster-item';
        div.innerHTML = `
          <div class="cluster-name">${cluster}</div>
          <div class="cluster-count">${count} pages</div>
        `;
        clusterStatsDiv.appendChild(div);
      });
    } else {
      clusterStatsDiv.innerHTML = '<div class="no-data">No clusters configured</div>';
    }

    // Intersphinx statistics by project
    const intersphinxByProject = {};

    // Count pages by project
    intersphinxNodes.forEach(node => {
      // Extract project name from cluster (format: "project_name (external)")
      let projectName = node.cluster;
      if (projectName && projectName.endsWith(' (external)')) {
        projectName = projectName.slice(0, -11); // Remove " (external)" suffix
      }

      if (!intersphinxByProject[projectName]) {
        intersphinxByProject[projectName] = {
          pageCount: 0,
          referenceCount: 0
        };
      }
      intersphinxByProject[projectName].pageCount++;
    });

    // Count references to intersphinx pages
    links.forEach(link => {
      const targetNode = nodes[link.target];
      if (targetNode && targetNode.is_intersphinx) {
        let projectName = targetNode.cluster;
        if (projectName && projectName.endsWith(' (external)')) {
          projectName = projectName.slice(0, -11);
        }
        if (intersphinxByProject[projectName]) {
          intersphinxByProject[projectName].referenceCount += (link.reference_count || 1);
        }
      }
    });

    const intersphinxStatsTbody = document.getElementById('intersphinx-stats');
    const intersphinxSection = document.getElementById('intersphinx-section');

    if (Object.keys(intersphinxByProject).length > 0) {
      Object.entries(intersphinxByProject)
        .sort((a, b) => b[1].referenceCount - a[1].referenceCount)
        .forEach(([project, stats]) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${project}</td>
            <td>${stats.pageCount}</td>
            <td>${stats.referenceCount}</td>
          `;
          intersphinxStatsTbody.appendChild(row);
        });
    } else {
      intersphinxSection.style.display = 'none';
    }

    // Most referenced pages (top 10)
    const mostReferenced = [...pageStats]
      .filter(page => page.inbound > 0)
      .sort((a, b) => b.inbound - a.inbound)
      .slice(0, 10);

    const mostReferencedTbody = document.getElementById('most-referenced');
    if (mostReferenced.length > 0) {
      mostReferenced.forEach(page => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="${page.path}" target="_blank">${page.label}</a></td>
          <td>${page.inbound}</td>
        `;
        mostReferencedTbody.appendChild(row);
      });
    } else {
      mostReferencedTbody.innerHTML = '<tr><td colspan="2" class="no-data">No referenced pages</td></tr>';
    }

    // Pages with most outbound links (top 10)
    const mostOutbound = [...pageStats]
      .filter(page => page.outbound > 0)
      .sort((a, b) => b.outbound - a.outbound)
      .slice(0, 10);

    const mostOutboundTbody = document.getElementById('most-outbound');
    if (mostOutbound.length > 0) {
      mostOutbound.forEach(page => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="${page.path}" target="_blank">${page.label}</a></td>
          <td>${page.outbound}</td>
        `;
        mostOutboundTbody.appendChild(row);
      });
    } else {
      mostOutboundTbody.innerHTML = '<tr><td colspan="2" class="no-data">No pages with outbound links</td></tr>';
    }

    // Isolated pages (no incoming or outgoing references)
    const isolatedPages = pageStats.filter(page => page.inbound === 0 && page.outbound === 0);

    const isolatedPagesTbody = document.getElementById('isolated-pages');
    const isolatedSection = document.getElementById('isolated-section');

    if (isolatedPages.length > 0) {
      isolatedPages.forEach(page => {
        const row = document.createElement('tr');
        row.innerHTML = `<td><a href="${page.path}" target="_blank">${page.label}</a></td>`;
        isolatedPagesTbody.appendChild(row);
      });
    } else {
      isolatedSection.style.display = 'none';
    }
  </script>
</body>
</html>
