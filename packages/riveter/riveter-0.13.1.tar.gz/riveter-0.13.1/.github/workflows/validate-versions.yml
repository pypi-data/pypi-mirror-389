name: Validate Version Consistency

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  validate-versions:
    name: Basic Version Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Validate version format
        run: |
          echo "üîç Validating version format in pyproject.toml..."

          # Extract version using grep (more reliable than parsing TOML)
          version=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $version"

          # Validate semantic versioning format
          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $version"
            echo "Version must follow semantic versioning (x.y.z)"
            exit 1
          fi

          echo "‚úÖ Version format is valid: $version"

  test-version-sync-script:
    name: Test Version Synchronization Script
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tomli

      - name: Test sync script help
        run: |
          python scripts/sync_versions.py --help

      - name: Test sync script validation (release mode)
        run: |
          # Test in release mode to avoid external dependencies
          python scripts/sync_versions.py --validate --release-mode --debug || true

  validate-cli-version-import:
    name: Validate CLI Version Import
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install package in development mode
        run: |
          python -m pip install --upgrade pip
          pip install tomli
          pip install -e .
        working-directory: .

      - name: Test CLI version command
        run: |
          riveter --version

      - name: Verify version matches pyproject.toml
        run: |
          # Get version from installed package
          PACKAGE_VERSION=$(python -c "import riveter; print(riveter.__version__)" 2>/dev/null || python -c "from importlib.metadata import version; print(version('riveter'))")
          CLI_VERSION=$(riveter --version | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+')

          echo "Package version: $PACKAGE_VERSION"
          echo "CLI version: $CLI_VERSION"

          if [ "$PACKAGE_VERSION" != "$CLI_VERSION" ]; then
            echo "‚ùå Version mismatch between package ($PACKAGE_VERSION) and CLI ($CLI_VERSION)"
            exit 1
          else
            echo "‚úÖ Versions match: $PACKAGE_VERSION"
          fi
